<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HOUSETECH Ops</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --primary:#3B82F6; --primary-700:#2563EB; --secondary:#10B981; --danger:#EF4444;
      --bg:#F3F4F6; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --border:#E5E7EB;
      --tab-active:#FFFFFF; --tab-inactive:#F3F4F6;
    }
    .dark-mode{
      --bg:#0F172A; --card:#111827; --text:#E5E7EB; --muted:#A1A1AA; --border:#1F2937;
      --tab-active:#111827; --tab-inactive:#1F2937;
    }
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg);min-height:100vh}
    .card{background:var(--card);border:1px solid var(--border);border-radius:1rem;padding:1.25rem}
    .btn{border-radius:.75rem;padding:.6rem 1.1rem;font-weight:600;display:inline-flex;gap:.5rem;align-items:center}
    .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-700)}
    .btn-outline{border:1px solid var(--border);background:transparent}
    input,select{width:100%;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:.75rem;padding:.7rem .9rem}
    .tabs-wrap{border-radius:1rem;overflow:hidden}
    .tab-btn{padding:.5rem 1rem;border:1px solid var(--border)}
    .tab-active{background:var(--tab-active)} .tab-inactive{background:var(--tab-inactive);color:var(--muted)}
    .badge{padding:.25rem .6rem;border-radius:999px;font-size:.75rem;font-weight:700}
  </style>
</head>
<body class="">
<div class="max-w-6xl mx-auto py-6 px-4">

  <header class="flex items-start justify-between mb-6">
    <div>
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold"><span class="text-blue-600">HOUSETECH</span> <span>Ops</span></h1>
        <button id="themeToggle" class="btn btn-outline p-2 !px-3" title="Preklopi temo"><i class="fas fa-moon"></i></button>
      </div>
      <p class="text-sm" style="color:var(--muted)">Prijava z Google</p>
    </div>
    <div><span id="statusBadge" class="badge bg-green-100 text-green-700 hidden"><i class="fas fa-check mr-1"></i>Prijavljen</span></div>
  </header>

  <!-- PRIJAVA -->
  <div id="authCard" class="card mb-6">
    <h2 class="text-lg font-semibold mb-3"><i class="fas fa-right-to-bracket mr-2 text-blue-500"></i>Prijava</h2>
    <p class="text-sm mb-4" style="color:var(--muted)">Prijavi se z Google. Strežnik preveri ID token in izda JWT (whitelist).</p>
    <div class="flex items-center gap-3">
      <div id="g_id_signin"></div>
      <button id="signOut" class="btn btn-outline hidden"><i class="fas fa-right-from-bracket"></i> Odjava</button>
    </div>
  </div>

  <!-- TABS -->
  <nav id="tabsNav" class="mb-6 hidden">
    <div class="tabs-wrap inline-flex">
      <button data-tab="time" class="tab-btn tab-active"><i class="far fa-clock mr-2"></i>Evidenca ur</button>
      <button data-tab="jobs" class="tab-btn tab-inactive"><i class="far fa-list-alt mr-2"></i>Dnevnik del</button>
      <button id="tabBtnReports" data-tab="reports" class="tab-btn tab-inactive"><i class="far fa-chart-bar mr-2"></i>Poročila</button>
      <button id="tabBtnAdmin" data-tab="admin" class="tab-btn tab-inactive"><i class="fas fa-user-shield mr-2"></i>Admin</button>
    </div>
  </nav>

  <!-- TIME -->
  <section id="tab-time">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div id="presencePanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-user-clock mr-2 text-blue-500"></i>Registracija prisotnosti</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Projekt</label>
            <select id="currentProject"><option value="">— izberi —</option></select>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="clockIn"  class="btn text-white" style="background:#10B981"><i class="fas fa-sign-in-alt"></i> Prihod</button>
            <button id="clockOut" class="btn text-white" style="background:#EF4444"><i class="fas fa-sign-out-alt"></i> Odhod</button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="breakStart" class="btn btn-outline"><i class="fas fa-utensils"></i> Začetek malice</button>
            <button id="breakEnd"   class="btn btn-outline"><i class="fas fa-utensils"></i> Konec malice</button>
          </div>
        </div>
      </div>

      <div id="todayPanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="far fa-calendar-check mr-2 text-blue-500"></i>Današnje registracije</h2>
        <ul id="todayEntries" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <!-- JOBS -->
  <section id="tab-jobs" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div id="jobsProjectsCard" class="card hidden"></div>

      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-tasks mr-2 text-blue-500"></i>Dnevnik del</h2>
        <div class="space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label class="block text-sm font-medium mb-1">Projekt</label><select id="logProject"></select></div>
            <div><label class="block text-sm font-medium mb-1">Aktivnost</label><input id="logActivity" placeholder="npr. Montaža stikal..." /></div>
            <div><label class="block text-sm font-medium mb-1">Ure</label><input id="logHours" type="number" step="0.25" placeholder="npr. 3.5" /></div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Materiali</label>
            <div id="materialsList" class="space-y-2"></div>
            <datalist id="materialsCatalog"></datalist>
            <button id="addMaterialRow" type="button" class="btn btn-outline mt-2"><i class="fas fa-plus"></i> Dodaj material</button>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Fotografije (neobvezno)</label>
            <input id="logPhotos" type="file" accept="image/*" multiple class="w-full"/>
            <div id="logPhotosPreview" class="flex gap-2 flex-wrap mt-2"></div>
          </div>

          <div class="flex justify-end"><button id="addLog" class="btn btn-primary"><i class="fas fa-save mr-1"></i> Shrani vnos</button></div>
        </div>

        <hr class="my-4" style="border-color:var(--border)" />
        <h3 class="text-md font-semibold mb-2"><i class="fas fa-history mr-2 text-blue-500"></i>Zgodovina vnosov</h3>
        <div id="logList" class="space-y-3 text-sm max-h-96 overflow-y-auto pr-2"></div>
      </div>
    </div>
  </section>

 <!-- REPORTS -->
<section id="tab-reports" class="hidden">
  <div class="card">
    <h2 class="text-lg font-semibold mb-3"><i class="fas fa-file-export mr-2 text-blue-500"></i>Poročila</h2>

    <!-- Filtri -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-3">
      <div>
        <label class="block text-sm font-medium mb-1">Od</label>
        <input type="date" id="repFrom">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Do</label>
        <input type="date" id="repTo">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Projekt</label>
        <select id="repProject"><option value="">Vsi</option></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Zaposleni</label>
        <select id="repEmployee"><option value="">Vsi</option></select>
      </div>
      <div class="flex items-end gap-2">
        <button id="repRefresh" class="btn btn-primary w-full"><i class="fas fa-rotate"></i> Osveži</button>
      </div>
    </div>

    <!-- KPI povzetki -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      <div class="card kpi">
        <h4 class="font-semibold mb-2"><i class="fas fa-user-clock mr-2 text-blue-500"></i>Prisotnost — ure po projektih</h4>
        <ul id="kpiPresenceProj" class="space-y-1"></ul>
      </div>
      <div class="card kpi">
        <h4 class="font-semibold mb-2"><i class="fas fa-user mr-2 text-blue-500"></i>Prisotnost — ure po zaposlenih</h4>
        <ul id="kpiPresenceEmp" class="space-y-1"></ul>
      </div>
      <div class="card kpi">
        <h4 class="font-semibold mb-2"><i class="fas fa-diagram-project mr-2 text-blue-500"></i>Dnevnik — ure po projektih</h4>
        <ul id="kpiJobsProj" class="space-y-1"></ul>
      </div>
      <div class="card kpi">
        <h4 class="font-semibold mb-2"><i class="fas fa-people-group mr-2 text-blue-500"></i>Dnevnik — ure po zaposlenih</h4>
        <ul id="kpiJobsEmp" class="space-y-1"></ul>
      </div>
    </div>

    <!-- Podrobne tabele -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div>
        <h3 class="font-semibold mb-2">Evidenca prisotnosti (vrstice)</h3>
        <div class="max-h-96 overflow-auto border rounded-lg">
          <table class="w-full border-collapse">
            <thead><tr><th class="border p-2">Datum</th><th class="border p-2">Projekt</th><th class="border p-2">Zaposleni</th><th class="border p-2" style="width:80px">Ure</th></tr></thead>
            <tbody id="tblPresence"></tbody>
          </table>
        </div>
      </div>
      <div>
        <h3 class="font-semibold mb-2">Dnevnik del (vrstice)</h3>
        <div class="max-h-96 overflow-auto border rounded-lg">
          <table class="w-full border-collapse">
            <thead><tr><th class="border p-2">Datum</th><th class="border p-2">Projekt</th><th class="border p-2">Zaposleni</th><th class="border p-2">Aktivnost</th><th class="border p-2" style="width:80px">Ure</th></tr></thead>
            <tbody id="tblJobs"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Izvoz -->
    <div class="flex flex-wrap gap-2 mt-4">
      <button id="exportExcel" class="btn btn-primary"><i class="fas fa-file-excel mr-1"></i> Excel (.xlsx)</button>
      <button id="exportPdf"   class="btn btn-outline"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
    </div>
  </div>

  <!-- ===== NOVO: Poročilo dnevnikov (po projektih) ===== -->
  <div class="card mt-6">
    <div class="flex items-center justify-between gap-3 mb-3">
      <h2 class="text-lg font-semibold"><i class="fas fa-book mr-2 text-blue-500"></i>Poročilo dnevnikov</h2>
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-500">Skupine:</label>
        <select id="drPeriod" class="text-sm">
          <option value="day">po dnevih</option>
          <option value="month">po mesecih</option>
        </select>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- leva: seznam projektov -->
      <div>
        <h3 class="font-semibold mb-2">Projekti</h3>
        <ul id="drProjects" class="space-y-2 max-h-96 overflow-auto border rounded-lg p-2"></ul>
      </div>

      <!-- desna: podrobnosti -->
      <div class="lg:col-span-2">
        <div id="drEmpty" class="text-gray-500 text-sm">Izberi projekt na levi.</div>

        <div id="drDetails" class="hidden space-y-4">
          <div>
            <h3 id="drProjectTitle" class="font-semibold"></h3>
            <div id="drProjectAddress" class="text-sm text-gray-500"></div>
          </div>

          <div>
            <h4 class="font-semibold mb-1">Poraba materiala (<span id="drAggLabel">po dnevih</span>)</h4>
            <div class="max-h-80 overflow-auto border rounded-lg">
              <table class="w-full border-collapse">
                <thead>
                  <tr><th class="border p-2">Skupina</th><th class="border p-2">Material</th><th class="border p-2">Količina</th><th class="border p-2">Enota</th></tr>
                </thead>
                <tbody id="drMaterials"></tbody>
              </table>
            </div>
          </div>

          <div>
            <h4 class="font-semibold mb-1">Aktivnosti po dnevih</h4>
            <div id="drActivities" class="space-y-2 max-h-80 overflow-auto"></div>
          </div>

          <div>
            <h4 class="font-semibold mb-1">Slike</h4>
            <div id="drPhotos" class="flex flex-wrap gap-2 border rounded-lg p-2 max-h-60 overflow-auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

  <!-- ADMIN -->
  <section id="tab-admin" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-users-cog mr-2 text-blue-500"></i>Uporabniki</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
          <input id="admUserEmail" placeholder="email@domena.si"/>
          <input id="admUserName" placeholder="Ime in priimek"/>
          <div class="flex flex-wrap gap-2">
            <label class="flex items-center gap-2"><input id="roleOwner" type="checkbox">Owner</label>
            <label class="flex items-center gap-2"><input id="roleCEO" type="checkbox">CEO</label>
            <label class="flex items-center gap-2"><input id="roleManager" type="checkbox">vodja</label>
            <label class="flex items-center gap-2"><input id="roleEmployee" type="checkbox">zaposlen</label>
            <label class="flex items-center gap-2"><input id="roleStudent" type="checkbox">študent</label>
          </div>
          <button id="admAddUser" class="btn btn-primary"><i class="fas fa-user-plus"></i> Shrani</button>
        </div>
        <ul id="admUserList" class="space-y-2 text-sm"></ul>
      </div>

      <div class="card">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-sitemap mr-2 text-blue-500"></i>Projekti</h2>
        <div class="grid grid-cols-1 gap-2 mb-3">
          <input id="admProjectName" placeholder="Naziv projekta"/>
          <input id="admProjectAddress" placeholder="Naslov objekta (opcijsko)"/>
          <button id="admAddProject" class="btn btn-primary"><i class="fas fa-plus"></i> Dodaj</button>
        </div>
        <ul id="admProjectList" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <footer class="mt-10 text-xs text-center" style="color:var(--muted)">© 2025 HOUSETECH — final</footer>
</div>

<script>
/* ===== Tema ===== */
const themeToggle=document.getElementById('themeToggle');
const t=localStorage.getItem('theme')||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
if(t==='dark'){document.body.classList.add('dark-mode');themeToggle.innerHTML='<i class="fas fa-sun"></i>'}
themeToggle.onclick=()=>{document.body.classList.toggle('dark-mode');const dark=document.body.classList.contains('dark-mode');localStorage.setItem('theme',dark?'dark':'light');themeToggle.innerHTML=dark?'<i class="fas fa-sun"></i>':'<i class="fas fa-moon"></i>'};

/* ===== Konfiguracija ===== */
const GOOGLE_CLIENT_ID="149127907023-ip3jqct2vmqc4tm4jm4bfoogd1pqfpsv.apps.googleusercontent.com";
const API_BASE="";

let accessToken=localStorage.getItem("jwt")||null;
let me=localStorage.getItem("me")?JSON.parse(localStorage.getItem("me")):null;

let usersDir={}, projects=[], materialsCatalog={}, materials=[];

const isOwnerOrCeo=()=> (me?.roles||[]).some(r=>r==='Owner'||r==='CEO');

const TYPE_META={
  "in":          {label:"Prihod",        cls:"bg-green-100 text-green-700", icon:"fa-sign-in-alt"},
  "out":         {label:"Odhod",         cls:"bg-red-100 text-red-700",     icon:"fa-sign-out-alt"},
  "break-start": {label:"Začetek malice",cls:"bg-amber-100 text-amber-700", icon:"fa-utensils"},
  "break-end":   {label:"Konec malice",  cls:"bg-amber-100 text-amber-700", icon:"fa-utensils"}
};

/* ===== Tabs ===== */
function selectTab(name){
  ["time","jobs","reports","admin"].forEach(t=>{
    document.getElementById("tab-"+t).classList.add("hidden");
    const btn=document.querySelector(`[data-tab="${t}"]`);
    if(btn){btn.classList.remove('tab-active');btn.classList.add('tab-inactive')}
  });
  document.getElementById("tab-"+name).classList.remove("hidden");
  const sel=document.querySelector(`[data-tab="${name}"]`); if(sel){sel.classList.add('tab-active');sel.classList.remove('tab-inactive')}
  if(name==="jobs"){renderMaterials();renderMaterialsCatalogDatalist();loadJobLogs()}
  if(name==="admin"){adminReload()}
  if(name==="reports"){prepareReportFilters();renderReports()}
}
document.querySelectorAll(".tab-btn").forEach(b=>b.addEventListener("click",()=>selectTab(b.getAttribute("data-tab"))));

/* ===== Google Sign-In ===== */
async function handleGoogleCredentialResponse(resp){
  try{
    const r=await fetch(API_BASE+"/auth/google/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:resp.credential})});
    if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||"Neuspešna verifikacija")}
    const data=await r.json(); accessToken=data.access_token; me=data.user;
    localStorage.setItem("jwt",accessToken); localStorage.setItem("me",JSON.stringify(me));
    await loadBootstrapData(); showAppAfterLogin(); selectTab("time");
  }catch(e){ alert("Prijava ni uspela: "+e.message); }
}
function initGoogle(){
  if(!(window.google&&google.accounts&&google.accounts.id)) return false;
  try{ google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID,callback:handleGoogleCredentialResponse});
       const m=document.getElementById('g_id_signin'); if(m && m.childElementCount===0){ google.accounts.id.renderButton(m,{theme:"outline",size:"large"}); }
       return true;
  }catch{ return false; }
}
window.addEventListener('load', ()=>{
  let tries=0; const t=setInterval(()=>{ if(initGoogle()||tries++>40) clearInterval(t); },100);
  if(accessToken && me){ loadBootstrapData().then(()=>{ showAppAfterLogin(); selectTab('time'); }); } else { showLoggedOut(); }
});

/* ===== UI helperji ===== */
function showAppAfterLogin(){
  document.getElementById('g_id_signin')?.classList.add('hidden');
  document.getElementById('signOut')?.classList.remove('hidden');
  document.getElementById('statusBadge')?.classList.remove('hidden');
  document.getElementById('tabsNav')?.classList.remove('hidden');
  document.getElementById('presencePanel')?.classList.remove('hidden');
  document.getElementById('todayPanel')?.classList.remove('hidden');
  renderTodayPresence();
}
function showLoggedOut(){
  document.getElementById('g_id_signin')?.classList.remove('hidden');
  document.getElementById('signOut')?.classList.add('hidden');
  document.getElementById('statusBadge')?.classList.add('hidden');
  document.getElementById('tabsNav')?.classList.add('hidden');
  document.getElementById('presencePanel')?.classList.add('hidden');
  document.getElementById('todayPanel')?.classList.add('hidden');
}
document.getElementById('signOut')?.addEventListener('click',()=>{localStorage.clear();accessToken=null;me=null;showLoggedOut()});

/* ===== Backend bootstrap ===== */
function mapMaterials(list){ const out={}; (list||[]).forEach(m=>{ if(m?.name) out[m.name]={id:m.id,uom:m.uom||"kos"} }); return out; }
async function loadBootstrapData(){
  const u=await fetch(API_BASE+"/users",{headers:{Authorization:"Bearer "+accessToken}}); usersDir=u.ok?await u.json():{};
  const p=await fetch(API_BASE+"/projects",{headers:{Authorization:"Bearer "+accessToken}}); projects=p.ok?await p.json():[];
  const m=await fetch(API_BASE+"/materials",{headers:{Authorization:"Bearer "+accessToken}}); materialsCatalog=m.ok?mapMaterials(await m.json()):{};
  renderProjects(); renderUsersAdmin(); renderProjectsAdmin(); renderMaterialsCatalogDatalist(); renderEmployeesFilter();
}

/* ===== Projekti ===== */
function renderProjects(){
  const cp=document.getElementById("currentProject"), lp=document.getElementById("logProject");
  cp.innerHTML='<option value="">— izberi —</option>'+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
  lp.innerHTML=projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
  const rp=document.getElementById('repProject'); if(rp) rp.innerHTML='<option value="">Vsi</option>'+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
}
function renderEmployeesFilter(){
  const re=document.getElementById('repEmployee'); if(!re) return;
  const emails=Object.keys(usersDir);
  re.innerHTML='<option value="">Vsi</option>'+emails.map(e=>({email:e,name:usersDir[e]?.name||e})).sort((a,b)=>a.name.localeCompare(b.name)).map(u=>`<option value="${u.email}">${u.name}</option>`).join('');
}

/* ===== Prisotnost – klici API ===== */
const fmt=ts=>new Date(ts).toLocaleTimeString('sl-SI',{hour:'2-digit',minute:'2-digit'});
const dmy=ts=>new Date(ts).toLocaleDateString('sl-SI');
const projectName=id=> (projects.find(p=>p.id===id)?.name)||'';

async function postPresence(type){
  const projectId=document.getElementById('currentProject').value||null;
  const r=await fetch(API_BASE+'/presence',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({type,projectId})});
  if(!r.ok){const e=await r.json().catch(()=>({}));alert(e.error||'Napaka pri shranjevanju');return}
  renderTodayPresence();
}
["clockIn","clockOut","breakStart","breakEnd"].forEach(id=>{
  const btn=document.getElementById(id); if(!btn) return;
  const map={clockIn:'in',clockOut:'out',breakStart:'break-start',breakEnd:'break-end'};
  btn.addEventListener('click',()=>postPresence(map[id]));
});

async function loadPresenceRange(from,to,proj,emp){
  const qs=new URLSearchParams();
  if(from) qs.set('from',from.getTime()); if(to) qs.set('to',to.getTime());
  if(proj) qs.set('projectId',proj); if(emp) qs.set('email',emp);
  const r=await fetch(API_BASE+'/presence?'+qs.toString(),{headers:{Authorization:'Bearer '+accessToken}});
  return r.ok?await r.json():[];
}
async function deletePresence(id){
  if(!confirm('Odstranim vnos?')) return;
  const r=await fetch(API_BASE+'/presence/'+id,{method:'DELETE',headers:{Authorization:'Bearer '+accessToken}});
  if(!r.ok){const e=await r.json().catch(()=>({}));alert(e.error||'Napaka');return}
  renderTodayPresence();
}
async function renderTodayPresence(){
  const ul=document.getElementById('todayEntries');
  const today=new Date(); const start=new Date(today.getFullYear(),today.getMonth(),today.getDate()); const end=new Date(start.getTime()+86400000-1);
  const entries=await loadPresenceRange(start,end);
  if(!entries.length){ul.innerHTML='<li class="text-center py-4 text-gray-500"><i class="far fa-clock text-2xl mb-2"></i><p>Ni vnosov za danes.</p></li>';return}
  ul.innerHTML=entries.sort((a,b)=>a.ts-b.ts).map(e=>{
    const M=TYPE_META[e.type]||{label:e.type,cls:"",icon:"fa-clock"};
    return `<li class="p-3 border rounded-xl flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="badge ${M.cls}"><i class="fa ${M.icon} mr-1"></i>${M.label}</span>
        <div><div class="font-medium">${fmt(e.ts)}</div>
        <div class="text-xs text-gray-500">${e.employee} • ${projectName(e.projectId)||"Brez projekta"}</div></div>
      </div>
      <button class="btn btn-outline !py-1 !px-2 text-xs" onclick="deletePresence('${e.id}')"><i class="fas fa-trash"></i></button>
    </li>`;
  }).join('');
}

/* ===== Admin ===== */
function renderUsersAdmin(){
  const ul=document.getElementById('admUserList'); if(!ul) return;
  const entries=Object.entries(usersDir).sort((a,b)=>(a[1].name||a[0]).localeCompare(b[1].name||b[0]));
  ul.innerHTML=entries.map(([email,u])=>`
    <li class="p-3 border rounded-xl flex items-center justify-between">
      <div class="min-w-0">
        <div class="font-medium truncate"><i class="fas fa-user mr-2 text-blue-500"></i>${u.name||email} <span class="text-gray-400">•</span> <span class="text-gray-500">${email}</span></div>
        <div class="text-xs text-gray-500">Vloge: ${(u.roles||[]).join(', ')||'—'}</div>
      </div>
      <div class="flex gap-2">
        <button class="btn btn-outline text-xs" onclick="admEditUser('${email}')"><i class="fas fa-pen"></i> Uredi</button>
        <button class="btn btn-outline text-xs" onclick="admDelUser('${email}')"><i class="fas fa-trash"></i> Izbriši</button>
      </div>
    </li>`).join('') || `<li class="text-center text-gray-500">Ni uporabnikov.</li>`;
}
function admEditUser(email){
  const u=usersDir[email]||{};
  document.getElementById('admUserEmail').value=email;
  document.getElementById('admUserName').value=u.name||'';
  document.getElementById('roleOwner').checked=(u.roles||[]).includes('Owner');
  document.getElementById('roleCEO').checked=(u.roles||[]).includes('CEO');
  document.getElementById('roleManager').checked=(u.roles||[]).includes('vodja');
  document.getElementById('roleEmployee').checked=(u.roles||[]).includes('zaposlen');
  document.getElementById('roleStudent').checked=(u.roles||[]).includes('študent');
}
document.getElementById('admAddUser')?.addEventListener('click',async()=>{
  if(!isOwnerOrCeo()) return alert('Samo Owner/CEO');
  const email=document.getElementById('admUserEmail').value.trim().toLowerCase();
  const name=document.getElementById('admUserName').value.trim(); if(!email||!name) return alert('Vnesi email in ime');
  const roles=[]; ['Owner','CEO','vodja','zaposlen','študent'].forEach((r,i)=>{
    const id=['roleOwner','roleCEO','roleManager','roleEmployee','roleStudent'][i]; if(document.getElementById(id).checked) roles.push(r);
  });
  await fetch(API_BASE+'/users',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({email,name})});
  await fetch(API_BASE+'/users/'+encodeURIComponent(email),{method:'PATCH',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({name,roles})});
  await adminReload();
});
async function admDelUser(email){
  if(!isOwnerOrCeo()) return alert('Samo Owner/CEO');
  if(!confirm('Res izbrišem uporabnika '+email+'?')) return;
  const r=await fetch(API_BASE+'/users/'+encodeURIComponent(email),{method:'DELETE',headers:{Authorization:'Bearer '+accessToken}}); 
  if(r.status===403) return alert('Uporabnika z vlogo Owner ni mogoče izbrisati.');
  await adminReload();
}
function renderProjectsAdmin(){
  const ul=document.getElementById('admProjectList'); if(!ul) return;
  ul.innerHTML=(projects||[]).map(p=>`
    <li class="p-3 border rounded-xl flex items-center justify-between">
      <div class="min-w-0">
        <div class="font-medium truncate"><i class="fas fa-folder text-yellow-500 mr-2"></i>${p.name}</div>
        ${p.address?`<div class="text-xs text-gray-500">${p.address}</div>`:''}
      </div>
      <button class="btn btn-outline text-xs" onclick="admDelProject('${p.id}')"><i class="fas fa-trash"></i> Izbriši</button>
    </li>`).join('') || `<li class="text-center text-gray-500">Ni projektov.</li>`;
}
document.getElementById('admAddProject')?.addEventListener('click',async()=>{
  if(!isOwnerOrCeo()) return alert('Samo Owner/CEO');
  const name=document.getElementById('admProjectName').value.trim();
  const address=document.getElementById('admProjectAddress').value.trim();
  if(!name) return;
  const r=await fetch(API_BASE+'/projects',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({name,address})});
  if(!r.ok) return alert('Napaka pri dodajanju projekta');
  document.getElementById('admProjectName').value=''; document.getElementById('admProjectAddress').value='';
  await adminReload();
});
async function admDelProject(id){
  if(!confirm('Izbrišem projekt?')) return;
  await fetch(API_BASE+'/projects/'+encodeURIComponent(id),{method:'DELETE',headers:{Authorization:'Bearer '+accessToken}});
  await adminReload();
}
async function adminReload(){
  const u=await fetch(API_BASE+'/users',{headers:{Authorization:'Bearer '+accessToken}}); if(u.ok) usersDir=await u.json();
  const p=await fetch(API_BASE+'/projects',{headers:{Authorization:'Bearer '+accessToken}}); if(p.ok) projects=await p.json();
  const m=await fetch(API_BASE+'/materials',{headers:{Authorization:'Bearer '+accessToken}}); if(m.ok){ materialsCatalog=mapMaterials(await m.json()); }
  renderUsersAdmin(); renderProjectsAdmin(); renderProjects(); renderMaterialsCatalogDatalist(); renderEmployeesFilter();
}

/* ===== Materiali ===== */
function renderMaterialsCatalogDatalist(){
  const dl=document.getElementById('materialsCatalog'); if(!dl) return;
  const entries=Object.entries(materialsCatalog).sort((a,b)=>a[0].localeCompare(b[0]));
  dl.innerHTML=entries.map(([name,info])=>`<option value="${name}" data-uom="${info.uom||'kos'}"></option>`).join('');
}
function renderMaterials(){
  const wrap=document.getElementById('materialsList'); if(!wrap) return;
  if(materials.length===0) materials.push({name:'',qty:'',uom:'kos'});
  wrap.innerHTML=materials.map((m,idx)=>`
    <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
      <input list="materialsCatalog" class="md:col-span-6" placeholder="Material (npr. NYM-J 3x1,5)" value="${m.name||''}" oninput="onMatNameInput(${idx}, this.value)"/>
      <input type="number" step="0.01" class="md:col-span-3" placeholder="Količina" value="${m.qty||''}" oninput="materials[${idx}].qty=this.value"/>
      <select class="md:col-span-2" onchange="materials[${idx}].uom=this.value">
        <option value="kos" ${m.uom==='kos'?'selected':''}>kos</option>
        <option value="m"   ${m.uom==='m'?'selected':''}>m</option>
        <option value="kpl" ${m.uom==='kpl'?'selected':''}>kpl</option>
        <option value="h"   ${m.uom==='h'?'selected':''}>h</option>
      </select>
      <button type="button" class="md:col-span-1 btn btn-outline !py-2 !px-3" onclick="materials.splice(${idx},1); renderMaterials();"><i class="fas fa-times"></i></button>
    </div>`).join('');
}
window.onMatNameInput=(idx,val)=>{ materials[idx].name=val; const info=materialsCatalog[val]; if(info && info.uom){ materials[idx].uom=info.uom; renderMaterials(); } };
document.getElementById('addMaterialRow')?.addEventListener('click',()=>{materials.push({name:'',qty:'',uom:'kos'});renderMaterials()});
async function ensureMaterialOnServer(name,uom){
  const key=String(name||"").trim(); if(!key) return null;
  const r=await fetch(API_BASE+"/materials",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+accessToken},body:JSON.stringify({name:key,uom:uom||"kos"})});
  if(!r.ok) return null; const mat=await r.json(); materialsCatalog[mat.name]={id:mat.id,uom:mat.uom||"kos"}; renderMaterialsCatalogDatalist(); return materialsCatalog[mat.name];
}

/* ===== Dnevnik del ===== */
function previewFiles(input, mount){
  const cont=document.getElementById(mount); cont.innerHTML="";
  [...(input.files||[])].forEach(f=>{
    const url=URL.createObjectURL(f);
    const img=new Image(); img.src=url; img.className="w-20 h-20 object-cover rounded border";
    cont.appendChild(img);
  });
}
document.getElementById('logPhotos')?.addEventListener('change', e=>previewFiles(e.target,'logPhotosPreview'));

async function uploadPhotos(){
  const el=document.getElementById('logPhotos'); if(!el || !el.files || !el.files.length) return [];
  const fd=new FormData(); [...el.files].forEach(f=>fd.append('photos',f));
  const r=await fetch(API_BASE+'/upload',{method:'POST',headers:{Authorization:'Bearer '+accessToken},body:fd});
  if(!r.ok) return []; const data=await r.json(); return data.files||[];
}

document.getElementById("addLog")?.addEventListener("click", async ()=>{
  if(!me) return alert("Najprej se prijavi.");
  const pid=document.getElementById("logProject").value;
  const activity=document.getElementById("logActivity").value.trim();
  const hours=parseFloat(document.getElementById("logHours").value||"0");
  if(!pid||!activity||!hours) return alert("Izpolni: projekt, aktivnost, ure.");

  const mats=(materials||[]).filter(m=>(m.name && m.name.trim()) || parseFloat(m.qty||"0")>0);
  for(const m of mats){ try{ await ensureMaterialOnServer(m.name,m.uom||"kos"); }catch(e){} }

  const photos=await uploadPhotos();

  const r=await fetch(API_BASE+'/jobs',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},
    body:JSON.stringify({projectId:pid,activity,hours,materials:mats,photos})});
  if(!r.ok){const e=await r.json().catch(()=>({}));alert(e.error||'Napaka pri shranjevanju');return}
  document.getElementById("logActivity").value=""; document.getElementById("logHours").value=""; document.getElementById("logPhotos").value=null;
  document.getElementById("logPhotosPreview").innerHTML=""; materials=[]; renderMaterials();
  await loadJobLogs();
});

async function loadJobLogs(){
  const r=await fetch(API_BASE+'/jobs',{headers:{Authorization:'Bearer '+accessToken}}); const list=r.ok?await r.json():[];
  const wrap=document.getElementById('logList');
  if(!list.length){wrap.innerHTML='<div class="text-center py-4 text-gray-500"><i class="fas fa-tasks text-2xl mb-2"></i><p>Ni shranjenih vnosov.</p></div>';return}
  wrap.innerHTML=list.map(j=>`
    <div class="p-3 border rounded-xl">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <div class="font-medium"><i class="fas fa-folder text-yellow-500 mr-2"></i>${projectName(j.projectId)}</div>
          <div class="mt-1 text-sm">${j.activity} • ${j.employee} • ${(+j.hours||0)} h</div>
          ${j.materials?.length?`<div class="mt-2 text-xs text-gray-500">Materiali: ${j.materials.map(m=>`${m.name} (${m.qty||0} ${m.uom||''})`).join(', ')}</div>`:""}
          ${j.photos?.length?`<div class="mt-2 flex gap-2 flex-wrap">${j.photos.map(p=>`<a href="${p.url}" target="_blank"><img src="${p.url}" class="w-16 h-16 object-cover rounded border"/></a>`).join('')}</div>`:""}
        </div>
        <div class="text-xs text-gray-500">${dmy(j.ts)}</div>
      </div>
    </div>`).join('');
}

/* ===== Poročila ===== */
function summarize(rows, by){
  const map={}; rows.forEach(r=>{const k=r[by]||'—'; map[k]=(map[k]||0)+Number(r.hours||0)});
  return Object.entries(map).map(([k,v])=>({key:k,hours:+(+v).toFixed(2)})).sort((a,b)=>b.hours-a.hours);
}
function renderKpi(list, id){ const ul=document.getElementById(id); ul.innerHTML=list.length?list.map(i=>`<li class="flex justify-between"><span>${i.key||'—'}</span><span>${i.hours}</span></li>`).join(''):'<li class="flex justify-between"><span>—</span><span>0</span></li>'; }
function renderTable(rows, id, cols){
  const tb=document.getElementById(id);
  tb.innerHTML=rows.map(r=>`<tr>${cols.map(c=>`<td class="border p-2">${c(r)}</td>`).join('')}</tr>`).join('') || `<tr><td class="border p-2 text-center text-gray-500" colspan="5">Ni podatkov.</td></tr>`;
}
function dayKey(ts){ const d=new Date(ts); d.setHours(0,0,0,0); return d.getTime(); }
function buildPresenceRows(raw){
  const groups={};
  raw.slice().sort((a,b)=>a.ts-b.ts).forEach(e=>{
    const key=`${dayKey(e.ts)}|${e.email}|${e.projectId||''}`;
    (groups[key] ||= []).push(e);
  });
  const rows=[];
  Object.keys(groups).forEach(k=>{
    const list=groups[k]; let workStart=null,breakStart=null,breakMs=0,totalMs=0;
    for(const ev of list){
      if(ev.type==='in'){ workStart=ev.ts; breakStart=null; breakMs=0; }
      else if(ev.type==='break-start' && workStart && !breakStart){ breakStart=ev.ts; }
      else if(ev.type==='break-end' && breakStart){ breakMs += (ev.ts - breakStart); breakStart=null; }
      else if(ev.type==='out' && workStart){ totalMs += Math.max(0, (ev.ts - workStart) - breakMs); workStart=null; breakStart=null; breakMs=0; }
    }
    const [day,email,proj]=k.split('|'); const date=new Date(+day);
    const emp = usersDir[email]?.name || email;
    const hours=+(totalMs/36e5).toFixed(2);
    if(hours>0) rows.push({date,dateStr:date.toLocaleDateString('sl-SI'),projectId:proj,project:projectName(proj),employeeEmail:email,employee:emp,hours});
  });
  return rows;
}
function buildJobRows(raw){
  return raw.map(j=>({date:new Date(j.ts),dateStr:dmy(j.ts),projectId:j.projectId,project:projectName(j.projectId),employeeEmail:j.email,employee:j.employee,activity:j.activity,hours:+(+j.hours||0).toFixed(2)}));
}
function prepareReportFilters(){
  const from=document.getElementById('repFrom'); const to=document.getElementById('repTo');
  const now=new Date(); const fm=new Date(now.getFullYear(),now.getMonth(),1); const tm=new Date(now.getFullYear(),now.getMonth()+1,0);
  from.value=fm.toISOString().slice(0,10); to.value=tm.toISOString().slice(0,10);
  renderEmployeesFilter(); document.getElementById('repRefresh')?.addEventListener('click',renderReports);
document.getElementById('repRefresh')?.addEventListener('click', () => {
  renderReports();
  if (__drSelectedProject) refreshDiaryDetails();
});

}
async function renderReports(){
  const from=new Date(document.getElementById('repFrom').value||'1970-01-01'); from.setHours(0,0,0,0);
  const to  =new Date(document.getElementById('repTo').value  ||'2999-12-31'); to.setHours(23,59,59,999);
  const proj=document.getElementById('repProject').value||''; const emp=document.getElementById('repEmployee').value||'';
  const presenceRaw=await loadPresenceRange(from,to,proj,emp);
  const jobsRaw=await (async()=>{
    const qs=new URLSearchParams(); qs.set('from',from.getTime()); qs.set('to',to.getTime());
    if(proj) qs.set('projectId',proj); if(emp) qs.set('email',emp);
    const r=await fetch(API_BASE+'/jobs?'+qs.toString(),{headers:{Authorization:'Bearer '+accessToken}}); return r.ok?await r.json():[];
renderDiaryProjectsList();

  })();

  const presence=buildPresenceRows(presenceRaw);
  const logs=buildJobRows(jobsRaw);

  renderKpi(summarize(presence,'project'),'kpiPresenceProj');
  renderKpi(summarize(presence,'employee'),'kpiPresenceEmp');
  renderKpi(summarize(logs,'project'),'kpiJobsProj');
  renderKpi(summarize(logs,'employee'),'kpiJobsEmp');

  renderTable(presence,'tblPresence',[r=>r.dateStr,r=>r.project||'—',r=>r.employee,r=>r.hours]);
  renderTable(logs,'tblJobs',[r=>r.dateStr,r=>r.project||'—',r=>r.employee,r=>r.activity||'—',r=>r.hours]);

  window.__filteredPresence=presence; window.__filteredLogs=logs;
}

/* ===== EXCEL & PDF ===== */
document.getElementById('exportExcel')?.addEventListener('click',()=>{
  const presence=window.__filteredPresence||[]; const logs=window.__filteredLogs||[];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(presence.map(p=>({Datum:p.dateStr,Projekt:p.project,Zaposleni:p.employee,Ure:p.hours}))),'Prisotnost');
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(summarize(presence,'project').map(x=>({Projekt:x.key,Ure:x.hours}))),'Sum proj (prisot)');
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(summarize(presence,'employee').map(x=>({Zaposleni:x.key,Ure:x.hours}))),'Sum zap (prisot)');
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(logs.map(l=>({Datum:l.dateStr,Projekt:l.project,Zaposleni:l.employee,Aktivnost:l.activity,Ure:l.hours}))),'Dnevnik del');
  XLSX.utils.writeFile(wb,'porocilo_housetech.xlsx');
});
document.getElementById('exportPdf')?.addEventListener('click',()=>{
  const presence=window.__filteredPresence||[]; const logs=window.__filteredLogs||[];
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'});
  doc.setFontSize(16); doc.text('HOUSETECH — Poročilo',40,40);
  doc.setFontSize(10); doc.text(`Datum: ${new Date().toLocaleString('sl-SI')}`,40,58);
  doc.setFontSize(12); doc.text('Prisotnost — povzetek po projektih',40,84);
  doc.autoTable({startY:92,styles:{fontSize:9},head:[['Projekt','Ure']],body:summarize(presence,'project').map(r=>[r.key,r.hours])});
  doc.text('Prisotnost — povzetek po zaposlenih',40,doc.lastAutoTable.finalY+24);
  doc.autoTable({startY:doc.lastAutoTable.finalY+32,styles:{fontSize:9},head:[['Zaposleni','Ure']],body:summarize(presence,'employee').map(r=>[r.key,r.hours])});
  doc.text('Dnevnik del (vrstice)',40,doc.lastAutoTable.finalY+24);
  doc.autoTable({startY:doc.lastAutoTable.finalY+32,styles:{fontSize:8},head:[['Datum','Projekt','Zaposleni','Aktivnost','Ure']],body:logs.map(r=>[r.dateStr,r.project,r.employee,r.activity||'',r.hours])});
  doc.save('porocilo_housetech.pdf');
});
</script>
</body>
</html>

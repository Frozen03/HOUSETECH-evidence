<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOUSETECH Ops</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- EXCEL & PDF -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --primary:#3B82F6; --primary-700:#2563EB; --secondary:#10B981; --danger:#EF4444;
      --bg:#F3F4F6; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --border:#E5E7EB;
      --tab-active:#FFFFFF; --tab-inactive:#F3F4F6;
    }
    .dark-mode{
      --bg:#0F172A; --card:#111827; --text:#E5E7EB; --muted:#A1A1AA; --border:#1F2937;
      --tab-active:#111827; --tab-inactive:#1F2937;
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      transition: background .3s, color .3s;
      background:
        url("../img/logo.png") center/contain no-repeat fixed,
        var(--bg);
    }
    body.dark-mode{
      background:
        linear-gradient(to bottom, rgba(15,23,42,0.9), rgba(15,23,42,0.95)),
        url("../img/housetech-dark.png") center/cover no-repeat fixed;
    }

    .card{ background: var(--card); border:1px solid var(--border); border-radius:1rem; box-shadow: 0 4px 8px rgba(0,0,0,.05); padding:1.25rem; }
    .btn{ border-radius:.75rem; padding:.6rem 1.1rem; font-weight:600; display:inline-flex; gap:.5rem; align-items:center; }
    .btn-primary{ background:var(--primary); color:#fff; } .btn-primary:hover{ background:var(--primary-700); }
    .btn-outline{ border:1px solid var(--border); color:var(--text); background:transparent; }
    .btn-danger{ background:var(--danger); color:#fff; }

    input, select, textarea{ width:100%; border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:.75rem; padding:.7rem .9rem; }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.15); }

    .tab-btn{ padding:.5rem 1rem; font-weight:600; border:1px solid var(--border); }
    .tab-active{ background:var(--tab-active); }
    .tab-inactive{ background:var(--tab-inactive); color:var(--muted); }
    .tab-btn + .tab-btn{ border-left:none; }
    .tabs-wrap{ border-radius:1rem; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.06); }

    .tbl { width:100%; border-collapse: collapse; }
    .tbl th,.tbl td { border:1px solid var(--border); padding:.5rem .6rem; font-size:.875rem; }
    .tbl th { background:var(--tab-inactive); text-align:left; }

    /* koledar */
    .cal-grid{ display:grid; grid-template-columns: repeat(7,minmax(0,1fr)); gap:.5rem; }
    .cal-cell{ border:1px solid var(--border); border-radius:.75rem; padding:.5rem; min-height:130px; background:var(--card); display:flex; flex-direction:column; }
    .cal-day{ font-size:.85rem; font-weight:700; color:var(--muted); display:flex; align-items:center; justify-content:space-between; }
    .cal-badge{ font-size:.7rem; padding:.1rem .35rem; border-radius:.5rem; }
    .cal-item{ border:1px dashed var(--border); border-radius:.5rem; padding:.25rem .35rem; font-size:.8rem; margin-top:.25rem; background:var(--tab-inactive); }
    .cal-locked{ opacity:.6; pointer-events:none; }
  </style>
</head>
<body>
<div class="max-w-6xl mx-auto py-6 px-4">
  <header class="flex items-start justify-between mb-6">
    <div>
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold flex items-center gap-3"><span class="logo">HOUSETECH</span><span>Ops</span></h1>
        <button id="themeToggle" class="btn btn-outline p-2 !px-3" title="Preklopi temo"><i class="fas fa-moon"></i></button>
      </div>
      <p class="text-sm" style="color:var(--muted)">Prijava z Google</p>
    </div>
    <div><span id="statusBadge" class="badge bg-green-100 text-green-700 rounded-full px-2 py-0.5 hidden"><i class="fas fa-check mr-1"></i>Prijavljen</span></div>
  </header>

  <!-- PRIJAVA -->
  <div id="authCard" class="card mb-6">
    <h2 class="text-lg font-semibold mb-3"><i class="fas fa-right-to-bracket mr-2 text-blue-500"></i>Prijava</h2>
    <p class="text-sm mb-4" style="color:var(--muted)">Prijavi se z Google. Strežnik preveri ID token in izda JWT z vlogami (whitelist).</p>
    <div class="flex items-center gap-3">
      <div id="g_id_signin"></div>
      <button id="signOut" class="btn btn-outline hidden"><i class="fas fa-right-from-bracket"></i> Odjava</button>
    </div>
  </div>

  <!-- TABS -->
  <nav id="tabsNav" class="mb-6 hidden">
    <div class="tabs-wrap inline-flex">
      <button data-tab="time" class="tab-btn tab-active"><i class="far fa-clock mr-2"></i>Evidenca ur</button>
      <button id="tabBtnPlan" data-tab="plan" class="tab-btn tab-inactive hidden"><i class="fas fa-calendar-alt mr-2"></i>Plan dela (BETA)</button>
      <button data-tab="jobs" class="tab-btn tab-inactive"><i class="far fa-list-alt mr-2"></i>Dnevnik del</button>
      <button id="tabBtnDiaries" data-tab="diaries" class="tab-btn tab-inactive hidden"><i class="fas fa-book mr-2"></i>Dnevniki</button>
      <button data-tab="reports" class="tab-btn tab-inactive"><i class="far fa-chart-bar mr-2"></i>Poročila</button>
      <button id="tabBtnAdmin" data-tab="admin" class="tab-btn tab-inactive"><i class="fas fa-user-shield mr-2"></i>Admin</button>
    </div>
  </nav>

  <!-- ===== Evidenca ur ===== -->
  <section id="tab-time">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div id="presencePanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-user-clock mr-2 text-blue-500"></i>Registracija prisotnosti</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Projekt</label>
            <select id="currentProject"><option value="">— izberi —</option></select>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="clockIn"  class="btn" style="background:#10B981;color:#fff;"><i class="fas fa-sign-in-alt"></i> Prihod</button>
            <button id="clockOut" class="btn" style="background:#EF4444;color:#fff;"><i class="fas fa-sign-out-alt"></i> Odhod</button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="breakStart" class="btn btn-outline"><i class="fas fa-utensils"></i> Začetek malice</button>
            <button id="breakEnd"   class="btn btn-outline"><i class="fas fa-utensils"></i> Konec malice</button>
          </div>
        </div>
      </div>

      <div id="todayPanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="far fa-calendar-check mr-2 text-blue-500"></i>Današnje registracije</h2>
        <ul id="todayEntries" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <!-- ===== PLAN DELA (MESEČNI KOLEDAR) ===== -->
  <section id="tab-plan" class="hidden">
    <div class="card">
      <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
        <div class="flex items-center gap-2">
          <button id="monthPrev" class="btn btn-outline !py-1"><i class="fas fa-chevron-left"></i> Prejšnji</button>
          <div id="monthLabel" class="font-semibold text-lg min-w-[200px] text-center"></div>
          <button id="monthNext" class="btn btn-outline !py-1">Naslednji <i class="fas fa-chevron-right"></i></button>
          <button id="monthToday" class="btn btn-outline !py-1"><i class="fas fa-dot-circle"></i> Danes</button>
        </div>
        <div class="text-sm" id="planPermNote" style="color:var(--muted)"></div>
      </div>

      <div class="grid grid-cols-7 gap-2 text-xs font-semibold mb-1" style="color:var(--muted)">
        <div>Pon</div><div>Tor</div><div>Sre</div><div>Čet</div><div>Pet</div><div>Sob</div><div>Ned</div>
      </div>
      <div id="calGrid" class="cal-grid"></div>

      <div class="flex justify-end gap-2 mt-3">
        <button id="planSave" class="btn btn-primary"><i class="fas fa-save"></i> Shrani plan</button>
      </div>
    </div>
  </section>

  <!-- ===== Dnevnik del ===== -->
  <section id="tab-jobs" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div id="jobsProjectsCard" class="card hidden"></div>
      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-tasks mr-2 text-blue-500"></i>Dnevnik del</h2>
        <div class="space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label class="block text-sm font-medium mb-1">Projekt</label><select id="logProject"></select></div>
            <div><label class="block text-sm font-medium mb-1">Aktivnost</label><input id="logActivity" placeholder="npr. Montaža stikal..." /></div>
            <div><label class="block text-sm font-medium mb-1">Ure</label><input id="logHours" type="number" step="0.25" placeholder="npr. 3.5" /></div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Materiali</label>
            <div id="materialsList" class="space-y-2"></div>
            <datalist id="materialsCatalog"></datalist>
            <button id="addMaterialRow" type="button" class="btn btn-outline mt-2"><i class="fas fa-plus"></i> Dodaj material</button>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Fotografije/Video</label>
            <input type="file" id="logMedia" multiple accept="image/*,video/*" class="w-full border rounded-lg p-2">
          </div>

          <div class="flex justify-end"><button id="addLog" class="btn btn-primary"><i class="fas fa-save mr-1"></i> Shrani vnos</button></div>
        </div>

        <hr class="my-4" style="border-color:var(--border)" />
        <h3 class="text-md font-semibold mb-2"><i class="fas fa-history mr-2 text-blue-500"></i>Zgodovina vnosov</h3>
        <div id="logList" class="space-y-3 text-sm max-h-96 overflow-y-auto pr-2"></div>
      </div>
    </div>
  </section>

  <!-- ===== Dnevniki ===== -->
  <section id="tab-diaries" class="hidden">
    <div class="card">
      <h2 class="text-lg font-semibold mb-3"><i class="fas fa-book mr-2 text-blue-500"></i>Dnevniki del</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
        <div>
          <label class="block text-sm font-medium mb-1">Od</label>
          <input type="date" id="diaryFrom" class="w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Do</label>
          <input type="date" id="diaryTo" class="w-full">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Projekt</label>
          <select id="diaryProject" class="w-full">
            <option value="">Vsi projekti</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Prikaži po</label>
          <select id="diaryGroupBy" class="w-full">
            <option value="total">Skupno</option>
            <option value="monthly">Mesečno</option>
            <option value="daily">Dnevno</option>
          </select>
        </div>
      </div>

      <div class="flex gap-2 mb-4">
        <button id="diaryRefresh" class="btn btn-primary"><i class="fas fa-refresh mr-1"></i> Osveži</button>
        <button id="diaryExport" class="btn btn-outline"><i class="fas fa-download mr-1"></i> Izvozi</button>
      </div>

      <div id="diaryResults" class="space-y-4">
        <!-- Results will be populated here -->
      </div>
    </div>
  </section>

  <!-- ===== Poročila ===== -->
  <section id="tab-reports" class="hidden">
    <div class="card">
      <h2 class="text-lg font-semibold mb-3"><i class="fas fa-file-export mr-2 text-blue-500"></i>Poročila</h2>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-3">
        <div><label class="block text-sm font-medium mb-1">Od</label><input type="date" id="repFrom"></div>
        <div><label class="block text-sm font-medium mb-1">Do</label><input type="date" id="repTo"></div>
        <div><label class="block text-sm font-medium mb-1">Projekt</label><select id="repProject"><option value="">Vsi</option></select></div>
        <div><label class="block text-sm font-medium mb-1">Zaposleni</label><select id="repEmployee"><option value="">Vsi</option></select></div>
        <div class="flex items-end gap-2"><button id="repRefresh" class="btn btn-primary w-full"><i class="fas fa-rotate"></i> Osveži</button></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
        <div class="card"><h4 class="font-semibold mb-2"><i class="fas fa-user-clock mr-2 text-blue-500"></i>Prisotnost — ure po projektih</h4><table class="tbl"><tbody id="kpiPresenceProj"></tbody></table></div>
        <div class="card"><h4 class="font-semibold mb-2"><i class="fas fa-user mr-2 text-blue-500"></i>Prisotnost — ure po zaposlenih</h4><table class="tbl"><tbody id="kpiPresenceEmp"></tbody></table></div>
        <div class="card"><h4 class="font-semibold mb-2"><i class="fas fa-diagram-project mr-2 text-blue-500"></i>Dnevnik — ure po projektih</h4><table class="tbl"><tbody id="kpiJobsProj"></tbody></table></div>
        <div class="card"><h4 class="font-semibold mb-2"><i class="fas fa-people-group mr-2 text-blue-500"></i>Dnevnik — ure po zaposlenih</h4><table class="tbl"><tbody id="kpiJobsEmp"></tbody></table></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <h3 class="font-semibold mb-2">Evidenca prisotnosti (vrstice)</h3>
          <div class="max-h-96 overflow-auto border rounded-lg">
            <table class="tbl">
              <thead><tr><th>Datum</th><th>Projekt</th><th>Zaposleni</th><th style="width:80px">Ure</th></tr></thead>
              <tbody id="tblPresence"></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Dnevnik del (vrstice)</h3>
          <div class="max-h-96 overflow-auto border rounded-lg">
            <table class="tbl">
              <thead><tr><th>Datum</th><th>Projekt</th><th>Zaposleni</th><th>Aktivnost</th><th style="width:80px">Ure</th></tr></thead>
              <tbody id="tblJobs"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mt-4">
        <button id="exportExcel" class="btn btn-primary"><i class="fas fa-file-excel mr-1"></i> Excel (.xlsx)</button>
        <button id="exportPdf"   class="btn btn-outline"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
        <button id="exportData"  class="btn btn-outline"><i class="fas fa-download mr-1"></i> export.json (debug)</button>
        <button id="wipeData"    class="btn btn-outline"><i class="fas fa-trash-alt mr-1"></i> Počisti lokalne podatke</button>
      </div>
    </div>
  </section>

  <!-- ===== Admin ===== -->
  <section id="tab-admin" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-users-cog mr-2 text-blue-500"></i>Uporabniki</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
          <input id="admUserEmail" placeholder="email@domena.si" />
          <input id="admUserName" placeholder="Ime in priimek" />
          <div class="flex flex-wrap gap-2 text-sm">
            <label><input id="roleOwner" type="checkbox" class="mr-1">Owner</label>
            <label><input id="roleCEO" type="checkbox" class="mr-1">CEO</label>
            <label><input id="roleManager" type="checkbox" class="mr-1">vodja</label>
            <label><input id="roleEmployee" type="checkbox" class="mr-1">zaposlen</label>
            <label><input id="roleStudent" type="checkbox" class="mr-1">študent</label>
          </div>
          <button id="admAddUser" class="btn btn-primary"><i class="fas fa-user-plus"></i> Shrani</button>
        </div>
        <ul id="admUserList" class="space-y-2 text-sm"></ul>
      </div>

      <div class="card">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-sitemap mr-2 text-blue-500"></i>Projekti</h2>
        <div class="flex gap-2 mb-3">
          <input id="admProjectName" class="flex-1" placeholder="Dodaj nov projekt" />
          <button id="admAddProject" class="btn btn-primary"><i class="fas fa-plus"></i></button>
        </div>
        <ul id="admProjectList" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <footer class="mt-10 text-xs text-center" style="color:var(--muted)">© 2025 HOUSETECH — final</footer>
</div>

<script>
/* ===== Tema ===== */
const themeToggle = document.getElementById('themeToggle');
const storedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
if (storedTheme === 'dark') { document.body.classList.add('dark-mode'); themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; }
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  const dark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  themeToggle.innerHTML = dark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
});

/* ===== Konfiguracija ===== */
const GOOGLE_CLIENT_ID = "149127907023-ip3jqct2vmqc4tm4jm4bfoogd1pqfpsv.apps.googleusercontent.com";
const API_BASE = "";

let accessToken = localStorage.getItem("jwt") || null;
let me = localStorage.getItem("me") ? JSON.parse(localStorage.getItem("me")) : null;
let usersDir = {}; let projects = [];
let materialsCatalog = {}; let materials = [];

const isOwner = () => (me?.roles||[]).includes('Owner');
const isOwnerOrCeo = () => (me?.roles||[]).some(r => r==='Owner' || r==='CEO');
const isManager = () => (me?.roles||[]).some(r => r==='Owner' || r==='CEO' || r==='vodja');
const isEmployee = () => (me?.roles||[]).some(r => r==='zaposlen' || r==='študent');

/* ===== Tabs ===== */
function selectTab(name){
  ["time","plan","jobs","diaries","reports","admin"].forEach(t=>{
    document.getElementById("tab-"+t).classList.add("hidden");
    const btn = document.querySelector(`[data-tab="${t}"]`);
    if(btn){ btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); }
  });
  document.getElementById("tab-"+name).classList.remove("hidden");
  const sel = document.querySelector(`[data-tab="${name}"]`);
  if(sel){ sel.classList.add('tab-active'); sel.classList.remove('tab-inactive'); }
  if(name==="jobs"){ try{ renderMaterials(); renderMaterialsCatalogDatalist(); }catch(e){} }
  if(name==="admin"){ adminReload(); }
  if(name==="reports"){ prepareReportFilters(); renderReports(); }
  if(name==="plan"){ renderCalendar(); }
  if(name==="diaries"){ loadDiaries(); }
}
document.querySelectorAll(".tab-btn").forEach(btn=>btn.addEventListener("click",()=>selectTab(btn.getAttribute("data-tab"))));

/* ===== Google Sign-In ===== */
async function handleGoogleCredentialResponse(response){
  try{
    const res = await fetch(API_BASE + "/auth/google/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:response.credential})});
    if(!res.ok){ const err = await res.json().catch(()=>({})); throw new Error(err.error || "Neuspešna verifikacija"); }
    const data = await res.json();
    accessToken = data.access_token; me = data.user;
    localStorage.setItem("jwt", accessToken); localStorage.setItem("me", JSON.stringify(me));
    await loadBootstrapData();
    if (typeof renderProjects === "function") renderProjects();

    // vidnost zavihkov
    document.getElementById('tabBtnReports')?.classList.toggle('hidden', !isOwnerOrCeo());
    document.getElementById('tabBtnAdmin')?.classList.toggle('hidden', !isOwnerOrCeo());
    document.getElementById('tabBtnPlan')?.classList.toggle('hidden', !isManager());
    document.getElementById('tabBtnDiaries')?.classList.toggle('hidden', !isManager());

    showAppAfterLogin(); selectTab('time');
  }catch(e){ alert("Prijava ni uspela: " + e.message); }
}
function initGoogle(){
  if(!(window.google && google.accounts && google.accounts.id)) return false;
  try{
    google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID, callback:handleGoogleCredentialResponse});
    const m = document.getElementById('g_id_signin'); if(m && m.childElementCount===0){ google.accounts.id.renderButton(m,{theme:"outline",size:"large"}); }
    return true;
  }catch{ return false; }
}
window.addEventListener('load', ()=>{
  let tries=0; const t=setInterval(()=>{ if(initGoogle()||tries++>40) clearInterval(t); },100);
  if(accessToken && me){ loadBootstrapData().then(()=>{ if (typeof renderProjects==="function") renderProjects(); showAppAfterLogin(); selectTab('time'); }); } else { showLoggedOut(); }
});

/* ===== UI helperji ===== */
function showAppAfterLogin(){
  document.getElementById('g_id_signin')?.classList.add('hidden');
  document.getElementById('signOut')?.classList.remove('hidden');
  document.getElementById('statusBadge')?.classList.remove('hidden');
  document.getElementById('tabsNav')?.classList.remove('hidden');
  document.getElementById('presencePanel')?.classList.remove('hidden');
  document.getElementById('todayPanel')?.classList.remove('hidden');
  renderTimeEntries();
}
function showLoggedOut(){
  document.getElementById('g_id_signin')?.classList.remove('hidden');
  document.getElementById('signOut')?.classList.add('hidden');
  document.getElementById('statusBadge')?.classList.add('hidden');
  document.getElementById('tabsNav')?.classList.add('hidden');
  document.getElementById('presencePanel')?.classList.add('hidden');
  document.getElementById('todayPanel')?.classList.add('hidden');
}
document.getElementById('signOut')?.addEventListener('click', ()=>{
  localStorage.clear(); accessToken=null; me=null; showLoggedOut();
  ["time","plan","jobs","diaries","reports","admin"].forEach(t=>document.getElementById("tab-"+t)?.classList.add("hidden"));
});

/* ===== Bootstrap data ===== */
function mapMaterialsToCatalog(list){
  const out = {}; (list || []).forEach(m => { if (m?.name) out[m.name] = { id: m.id, uom: m.uom || "kos" }; }); return out;
}
async function loadBootstrapData(){
  const u = await fetch(API_BASE + "/users",{headers:{Authorization:"Bearer "+accessToken}}); usersDir = u.ok ? await u.json() : {};
  const p = await fetch(API_BASE + "/projects",{headers:{Authorization:"Bearer "+accessToken}}); projects = p.ok ? await p.json() : [];
  const m = await fetch(API_BASE + "/materials",{headers:{Authorization:"Bearer "+accessToken}}); materialsCatalog = m.ok ? mapMaterialsToCatalog(await m.json()) : {};
  renderProjects(); renderUsersAdmin(); renderProjectsAdmin(); renderMaterialsCatalogDatalist();
}

/* ===== Projekti (selecti) ===== */
function renderProjects(){
  const cp=document.getElementById("currentProject"), lp=document.getElementById("logProject");
  if (cp) cp.innerHTML='<option value="">— izberi —</option>'+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
  if (lp) lp.innerHTML=projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
  const rp=document.getElementById('repProject'); if (rp){ rp.innerHTML = '<option value="">Vsi</option>' + projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
  const dp=document.getElementById('diaryProject'); if (dp){ dp.innerHTML = '<option value="">Vsi projekti</option>' + projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
}
function renderEmployeesFilter(){
  const re = document.getElementById('repEmployee'); if(!re) return;
  const emails = Object.keys(usersDir);
  re.innerHTML = '<option value="">Vsi</option>' + emails
    .map(e=>({email:e, name: usersDir[e]?.name || e}))
    .sort((a,b)=>a.name.localeCompare(b.name))
    .map(u=>`<option value="${u.email}">${u.name}</option>`).join('');
}

/* ===== Admin (skrajšano) ===== */
function renderUsersAdmin(){
  const ul=document.getElementById('admUserList'); if(!ul) return;
  const entries=Object.entries(usersDir).sort((a,b)=>(a[1].name||a[0]).localeCompare(b[1].name||b[0]));
  ul.innerHTML=entries.map(([email,u])=>`
    <li class="p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);">
      <div class="min-w-0">
        <div class="font-medium truncate"><i class="fas fa-user mr-2 text-blue-500"></i>${u.name||email}
          <span style="color:var(--muted)">•</span> <span style="color:var(--muted)">${email}</span></div>
        <div class="text-xs" style="color:var(--muted)">Vloge: ${(u.roles||[]).join(', ')||'—'}</div>
      </div>
      <div class="flex gap-2">
        <button class="btn btn-outline text-xs" onclick="admEditUser('${email}')"><i class="fas fa-pen"></i> Uredi</button>
        <button class="btn btn-danger text-xs" onclick="admDelUser('${email}')"><i class="fas fa-trash"></i> Izbriši</button>
      </div>
    </li>`).join('') || `<li class="text-center" style="color:var(--muted)">Ni uporabnikov.</li>`;
}
function admEditUser(email){
  const u=usersDir[email]||{};
  document.getElementById('admUserEmail').value=email;
  document.getElementById('admUserName').value=u.name||'';
  document.getElementById('roleOwner').checked   =(u.roles||[]).includes('Owner');
  document.getElementById('roleCEO').checked     =(u.roles||[]).includes('CEO');
  document.getElementById('roleManager').checked =(u.roles||[]).includes('vodja');
  document.getElementById('roleEmployee').checked=(u.roles||[]).includes('zaposlen');
  document.getElementById('roleStudent').checked =(u.roles||[]).includes('študent');
}
document.getElementById('admAddUser')?.addEventListener('click', async ()=>{
  if(!isOwnerOrCeo()) return alert('Samo Owner/CEO');
  const email=document.getElementById('admUserEmail').value.trim().toLowerCase();
  const name =document.getElementById('admUserName').value.trim();
  if(!email||!name) return alert('Vnesi email in ime');

  const roles=[];
  if(document.getElementById('roleOwner').checked) roles.push('Owner');
  if(document.getElementById('roleCEO').checked) roles.push('CEO');
  if(document.getElementById('roleManager').checked) roles.push('vodja');
  if(document.getElementById('roleEmployee').checked) roles.push('zaposlen');
  if(document.getElementById('roleStudent').checked) roles.push('študent');

  let r=await fetch(API_BASE+'/users',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({email,name})});
  r=await fetch(API_BASE+'/users/'+encodeURIComponent(email),{method:'PATCH',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({name,roles})});
  if(!r.ok) return alert('Napaka pri shranjevanju uporabnika');
  await adminReload();
  document.getElementById('admUserEmail').value=''; document.getElementById('admUserName').value='';
  ['roleOwner','roleCEO','roleManager','roleEmployee','roleStudent'].forEach(id=>document.getElementById(id).checked=false);
});
async function admDelUser(email){
  if(!isOwnerOrCeo()) return alert('Samo Owner/CEO');
  if(!confirm('Res izbrišem uporabnika '+email+'?')) return;
  const r=await fetch(API_BASE+'/users/'+encodeURIComponent(email),{method:'DELETE',headers:{Authorization:'Bearer '+accessToken}});
  if(r.status===403) return alert('Uporabnika z vlogo Owner ni mogoče izbrisati.');
  if(!r.ok) return alert('Napaka pri brisanju uporabnika.');
  await adminReload();
}
function renderProjectsAdmin(){
  const ul=document.getElementById('admProjectList'); if(!ul) return;
  ul.innerHTML=(projects||[]).map(p=>`
    <li class="p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);">
      <div class="font-medium truncate"><i class="fas fa-folder text-yellow-500 mr-2"></i>${p.name}</div>
      <button class="btn btn-outline text-xs" onclick="admDelProject('${p.id}')"><i class="fas fa-trash"></i> Izbriši</button>
    </li>`).join('') || `<li class="text-center" style="color:var(--muted)">Ni projektov.</li>`;
}
document.getElementById('admAddProject')?.addEventListener('click', async ()=>{
  if(!isOwnerOrCeo()) return alert('Samo Owner/CEO');
  const name=document.getElementById('admProjectName').value.trim(); if(!name) return;
  const r=await fetch(API_BASE+'/projects',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({name})});
  if(!r.ok) return alert('Napaka pri dodajanju projekta');
  document.getElementById('admProjectName').value=''; await adminReload();
});
async function admDelProject(id){
  if(!confirm('Izbrišem projekt?')) return;
  const r=await fetch(API_BASE+'/projects/'+encodeURIComponent(id),{method:'DELETE',headers:{Authorization:'Bearer '+accessToken}});
  if(!r.ok) return alert('Napaka pri brisanju projekta');
  await adminReload();
}
async function adminReload(){
  if(!accessToken) return;
  const u=await fetch(API_BASE+'/users',{headers:{Authorization:'Bearer '+accessToken}}); if(u.ok) usersDir=await u.json();
  const p=await fetch(API_BASE+'/projects',{headers:{Authorization:'Bearer '+accessToken}}); if(p.ok) projects=await p.json();
  const m=await fetch(API_BASE+'/materials',{headers:{Authorization:'Bearer '+accessToken}}); if(m.ok){ materialsCatalog = mapMaterialsToCatalog(await m.json()); }
  renderUsersAdmin(); renderProjectsAdmin(); renderProjects(); renderMaterialsCatalogDatalist(); renderEmployeesFilter();
}

/* ===== Materiali & dnevnik (skrajšano) ===== */
function renderMaterialsCatalogDatalist(){
  const dl=document.getElementById('materialsCatalog'); if(!dl) return;
  const entries=Object.entries(materialsCatalog).sort((a,b)=>a[0].localeCompare(b[0]));
  dl.innerHTML=entries.map(([name,info])=>`<option value="${name}" data-uom="${info.uom||'kos'}"></option>`).join('');
}
function renderMaterials(){
  const wrap=document.getElementById('materialsList'); if(!wrap) return;
  if(materials.length===0) materials.push({name:'',qty:'',uom:'kos'});
  wrap.innerHTML=materials.map((m,idx)=>`
    <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
      <input list="materialsCatalog" class="md:col-span-6" placeholder="Material"
             value="${m.name||''}" oninput="onMatNameInput(${idx}, this.value)"/>
      <input type="number" step="0.01" class="md:col-span-3" placeholder="Količina"
             value="${m.qty||''}" oninput="materials[${idx}].qty=this.value"/>
      <select class="md:col-span-2" onchange="materials[${idx}].uom=this.value">
        <option value="kos" ${m.uom==='kos'?'selected':''}>kos</option>
        <option value="m"   ${m.uom==='m'?'selected':''}>m</option>
        <option value="kpl" ${m.uom==='kpl'?'selected':''}>kpl</option>
        <option value="h"   ${m.uom==='h'?'selected':''}>h</option>
      </select>
      <button type="button" class="md:col-span-1 btn btn-outline !py-2 !px-3" onclick="materials.splice(${idx},1); renderMaterials();"><i class="fas fa-times"></i></button>
    </div>`).join('');
  renderMaterialsCatalogDatalist();
}
window.onMatNameInput=(idx,val)=>{ materials[idx].name=val; const info=materialsCatalog[val]; if(info && info.uom){ materials[idx].uom=info.uom; renderMaterials(); } };

/* ===== Online shranjevanje ===== */
async function addTime(type){
  if(!me) return alert("Najprej se prijavi.");
  const pid=document.getElementById('currentProject').value||null;
  try {
    const res = await fetch(API_BASE + "/presence", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + accessToken
      },
      body: JSON.stringify({
        type: type,
        projectId: pid
      })
    });
    if (!res.ok) throw new Error("Napaka pri shranjevanju");
    renderTimeEntries();
  } catch (e) {
    alert("Napaka: " + e.message);
  }
}
async function deleteTimeEntry(id){
  if(!confirm("Odstranim vnos?")) return;
  try {
    const res = await fetch(API_BASE + "/presence/" + id, {
      method: "DELETE",
      headers: {
        Authorization: "Bearer " + accessToken
      }
    });
    if (!res.ok) throw new Error("Napaka pri brisanju");
    renderTimeEntries();
  } catch (e) {
    alert("Napaka: " + e.message);
  }
}
async function renderTimeEntries(){
  const ul=document.getElementById('todayEntries');
  const today=new Date(); 
  const start=new Date(today.getFullYear(),today.getMonth(),today.getDate()).getTime(); 
  const end=start+86400000;
  
  try {
    const res = await fetch(API_BASE + "/presence?from=" + start + "&to=" + end, {
      headers: {
        Authorization: "Bearer " + accessToken
      }
    });
    if (!res.ok) throw new Error("Napaka pri pridobivanju podatkov");
    
    const entries = await res.json();
    const filtered = entries.filter(e => e.email === me.email).sort((a,b)=>a.ts-b.ts);
    
    if(!filtered.length){ 
      ul.innerHTML='<li class="text-center py-4" style="color:var(--muted)"><i class="far fa-clock text-2xl mb-2"></i><p>Ni vnosov za danes.</p></li>'; 
      return; 
    }
    
    ul.innerHTML=filtered.map(e=>`
      <li class="p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);">
        <div class="flex items-center"><i class="far fa-clock mr-2"></i>
          <div>
            <div class="font-medium">${e.type} ob ${new Date(e.ts).toLocaleTimeString('sl-SI',{hour:'2-digit',minute:'2-digit'})}</div>
            <div class="text-xs" style="color:var(--muted)">${e.employee} • ${projectName(e.projectId)||"Brez projekta"}</div>
          </div>
        </div>
        <button class="btn btn-outline !py-1 !px-2 text-xs" onclick="deleteTimeEntry('${e.id}')"><i class="fas fa-trash"></i></button>
      </li>`).join('');
  } catch (e) {
    ul.innerHTML='<li class="text-center py-4" style="color:var(--muted)">Napaka pri nalaganju podatkov.</li>';
  }
}

document.getElementById("addLog")?.addEventListener("click", async ()=>{
  if (!me) return alert("Najprej se prijavi.");
  const pid = document.getElementById("logProject").value;
  const activity = document.getElementById("logActivity").value.trim();
  const hours = parseFloat(document.getElementById("logHours").value || "0");
  if (!pid || !activity || !hours) return alert("Izpolni: projekt, aktivnost, ure.");
  
  // Upload media files if any
  const mediaFiles = document.getElementById("logMedia").files;
  let photos = [];
  
  if (mediaFiles.length > 0) {
    const formData = new FormData();
    for (let i = 0; i < mediaFiles.length; i++) {
      formData.append("photos", mediaFiles[i]);
    }
    
    try {
      const uploadRes = await fetch(API_BASE + "/upload", {
        method: "POST",
        headers: {
          Authorization: "Bearer " + accessToken
        },
        body: formData
      });
      
      if (uploadRes.ok) {
        const uploadData = await uploadRes.json();
        photos = uploadData.files || [];
      }
    } catch (e) {
      console.error("Napaka pri nalaganju medija:", e);
    }
  }
  
  const mats = (materials || []).filter(m => (m.name && m.name.trim()) || parseFloat(m.qty || "0") > 0);
  
  try {
    const res = await fetch(API_BASE + "/jobs", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + accessToken
      },
      body: JSON.stringify({
        projectId: pid,
        activity: activity,
        hours: hours,
        materials: mats,
        photos: photos
      })
    });
    
    if (!res.ok) throw new Error("Napaka pri shranjevanju");
    
    document.getElementById("logActivity").value = ""; 
    document.getElementById("logHours").value = "";
    document.getElementById("logMedia").value = "";
    materials = []; 
    renderMaterials(); 
    renderJobLogs();
  } catch (e) {
    alert("Napaka: " + e.message);
  }
});

async function renderJobLogs(){
  const wrap=document.getElementById('logList');
  try {
    const res = await fetch(API_BASE + "/jobs", {
      headers: {
        Authorization: "Bearer " + accessToken
      }
    });
    
    if (!res.ok) throw new Error("Napaka pri pridobivanju podatkov");
    
    const logs = await res.json();
    const myLogs = logs.filter(j => j.email === me.email).sort((a,b) => b.ts - a.ts);
    
    if(!myLogs.length){ 
      wrap.innerHTML='<div class="text-center py-4" style="color:var(--muted)"><i class="fas fa-tasks text-2xl mb-2"></i><p>Ni shranjenih vnosov.</p></div>'; 
      return; 
    }
    
    wrap.innerHTML=myLogs.map(j=>`
      <div class="p-3 rounded-lg" style="border:1px solid var(--border);">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="font-medium"><i class="fas fa-folder text-yellow-500 mr-2"></i>${projectName(j.projectId)}</div>
            <div class="mt-1 text-sm">${j.activity} • ${j.employee} • ${j.hours} h</div>
            ${j.materials?.length ? `<div class="mt-2 text-xs" style="color:var(--muted)">Materiali: ${j.materials.map(m=>`${m.name} (${m.qty||0} ${m.uom||''})`).join(', ')}</div>`:''}
            ${j.photos?.length ? `
              <div class="mt-2">
                <div class="text-xs font-semibold mb-1">Mediji:</div>
                <div class="flex flex-wrap gap-2">
                  ${j.photos.map(p => 
                    p.mime.startsWith('image/') ? 
                    `<a href="${API_BASE}${p.url}" target="_blank"><img src="${API_BASE}${p.url}" class="w-16 h-16 object-cover rounded border"></a>` :
                    `<a href="${API_BASE}${p.url}" target="_blank" class="flex items-center justify-center w-16 h-16 bg-gray-100 rounded border"><i class="fas fa-video text-xl"></i></a>`
                  ).join('')}
                </div>
              </div>
            `:''}
          </div>
          <div class="text-xs" style="color:var(--muted)">${new Date(j.ts).toLocaleDateString('sl-SI')}</div>
        </div>
      </div>`).join('');
  } catch (e) {
    wrap.innerHTML='<div class="text-center py-4" style="color:var(--muted)">Napaka pri nalaganju podatkov.</div>';
  }
}

/* ===== Dnevniki ===== */
async function loadDiaries(){
  if (!isManager()) return;
  
  const from = document.getElementById('diaryFrom').value;
  const to = document.getElementById('diaryTo').value;
  const projectId = document.getElementById('diaryProject').value;
  const groupBy = document.getElementById('diaryGroupBy').value;
  
  try {
    // Get jobs data
    let jobsUrl = API_BASE + "/jobs";
    if (from && to) {
      const fromTs = new Date(from).getTime();
      const toTs = new Date(to).getTime() + 86400000 - 1; // End of day
      jobsUrl += `?from=${fromTs}&to=${toTs}`;
      if (projectId) jobsUrl += `&projectId=${projectId}`;
    }
    
    const jobsRes = await fetch(jobsUrl, {
      headers: {
        Authorization: "Bearer " + accessToken
      }
    });
    
    if (!jobsRes.ok) throw new Error("Napaka pri pridobivanju dnevnikov");
    
    const jobs = await jobsRes.json();
    
    // Group data
    const groupedData = {};
    
    jobs.forEach(job => {
      const date = new Date(job.ts);
      let key;
      
      if (groupBy === 'daily') {
        key = date.toLocaleDateString('sl-SI');
      } else if (groupBy === 'monthly') {
        key = `${date.getMonth() + 1}/${date.getFullYear()}`;
      } else {
        key = 'total';
      }
      
      if (!groupedData[key]) {
        groupedData[key] = {
          materials: {},
          hours: 0,
          jobs: []
        };
      }
      
      // Sum hours
      groupedData[key].hours += job.hours;
      
      // Sum materials
      if (job.materials && job.materials.length) {
        job.materials.forEach(mat => {
          const matKey = mat.name + '|' + mat.uom;
          if (!groupedData[key].materials[matKey]) {
            groupedData[key].materials[matKey] = {
              name: mat.name,
              uom: mat.uom,
              qty: 0
            };
          }
          groupedData[key].materials[matKey].qty += parseFloat(mat.qty || 0);
        });
      }
      
      // Add job to list
      groupedData[key].jobs.push(job);
    });
    
    // Render results
    const resultsEl = document.getElementById('diaryResults');
    resultsEl.innerHTML = '';
    
    Object.keys(groupedData).forEach(key => {
      const group = groupedData[key];
      const materialsList = Object.values(group.materials);
      
      const groupEl = document.createElement('div');
      groupEl.className = 'card';
      groupEl.innerHTML = `
        <h3 class="font-semibold mb-2">${groupBy === 'total' ? 'Skupaj' : key}</h3>
        <div class="mb-3">
          <div class="text-sm"><span class="font-medium">Skupaj ur:</span> ${group.hours.toFixed(2)}</div>
          ${materialsList.length ? `
            <div class="text-sm mt-2">
              <div class="font-medium mb-1">Porabljen material:</div>
              <ul class="list-disc list-inside">
                ${materialsList.map(m => `<li>${m.name}: ${m.qty} ${m.uom}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
        <div>
          <div class="font-medium mb-2">Posamezni vnosi:</div>
          <div class="space-y-3">
            ${group.jobs.map(j => `
              <div class="p-3 border rounded-lg">
                <div class="flex justify-between items-start">
                  <div>
                    <div class="font-medium">${projectName(j.projectId)}</div>
                    <div class="text-sm">${j.activity} • ${j.employee} • ${j.hours} h</div>
                    ${j.materials?.length ? `
                      <div class="text-xs mt-1">Materiali: ${j.materials.map(m => `${m.name} (${m.qty} ${m.uom})`).join(', ')}</div>
                    ` : ''}
                    ${j.photos?.length ? `
                      <div class="mt-2">
                        <div class="text-xs font-semibold mb-1">Mediji:</div>
                        <div class="flex flex-wrap gap-1">
                          ${j.photos.map(p => 
                            p.mime.startsWith('image/') ? 
                            `<a href="${API_BASE}${p.url}" target="_blank"><img src="${API_BASE}${p.url}" class="w-12 h-12 object-cover rounded border"></a>` :
                            `<a href="${API_BASE}${p.url}" target="_blank" class="flex items-center justify-center w-12 h-12 bg-gray-100 rounded border"><i class="fas fa-video"></i></a>`
                          ).join('')}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                  <div class="text-xs text-gray-500">${new Date(j.ts).toLocaleDateString('sl-SI')}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      resultsEl.appendChild(groupEl);
    });
    
  } catch (e) {
    document.getElementById('diaryResults').innerHTML = `
      <div class="text-center py-4 text-red-500">
        Napaka pri nalaganju podatkov: ${e.message}
      </div>
    `;
  }
}

// Set default dates for diaries
function setDefaultDiaryDates() {
  const today = new Date();
  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  
  document.getElementById('diaryFrom').value = firstDay.toISOString().split('T')[0];
  document.getElementById('diaryTo').value = lastDay.toISOString().split('T')[0];
}

document.getElementById('diaryRefresh')?.addEventListener('click', loadDiaries);
document.getElementById('diaryExport')?.addEventListener('click', () => {
  alert("Funkcija izvoza bo implementirana v naslednji različici.");
});

/* ===== Poročila (skrajšano) ===== */
function prepareReportFilters(){
  const from = document.getElementById('repFrom');
  const to   = document.getElementById('repTo');
  const now=new Date(); const fm=new Date(now.getFullYear(), now.getMonth(), 1); const tm=new Date(now.getFullYear(), now.getMonth()+1, 0);
  from.value = fm.toISOString().slice(0,10);
  to.value   = tm.toISOString().slice(0,10);
  renderEmployeesFilter();
  document.getElementById('repRefresh')?.addEventListener('click', renderReports);
}
function renderReports(){ /* … obstoječe poročilo … */ }

/* ===================== PLAN: MESEČNI KOLEDAR ===================== */
let calMonth = new Date(); calMonth.setDate(1); // 1. v mesecu
let planMonth = { days:{} }; // { 'YYYY-MM-DD': [ {projectId, people:[email], note} ] }

const calGrid = document.getElementById('calGrid');
document.getElementById('monthPrev')?.addEventListener('click', async ()=>{ calMonth.setMonth(calMonth.getMonth()-1); await loadPlanMonth(); drawCalendar(); });
document.getElementById('monthNext')?.addEventListener('click', async ()=>{ calMonth.setMonth(calMonth.getMonth()+1); await loadPlanMonth(); drawCalendar(); });
document.getElementById('monthToday')?.addEventListener('click', async ()=>{ calMonth = new Date(); calMonth.setDate(1); await loadPlanMonth(); drawCalendar(); });
document.getElementById('planSave')?.addEventListener('click', async ()=>{ if(!isManager()) return alert('Samo Owner/CEO/vodja.'); await savePlanMonth(); });

function ymd(d){ return d.toISOString().slice(0,10); }
function monthStartKey(){ const d=new Date(calMonth); d.setDate(1); return ymd(d); }
function monthLabel(){
  return calMonth.toLocaleDateString('sl-SI',{month:'long',year:'numeric'});
}

async function renderCalendar(){ await loadPlanMonth(); drawCalendar(); }

function drawCalendar(){
  document.getElementById('monthLabel').textContent = monthLabel();
  document.getElementById('planPermNote').textContent = isManager() ? 'Urejanje: Owner, CEO & vodja' : 'Samo ogled';

  // izračun mreže: začni na ponedeljku pred 1. v mesecu
  const first = new Date(calMonth); first.setDate(1); const firstWeekday = (first.getDay()+6)%7; // pon=0
  const start = new Date(first); start.setDate(first.getDate()-firstWeekday);
  const cells = [];
  for(let i=0;i<42;i++){ const d=new Date(start); d.setDate(start.getDate()+i); cells.push(d); } // 6 vrstic

  calGrid.innerHTML = cells.map(d=>{
    const key = ymd(d);
    const inMonth = d.getMonth()===calMonth.getMonth();
    const items = planMonth.days[key]||[];
    const hdr = `
      <div class="cal-day">
        <span>${d.toLocaleDateString('sl-SI',{day:'2-digit'})}</span>
        ${!inMonth ? '<span class="cal-badge" style="background:#eee;color:#666">off</span>' : ''}
      </div>`;

    const list = items.map((it,idx)=>`
      <div class="cal-item">
        <div class="font-semibold">${projects.find(p=>p.id===it.projectId)?.name || '—'}</div>
        <div class="text-[11px]" style="color:var(--muted)">${(it.people||[]).map(e=>usersDir[e]?.name||e).join(', ')||'—'}</div>
        ${it.note?`<div class="text-[11px] italic mt-0.5">${it.note}</div>`:''}
        ${isManager() ? `
          <div class="flex justify-end gap-1 mt-1">
            <button class="btn btn-outline !py-0.5 !px-1.5 text-[11px]" onclick="editPlanItem('${key}',${idx})"><i class="fas fa-pen"></i></button>
            <button class="btn btn-danger !py-0.5 !px-1.5 text-[11px]" onclick="removePlanItem('${key}',${idx})"><i class="fas fa-trash"></i></button>
          </div>` : ``}
      </div>`).join('');

    const addBtn = isManager() && inMonth ? `<button class="btn btn-outline !py-1 !px-2 mt-2" onclick="addPlanItem('${key}')"><i class="fas fa-plus"></i></button>` : '';
    const lockCls = isManager() ? '' : 'cal-locked';
    return `<div class="cal-cell ${lockCls}">${hdr}${list||''}${addBtn}</div>`;
  }).join('');
}

// urejanje – preprosti prompt-i (lahko kasneje zamenjava z modalom)
async function addPlanItem(dayKey){
  const projName = prompt('Projekt (po imenu):', projects[0]?.name || '') || '';
  const proj = projects.find(p=>p.name.toLowerCase()===projName.toLowerCase());
  if(!proj) return alert('Projekt ni najden.');
  const ppl = prompt('Zaposleni (imena ali e-maili, ločeno z vejico):', '') || '';
  const emails = ppl.split(',').map(x=>x.trim()).filter(Boolean).map(x=>{
    const byName = Object.entries(usersDir).find(([e,u])=>(u.name||'').toLowerCase()===x.toLowerCase());
    return byName ? byName[0] : x;
  });
  const note = prompt('Opis / naloge:', '') || '';
  (planMonth.days[dayKey] ||= []).push({ projectId: proj.id, people: emails, note });
  drawCalendar();
}
function editPlanItem(dayKey, idx){
  const it = (planMonth.days[dayKey]||[])[idx]; if(!it) return;
  const pn = projects.find(p=>p.id===it.projectId)?.name || '';
  const newProj = prompt('Projekt:', pn) || pn;
  const proj = projects.find(p=>p.name.toLowerCase()===newProj.toLowerCase()) || projects.find(p=>p.id===it.projectId);
  const ppl = prompt('Zaposleni:', (it.people||[]).map(e=>usersDir[e]?.name||e).join(', ')) || '';
  const emails = ppl.split(',').map(x=>x.trim()).filter(Boolean).map(x=>{
    const byName = Object.entries(usersDir).find(([e,u])=>(u.name||'').toLowerCase()===x.toLowerCase());
    return byName ? byName[0] : x;
  });
  const note = prompt('Opis / naloge:', it.note||'') || '';
  planMonth.days[dayKey][idx] = { projectId: proj.id, people: emails, note };
  drawCalendar();
}
function removePlanItem(dayKey, idx){
  if(!confirm('Odstrani postavko?')) return;
  (planMonth.days[dayKey]||[]).splice(idx,1);
  drawCalendar();
}

// API <-> lokalno
function monthStoreKey(){ return 'workplan:month:'+monthStartKey().slice(0,7); } // YYYY-MM
async function loadPlanMonth(){
  try{
    const q = new URLSearchParams({ start: monthStartKey() }).toString();
    const r = await fetch(API_BASE+'/workplan/month?'+q,{headers:{Authorization:'Bearer '+accessToken}});
    if(r.ok){ planMonth = await r.json(); if(!planMonth.days) planMonth={days:{}}; return; }
  }catch(e){}
  planMonth = JSON.parse(localStorage.getItem(monthStoreKey())||'{"days":{}}');
}
async function savePlanMonth(){
  try{
    const r = await fetch(API_BASE+'/workplan/month',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({ start: monthStartKey(), days: planMonth.days })});
    if(r.ok){ alert('Plan shranjen.'); return; }
  }catch(e){}
  localStorage.setItem(monthStoreKey(), JSON.stringify(planMonth));
  alert('Plan shranjen lokalno (BETA).');
}

// Initialize
setDefaultDiaryDates();
document.getElementById('diaryRefresh')?.addEventListener('click', loadDiaries);
</script>
</body>
</html>

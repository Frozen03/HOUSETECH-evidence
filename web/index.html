<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOUSETECH Ops</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- EXCEL & PDF -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --primary:#3B82F6; --primary-700:#2563EB; --secondary:#10B981; --danger:#EF4444;
      --bg:#F3F4F6; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --border:#E5E7EB;
      --tab-active:#FFFFFF; --tab-inactive:#F3F4F6;
    }
    .dark-mode{
      --bg:#0F172A; --card:#111827; --text:#E5E7EB; --muted:#A1A1AA; --border:#1F2937;
      --tab-active:#111827; --tab-inactive:#1F2937;
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      transition: background .3s, color .3s;
      background-position: center;
      background-repeat: no-repeat;
      background-size: cover;
      background-attachment: fixed;
      background-color: var(--bg);
      background:
        url("../img/logo.png") center/contain no-repeat fixed,
        var(--bg);
    }
    body.dark-mode{
      background:
        linear-gradient(to bottom, rgba(15,23,42,0.90), rgba(15,23,42,0.95)),
        url("../img/housetech-dark.png") center/cover no-repeat fixed;
    }

    .card{ background: var(--card); border:1px solid var(--border); border-radius:1rem; box-shadow: 0 4px 8px rgba(0,0,0,.05); padding:1.25rem; transition:.2s; }
    .btn{ border-radius:.75rem; padding:.6rem 1.1rem; font-weight:600; display:inline-flex; gap:.5rem; align-items:center; }
    .btn-primary{ background:var(--primary); color:#fff; } .btn-primary:hover{ background:var(--primary-700); }
    .btn-outline{ border:1px solid var(--border); color:var(--text); background:transparent; }
    .btn-danger{ background:var(--danger); color:#fff; }

    input, select, textarea{ width:100%; border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:.75rem; padding:.7rem .9rem; transition:.15s; }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.15); }
    textarea{ min-height: 90px; }

    .tab-btn{ padding:.5rem 1rem; font-weight:600; border:1px solid var(--border); transition:.15s; }
    .tab-active{ background:var(--tab-active); }
    .tab-inactive{ background:var(--tab-inactive); color:var(--muted); }
    .tab-btn + .tab-btn{ border-left:none; }
    .tabs-wrap{ border-radius:1rem; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.06); }

    .badge{ padding:.25rem .6rem; border-radius:999px; font-size:.75rem; font-weight:700; }
    .badge-success{ background:#DCFCE7; color:#166534; }
    .dark-mode .badge-success{ background:#166534; color:#DCFCE7; }

    .logo{ font-weight:800; background:linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    .role-pill input{ appearance:none; width:1rem; height:1rem; border-radius:4px; border:1.5px solid var(--border); display:grid; place-items:center; }
    .role-pill input:checked{ background:var(--primary); border-color:var(--primary); }
    .role-pill input:checked::after{ content:'\2713'; color:#fff; font-size:.75rem; line-height:1; }

    .tbl { width:100%; border-collapse: collapse; }
    .tbl th,.tbl td { border:1px solid var(--border); padding:.5rem .6rem; font-size:.875rem; }
    .tbl th { background:var(--tab-inactive); text-align:left; }

    .kpi { background:var(--tab-inactive); border:1px solid var(--border); border-radius:.75rem; padding:.9rem 1rem; }
    .kpi h4 { font-weight:700; font-size:.95rem; margin-bottom:.35rem; }

    .thumb { width:84px; height:84px; object-fit:cover; border-radius:.5rem; border:1px solid var(--border); }
    .chip { display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .55rem; border-radius:999px; font-size:.75rem; border:1px solid var(--border); background:var(--tab-inactive); }
  </style>
</head>
<body>
<div class="max-w-6xl mx-auto py-6 px-4">
  <header class="flex items-start justify-between mb-6">
    <div>
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold flex items-center gap-3"><span class="logo">HOUSETECH</span><span>Ops</span></h1>
        <button id="themeToggle" class="btn btn-outline p-2 !px-3" title="Preklopi temo"><i class="fas fa-moon"></i></button>
      </div>
      <p class="text-sm" style="color:var(--muted)">Prijava z Google</p>
    </div>
    <div><span id="statusBadge" class="badge badge-success hidden"><i class="fas fa-check mr-1"></i>Prijavljen</span></div>
  </header>

  <!-- PRIJAVA -->
  <div id="authCard" class="card mb-6">
    <h2 class="text-lg font-semibold mb-3"><i class="fas fa-right-to-bracket mr-2 text-blue-500"></i>Prijava</h2>
    <p class="text-sm mb-4" style="color:var(--muted)">Prijavi se z Google. Strežnik preveri ID token in izda JWT z vlogami (whitelist).</p>
    <div class="flex items-center gap-3">
      <div id="g_id_signin"></div>
      <button id="signOut" class="btn btn-outline hidden"><i class="fas fa-right-from-bracket"></i> Odjava</button>
    </div>
  </div>

  <!-- TABS -->
  <nav id="tabsNav" class="mb-6 hidden">
    <div class="tabs-wrap inline-flex">
      <button data-tab="time"    class="tab-btn tab-active"><i class="far fa-clock mr-2"></i>Evidenca ur</button>
      <button data-tab="jobs"    class="tab-btn tab-inactive"><i class="far fa-list-alt mr-2"></i>Dnevnik del</button>
<button id="tabBtnPlan"    data-tab="plan"    class="tab-btn tab-inactive hidden">
        <i class="fa-solid fa-calendar-week mr-2"></i>Plan dela <span class="ml-2 text-[10px] px-2 py-[2px] rounded-full border">BETA</span>
      </button>
      <button id="tabBtnReports" data-tab="reports" class="tab-btn tab-inactive"><i class="far fa-chart-bar mr-2"></i>Poročila</button>
      <button id="tabBtnAdmin"   data-tab="admin"   class="tab-btn tab-inactive"><i class="fas fa-user-shield mr-2"></i>Admin</button>
    </div>
  </nav>

  <!-- TIME -->
  <section id="tab-time">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div id="presencePanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-user-clock mr-2 text-blue-500"></i>Registracija prisotnosti</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Projekt</label>
            <select id="currentProject"><option value="">— izberi —</option></select>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="clockIn"  class="btn" style="background:#10B981;color:#fff;"><i class="fas fa-sign-in-alt"></i> Prihod</button>
            <button id="clockOut" class="btn" style="background:#EF4444;color:#fff;"><i class="fas fa-sign-out-alt"></i> Odhod</button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="breakStart" class="btn btn-outline"><i class="fas fa-utensils"></i> Začetek malice</button>
            <button id="breakEnd"   class="btn btn-outline"><i class="fas fa-utensils"></i> Konec malice</button>
          </div>
        </div>
      </div>

      <div id="todayPanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="far fa-calendar-check mr-2 text-blue-500"></i>Današnje registracije</h2>
        <ul id="todayEntries" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <!-- JOBS -->
  <section id="tab-jobs" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div id="jobsProjectsCard" class="card hidden"></div>

      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-tasks mr-2 text-blue-500"></i>Dnevnik del</h2>
        <div class="space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label class="block text-sm font-medium mb-1">Projekt</label><select id="logProject"></select></div>
            <div><label class="block text-sm font-medium mb-1">Aktivnost</label><input id="logActivity" placeholder="npr. Montaža stikal..." /></div>
            <div><label class="block text-sm font-medium mb-1">Ure</label><input id="logHours" type="number" step="0.25" placeholder="npr. 3.5" /></div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Materiali</label>
            <div id="materialsList" class="space-y-2"></div>
            <datalist id="materialsCatalog"></datalist>
            <button id="addMaterialRow" type="button" class="btn btn-outline mt-2"><i class="fas fa-plus"></i> Dodaj material</button>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Fotografije (neobvezno)</label>
            <input id="jobFiles" type="file" accept="image/*" multiple />
            <div id="jobFilesPreview" class="mt-2 flex flex-wrap gap-2"></div>
          </div>

          <div class="flex justify-end"><button id="addLog" class="btn btn-primary"><i class="fas fa-save mr-1"></i> Shrani vnos</button></div>
        </div>

        <hr class="my-4" style="border-color:var(--border)" />
        <h3 class="text-md font-semibold mb-2"><i class="fas fa-history mr-2 text-blue-500"></i>Zgodovina vnosov</h3>
        <div id="logList" class="space-y-3 text-sm max-h-96 overflow-y-auto pr-2"></div>
      </div>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="tab-reports" class="hidden">
    <div class="card">
      <h2 class="text-lg font-semibold mb-3"><i class="fas fa-file-export mr-2 text-blue-500"></i>Poročila</h2>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-3">
        <div><label class="block text-sm font-medium mb-1">Od</label><input type="date" id="repFrom"></div>
        <div><label class="block text-sm font-medium mb-1">Do</label><input type="date" id="repTo"></div>
        <div><label class="block text-sm font-medium mb-1">Projekt</label><select id="repProject"><option value="">Vsi</option></select></div>
        <div><label class="block text-sm font-medium mb-1">Zaposleni</label><select id="repEmployee"><option value="">Vsi</option></select></div>
        <div class="flex items-end gap-2"><button id="repRefresh" class="btn btn-primary w-full"><i class="fas fa-rotate"></i> Osveži</button></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
        <div class="kpi"><h4><i class="fas fa-user-clock mr-2 text-blue-500"></i>Prisotnost — ure po projektih</h4><ul id="kpiPresenceProj"></ul></div>
        <div class="kpi"><h4><i class="fas fa-user mr-2 text-blue-500"></i>Prisotnost — ure po zaposlenih</h4><ul id="kpiPresenceEmp"></ul></div>
        <div class="kpi"><h4><i class="fas fa-diagram-project mr-2 text-blue-500"></i>Dnevnik — ure po projektih</h4><ul id="kpiJobsProj"></ul></div>
        <div class="kpi"><h4><i class="fas fa-people-group mr-2 text-blue-500"></i>Dnevnik — ure po zaposlenih</h4><ul id="kpiJobsEmp"></ul></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <h3 class="font-semibold mb-2">Evidenca prisotnosti (vrstice)</h3>
          <div class="max-h-96 overflow-auto border rounded-lg">
            <table class="tbl"><thead><tr><th>Datum</th><th>Projekt</th><th>Zaposleni</th><th style="width:80px">Ure</th></tr></thead><tbody id="tblPresence"></tbody></table>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Dnevnik del (vrstice)</h3>
          <div class="max-h-96 overflow-auto border rounded-lg">
            <table class="tbl"><thead><tr><th>Datum</th><th>Projekt</th><th>Zaposleni</th><th>Aktivnost</th><th style="width:80px">Ure</th></tr></thead><tbody id="tblJobs"></tbody></table>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mt-4">
        <button id="exportExcel" class="btn btn-primary"><i class="fas fa-file-excel mr-1"></i> Excel (.xlsx)</button>
        <button id="exportPdf"   class="btn btn-outline"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
      </div>

      <hr class="my-6" />

      <!-- Poročilo dnevnikov -->
      <h2 class="text-lg font-semibold mb-3"><i class="fas fa-clipboard-list mr-2 text-blue-500"></i>Poročilo dnevnikov</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="card">
          <h3 class="font-semibold mb-2">Projekti</h3>
          <ul id="diaryProjects" class="space-y-1 text-sm"></ul>
        </div>
        <div class="card lg:col-span-2">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Podrobnosti projekta</h3>
            <div class="flex gap-2 items-center">
              <label class="text-sm">Skupine: </label>
              <select id="diaryGroupBy" class="w-auto">
                <option value="day">po dnevih</option>
                <option value="month">po mesecih</option>
              </select>
              <button id="diaryRefresh" class="btn btn-outline !py-2 !px-3"><i class="fas fa-rotate"></i></button>
            </div>
          </div>
          <div id="diaryDetails" class="mt-3 text-sm" style="color:var(--muted)">Izberi projekt na levi.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- PLAN DELA (BETA) -->
  <section id="tab-plan" class="hidden">
    <div class="card">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">
          <i class="fa-solid fa-calendar-week mr-2 text-blue-500"></i>Plan dela
          <span class="ml-2 text-[10px] px-2 py-[2px] rounded-full border">BETA</span>
        </h2>
        <div class="flex items-center gap-2 text-sm">
          <span id="planWeekLabel" class="font-medium"></span>
          <button id="planToday" class="btn btn-outline !py-1 !px-2"><i class="fa-regular fa-calendar-check"></i> Tekoči teden</button>
        </div>
      </div>

      <!-- vnos -->
      <div id="planEditor" class="mt-4 mb-4 hidden">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
          <div>
            <label class="block text-sm font-medium mb-1">Dan</label>
            <select id="planDay"></select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Zaposleni</label>
            <select id="planEmployee"></select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Projekt</label>
            <select id="planProject"></select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Naloga / opis</label>
            <input id="planActivity" placeholder="npr. Razvod kablov, montaža stikal ..." />
          </div>
        </div>
        <div class="flex justify-end mt-2">
          <button id="planAdd" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Dodaj v plan</button>
        </div>
      </div>

      <!-- mreža tedna -->
      <div id="planGrid" class="mt-2 grid grid-cols-1 md:grid-cols-7 gap-3"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="tab-admin" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-users-cog mr-2 text-blue-500"></i>Uporabniki</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
          <input id="admUserEmail" placeholder="email@domena.si" />
          <input id="admUserName" placeholder="Ime in priimek" />
          <div class="role-group flex flex-wrap gap-2">
            <label class="role-pill" for="roleOwner"><input id="roleOwner" type="checkbox"> Owner</label>
            <label class="role-pill" for="roleCEO"><input id="roleCEO" type="checkbox"> CEO</label>
            <label class="role-pill" for="roleManager"><input id="roleManager" type="checkbox"> vodja</label>
            <label class="role-pill" for="roleEmployee"><input id="roleEmployee" type="checkbox"> zaposlen</label>
            <label class="role-pill" for="roleStudent"><input id="roleStudent" type="checkbox"> študent</label>
          </div>
          <button id="admAddUser" class="btn btn-primary"><i class="fas fa-user-plus"></i> Shrani</button>
        </div>
        <ul id="admUserList" class="space-y-2 text-sm"></ul>
      </div>

      <div class="card">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-sitemap mr-2 text-blue-500"></i>Projekti</h2>
        <div class="grid grid-cols-1 gap-2 mb-3">
          <input id="admProjectName" placeholder="Ime projekta" />
          <input id="admProjectAddress" placeholder="Naslov objekta (opcijsko)" />
          <button id="admAddProject" class="btn btn-primary"><i class="fas fa-plus"></i> Dodaj</button>
        </div>
        <ul id="admProjectList" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <footer class="mt-10 text-xs text-center" style="color:var(--muted)">© 2025 HOUSETECH — final</footer>
</div>

<script>
/* ===== Tema ===== */
const themeToggle = document.getElementById('themeToggle');
const storedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
if (storedTheme === 'dark') { document.body.classList.add('dark-mode'); themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; }
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  const dark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  themeToggle.innerHTML = dark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
});

/* ===== Konfiguracija ===== */
const GOOGLE_CLIENT_ID = "149127907023-ip3jqct2vmqc4tm4jm4bfoogd1pqfpsv.apps.googleusercontent.com";
const API_BASE = "";

let accessToken = localStorage.getItem("jwt") || null;
let me = localStorage.getItem("me") ? JSON.parse(localStorage.getItem("me")) : null;
let usersDir = {}; let projects = []; let materialsCatalog = {};
let materials = []; // dnevnik
let diaryProjectId = null;

/* ===== Helper fetch ===== */
async function api(path, opts = {}) {
  const headers = opts.headers || {};
  if (accessToken) headers.Authorization = "Bearer " + accessToken;
  if (opts.body && !(opts.body instanceof FormData)) headers["Content-Type"] = "application/json";
  const res = await fetch(API_BASE + path, { ...opts, headers });
  if (!res.ok) throw new Error((await res.json().catch(()=>({}))).error || res.statusText);
  return res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text();
}

/* ===== Tabs ===== */
function selectTab(name){
  ["time","jobs","reports","plan","admin"].forEach(t=>{
    document.getElementById("tab-"+t).classList.add("hidden");
    const btn = document.querySelector(`[data-tab="${t}"]`);
    if(btn){ btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); }
  });
  document.getElementById("tab-"+name).classList.remove("hidden");
  const sel = document.querySelector(`[data-tab="${name}"]`);
  if(sel){ sel.classList.add('tab-active'); sel.classList.remove('tab-inactive'); }
  if(name==="jobs"){ renderMaterials(); renderMaterialsCatalogDatalist(); loadJobHistory(); }
  if(name==="reports"){ prepareReportFilters(); renderReports(); renderDiaryProjectsList(); }
  if(name==="admin"){ adminReload(); }
  if(name==="plan"){ initPlanUI(); }
}
document.querySelectorAll(".tab-btn").forEach(btn=>btn.addEventListener("click",()=>selectTab(btn.getAttribute("data-tab"))));

/* ===== Google Sign-In ===== */
async function handleGoogleCredentialResponse(response){
  try{
    const data = await api("/auth/google/verify",{method:"POST", body: JSON.stringify({credential:response.credential})});
    accessToken = data.access_token; me = data.user;
    localStorage.setItem("jwt", accessToken); localStorage.setItem("me", JSON.stringify(me));
    await loadBootstrapData();
    const roles = me?.roles||[];
    const isOwner = roles.includes('Owner');
    const isCEO   = roles.includes('CEO');

    // report tab za boss-e
    document.getElementById('tabBtnReports')?.classList.toggle('hidden', !(isOwner||isCEO));
    // plan BETA: viden SAMO Owner
    document.getElementById('tabBtnPlan')?.classList.toggle('hidden', !isOwner);
    // admin gumb
    document.getElementById('tabBtnAdmin').style.display = (isOwner||isCEO) ? 'inline-block' : 'none';

    showAppAfterLogin(); selectTab('time');
  }catch(e){ alert("Prijava ni uspela: " + e.message); }
}
function initGoogle(){
  if(!(window.google && google.accounts && google.accounts.id)) return false;
  try{
    google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID, callback:handleGoogleCredentialResponse});
    const m = document.getElementById('g_id_signin'); if(m && m.childElementCount===0){ google.accounts.id.renderButton(m,{theme:"outline",size:"large"}); }
    return true;
  }catch{ return false; }
}
window.addEventListener('load', async ()=>{
  let tries=0; const t=setInterval(()=>{ if(initGoogle()||tries++>40) clearInterval(t); },100);
  if(accessToken && me){
    await loadBootstrapData();
if (typeof renderProjects === "function") renderProjects();
    // nastavitev vidnosti gumbov po vlogah ob refreshu
    const roles = me?.roles||[];
    const isOwner = roles.includes('Owner');
    const isCEO   = roles.includes('CEO');
    document.getElementById('tabBtnReports')?.classList.toggle('hidden', !(isOwner||isCEO));
    document.getElementById('tabBtnPlan')?.classList.toggle('hidden', !isOwner);
    document.getElementById('tabBtnAdmin').style.display = (isOwner||isCEO) ? 'inline-block' : 'none';

    showAppAfterLogin(); selectTab('time');
  } else {
    showLoggedOut();
  }
});

/* ===== UI helperji ===== */
function showAppAfterLogin(){
  document.getElementById('g_id_signin')?.classList.add('hidden');
  document.getElementById('signOut')?.classList.remove('hidden');
  document.getElementById('statusBadge')?.classList.remove('hidden');
  document.getElementById('tabsNav')?.classList.remove('hidden');
  document.getElementById('presencePanel')?.classList.remove('hidden');
  document.getElementById('todayPanel')?.classList.remove('hidden');
  loadTodayPresence();
}
function showLoggedOut(){
  document.getElementById('g_id_signin')?.classList.remove('hidden');
  document.getElementById('signOut')?.classList.add('hidden');
  document.getElementById('statusBadge')?.classList.add('hidden');
  document.getElementById('tabsNav')?.classList.add('hidden');
  document.getElementById('presencePanel')?.classList.add('hidden');
  document.getElementById('todayPanel')?.classList.add('hidden');
}
document.getElementById('signOut')?.addEventListener('click', ()=>{
  localStorage.clear(); accessToken=null; me=null; showLoggedOut();
  ["time","jobs","reports","plan","admin"].forEach(t=>document.getElementById("tab-"+t)?.classList.add("hidden"));
});

/* ===== Bootstrap podatki ===== */
function mapMaterialsToCatalog(list){
  const out = {};
  (list || []).forEach(m => { if (m?.name) out[m.name] = { id: m.id, uom: m.uom || "kos" }; });
  return out;
}
async function loadBootstrapData(){
  usersDir = await api("/users").catch(()=>({}));
  projects = await api("/projects").catch(()=>[]);
  const m = await api("/materials").catch(()=>[]);
  materialsCatalog = mapMaterialsToCatalog(m||[]);
  renderProjects(); renderUsersAdmin(); renderProjectsAdmin(); renderMaterialsCatalogDatalist(); renderEmployeesFilter();
}

/* ===== Projekti (helper) ===== */
function projectName(id){ return (projects.find(p=>p.id===id)?.name)||''; }

/* ===== --- (Obstoječ) TIME, JOBS, REPORTS ... ostane nespremenjeno --- ===== */
/* ===== Barve časovnih tipov ===== */
const typeColors = {'prihod':'bg-emerald-500','malica-začetek':'bg-amber-500','malica-konec':'bg-indigo-500','odhod':'bg-rose-500'};
["clockIn","clockOut","breakStart","breakEnd"].forEach(id=>{
  const btn=document.getElementById(id);
  if(btn){ btn.addEventListener('click',()=>{ const map={clockIn:'prihod',clockOut:'odhod',breakStart:'malica-začetek',breakEnd:'malica-konec'}; addTime(map[id]); }); }
});
async function addTime(type){
  if(!me) return alert("Najprej se prijavi.");
  const pid=document.getElementById('currentProject').value||null;
  await api('/time',{method:'POST', body: JSON.stringify({projectId:pid, type})});
  await loadTodayPresence();
}
async function loadTodayPresence(){ const list = await api('/time/today').catch(()=>[]); renderToday(list); }
async function deleteTimeEntry(id){ if(!confirm("Odstranim vnos?")) return; await api('/time/'+encodeURIComponent(id),{method:'DELETE'}).catch(e=>alert(e.message)); await loadTodayPresence(); }
function renderToday(entries){
  const ul=document.getElementById('todayEntries');
  if(!entries?.length){ ul.innerHTML='<li class="text-center py-4" style="color:var(--muted)"><i class="far fa-clock text-2xl mb-2"></i><p>Ni vnosov za danes.</p></li>'; return; }
  ul.innerHTML=entries.sort((a,b)=>a.ts-b.ts).map(e=>{
    const color=typeColors[e.type]||'bg-slate-500'; const canDel = e.email===me?.email;
    return `<li class="entry-item p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);">
      <div class="flex items-center gap-3">
        <span class="inline-block w-2 h-2 rounded-full ${color}"></span>
        <div>
          <div class="font-medium">${e.type} ob ${new Date(e.ts).toLocaleTimeString('sl-SI',{hour:'2-digit',minute:'2-digit'})}</div>
          <div class="text-xs" style="color:var(--muted)">${e.employee||e.email} • ${projectName(e.projectId)||"Brez projekta"}</div>
        </div>
      </div>
      ${canDel ? `<button class="entry-delete btn btn-outline !py-1 !px-2 text-xs" onclick="deleteTimeEntry('${e.id}')"><i class="fas fa-trash"></i></button>` : ``}
    </li>`;
  }).join('');
}

/* ===== DNEVNIK (del kode: materiali/slike/shrani/zgodovina) ===== */
function renderMaterialsCatalogDatalist(){
  const dl=document.getElementById('materialsCatalog'); if(!dl) return;
  const entries=Object.entries(materialsCatalog).sort((a,b)=>a[0].localeCompare(b[0]));
  dl.innerHTML=entries.map(([name,info])=>`<option value="${name}" data-uom="${info.uom||'kos'}"></option>`).join('');
}
function renderMaterials(){
  const wrap=document.getElementById('materialsList'); if(!wrap) return;
  if(materials.length===0) materials.push({name:'',qty:'',uom:'kos'});
  wrap.innerHTML=materials.map((m,idx)=>`
    <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
      <input list="materialsCatalog" class="md:col-span-6" placeholder="Material (npr. NYM-J 3x1,5)"
             value="${m.name||''}" oninput="onMatNameInput(${idx}, this.value)"/>
      <input type="number" step="0.01" class="md:col-span-3" placeholder="Količina"
             value="${m.qty||''}" oninput="materials[${idx}].qty=this.value"/>
      <select class="md:col-span-2" onchange="materials[${idx}].uom=this.value">
        <option value="kos" ${m.uom==='kos'?'selected':''}>kos</option>
        <option value="m"   ${m.uom==='m'?'selected':''}>m</option>
        <option value="kpl" ${m.uom==='kpl'?'selected':''}>kpl</option>
        <option value="h"   ${m.uom==='h'?'selected':''}>h</option>
      </select>
      <button type="button" class="md:col-span-1 btn btn-outline !py-2 !px-3" onclick="materials.splice(${idx},1); renderMaterials();"><i class="fas fa-times"></i></button>
    </div>`).join('');
  renderMaterialsCatalogDatalist();
}
window.onMatNameInput=(idx,val)=>{
  materials[idx].name=val;
  const info=materialsCatalog[val];
  if(info && info.uom){ materials[idx].uom=info.uom; renderMaterials(); }
};
document.getElementById('addMaterialRow')?.addEventListener('click',()=>{ materials.push({name:'',qty:'',uom:'kos'}); renderMaterials(); });

async function ensureMaterialOnServer(name, uom) {
  const key = String(name || "").trim(); if (!key) return null;
  const mat = await api("/materials", { method:"POST", body: JSON.stringify({ name: key, uom: uom || "kos" }) });
  materialsCatalog[mat.name] = { id: mat.id, uom: mat.uom || "kos" }; renderMaterialsCatalogDatalist(); return materialsCatalog[mat.name];
}
const fileInput = document.getElementById('jobFiles'); const filePreview = document.getElementById('jobFilesPreview');
if (fileInput) fileInput.addEventListener('change', ()=>{ filePreview.innerHTML=''; [...fileInput.files].forEach(f=>{ const url = URL.createObjectURL(f); const img=new Image(); img.src=url; img.className='thumb'; filePreview.appendChild(img); }); });
async function uploadImages(files){
  if(!files || !files.length) return []; const fd = new FormData();
  [...files].forEach(f=>fd.append('files[]', f, f.name));
  const res = await fetch(API_BASE + '/upload', { method:'POST', headers:{Authorization:'Bearer '+accessToken}, body: fd });
  if(!res.ok) throw new Error('Nalaganje slik ni uspelo'); const data = await res.json(); return (data.files||[]).map(f=>f.url);
}
document.getElementById("addLog")?.addEventListener("click", async ()=>{
  if (!me) return alert("Najprej se prijavi.");
  const pid = document.getElementById("logProject").value; const activity = document.getElementById("logActivity").value.trim();
  const hours = parseFloat(document.getElementById("logHours").value || "0");
  if (!pid || !activity || !hours) return alert("Izpolni: projekt, aktivnost, ure.");
  const mats = (materials || []).filter(m => (m.name && m.name.trim()) || parseFloat(m.qty || "0") > 0).map(m=>({name:m.name.trim(), qty: Number(m.qty||0), uom: m.uom||'kos'}));
  for (const m of mats) { try { await ensureMaterialOnServer(m.name, m.uom || "kos"); } catch(e){} }
  let images = []; if (fileInput?.files?.length) { images = await uploadImages(fileInput.files); }
  await api('/jobs',{method:'POST', body: JSON.stringify({ projectId: pid, activity, hours, materials: mats, images })});
  document.getElementById("logActivity").value = ""; document.getElementById("logHours").value = ""; materials = []; renderMaterials();
  if (fileInput){ fileInput.value=''; filePreview.innerHTML=''; } await loadJobHistory();
});
async function loadJobHistory(){
  const now=new Date(); const from=new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
  const to  =new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999).toISOString();
  const logs = await api(`/jobs?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`).catch(()=>[]);
  renderJobLogs(logs);
}
function renderJobLogs(list){
  const wrap=document.getElementById('logList');
  if(!list?.length){ wrap.innerHTML='<div class="text-center py-4" style="color:var(--muted)"><i class="fas fa-tasks text-2xl mb-2"></i><p>Ni shranjenih vnosov.</p></div>'; return; }
  wrap.innerHTML=list.slice().reverse().map(j=>`
    <div class="entry-item p-3 rounded-lg" style="border:1px solid var(--border);">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <div class="font-medium"><i class="fas fa-folder text-yellow-500 mr-2"></i>${projectName(j.projectId)}</div>
          <div class="mt-1 text-sm">${j.activity} • ${j.employee||j.email} • ${(+j.hours||0)} h</div>
          ${Array.isArray(j.materials) && j.materials.length ? `<div class="mt-2 flex flex-wrap gap-2">${j.materials.map(m=>`<span class="chip">${m.name} <b>${m.qty||0} ${m.uom||''}</b></span>`).join('')}</div>`:''}
          ${Array.isArray(j.images) && j.images.length ? `<div class="mt-2 flex flex-wrap gap-2">${j.images.map(u=>`<a href="${u}" target="_blank"><img class="thumb" src="${u}"/></a>`).join('')}</div>`:''}
        </div>
        <div class="text-xs" style="color:var(--muted)">${new Date(j.ts||Date.now()).toLocaleDateString('sl-SI')}</div>
      </div>
    </div>`).join('');
}

/* ===== Poročila (obstoječe funkcije) – zaradi prostora izpuščam komentarje ===== */
function summarize(rows, by){ const map = {}; rows.forEach(r=>{ const key = r[by] || '—'; map[key] = (map[key]||0) + Number(r.hours||r.sumHours||0); }); return Object.entries(map).map(([k,v])=>({ key:k, hours:+v.toFixed(2) })).sort((a,b)=>b.hours-a.hours); }
function prepareReportFilters(){ const from = document.getElementById('repFrom'); const to   = document.getElementById('repTo'); const now=new Date(); const fm=new Date(now.getFullYear(), now.getMonth(), 1); const tm=new Date(now.getFullYear(), now.getMonth()+1, 0); from.value = fm.toISOString().slice(0,10); to.value   = tm.toISOString().slice(0,10); renderEmployeesFilter(); document.getElementById('repRefresh')?.addEventListener('click', renderReports); }
function getReportFilters(){ const from = new Date(document.getElementById('repFrom').value || '1970-01-01'); from.setHours(0,0,0,0); const to   = new Date(document.getElementById('repTo').value || '2999-12-31');  to.setHours(23,59,59,999); const proj = document.getElementById('repProject').value || ''; const emp  = document.getElementById('repEmployee').value || ''; return { from, to, proj, emp }; }
function renderKpi(list, mountId){ const ul=document.getElementById(mountId); if(!ul) return; if(!list.length){ ul.innerHTML='<li><span>—</span><span>0</span></li>'; return; } ul.innerHTML=list.map(i=>`<li><span>${i.key||'—'}</span><span>${(+i.hours).toFixed(2)}</span></li>`).join(''); }
function renderTable(rows, mountId, cols){ const tb = document.getElementById(mountId); if(!tb) return; tb.innerHTML = rows.map(r=>`<tr>${cols.map(c=>`<td>${c(r)}</td>`).join('')}</tr>`).join('') || `<tr><td colspan="5" style="color:var(--muted);text-align:center">Ni podatkov.</td></tr>`; }
async function fetchPresence(from,to,proj,emp){
  const qs = new URLSearchParams(); if(from) qs.set('from', from.toISOString()); if(to) qs.set('to', to.toISOString()); if(proj) qs.set('projectId', proj); if(emp)  qs.set('email', emp);
  const list = await api(`/time?${qs.toString()}`).catch(()=>[]); const grouped = {}; list.sort((a,b)=>a.ts-b.ts).forEach(e=>{ const d=new Date(e.ts); d.setHours(0,0,0,0); const key = `${d.getTime()}|${e.email}|${e.projectId||''}`; (grouped[key] ||= []).push(e); });
  const rows=[]; for(const key of Object.keys(grouped)){ const [dayTs,email,projId]=key.split('|'); const date=new Date(+dayTs); let workStart=null, breakStart=null, breakMs=0, totalMs=0; for(const ev of grouped[key]){ if (ev.type==='prihod') { workStart = ev.ts; breakStart=null; breakMs=0; } else if (ev.type==='malica-začetek' && workStart && !breakStart){ breakStart = ev.ts; } else if (ev.type==='malica-konec' && breakStart){ breakMs += (ev.ts - breakStart); breakStart=null; } else if (ev.type==='odhod' && workStart){ totalMs += Math.max(0, (ev.ts - workStart) - breakMs); workStart=null; breakStart=null; breakMs=0; } } const hours=+(totalMs/36e5).toFixed(2); if(hours>0) rows.push({ date, dateStr: date.toLocaleDateString('sl-SI'), projectId: projId, project: projectName(projId), employeeEmail: email, employee: usersDir[email]?.name||email, hours }); }
  return rows;
}
async function fetchJobRows(from,to,proj,emp){
  const qs=new URLSearchParams(); if(from) qs.set('from', from.toISOString()); if(to) qs.set('to', to.toISOString()); if(proj) qs.set('projectId', proj); if(emp)  qs.set('email', emp);
  const list = await api(`/jobs?${qs.toString()}`).catch(()=>[]); return list.map(j=>({ date: new Date(j.ts), dateStr: new Date(j.ts).toLocaleDateString('sl-SI'), projectId: j.projectId, project: projectName(j.projectId), employeeEmail: j.email, employee: j.employee || usersDir[j.email]?.name || j.email, activity: j.activity, hours: +(+j.hours||0).toFixed(2) }));
}
async function renderReports(){
  const filters = getReportFilters();
  const presence = await fetchPresence(filters.from,filters.to,filters.proj,filters.emp);
  const logs     = await fetchJobRows(filters.from,filters.to,filters.proj,filters.emp);
  renderKpi(summarize(presence, 'project'), 'kpiPresenceProj');
  renderKpi(summarize(presence, 'employee'), 'kpiPresenceEmp');
  renderKpi(summarize(logs, 'project'), 'kpiJobsProj');
  renderKpi(summarize(logs, 'employee'), 'kpiJobsEmp');
  renderTable(presence, 'tblPresence', [ r=>r.dateStr, r=>r.project||'—', r=>r.employee, r=>r.hours ]);
  renderTable(logs, 'tblJobs', [ r=>r.dateStr, r=>r.project||'—', r=>r.employee, r=>r.activity||'—', r=>r.hours ]);
  window.__filteredPresence = presence; window.__filteredLogs = logs;
}

/* ===== Poročilo dnevnikov (projekti -> podrobnosti) ===== */
function renderDiaryProjectsList(){
  const ul=document.getElementById('diaryProjects'); if(!ul) return;
  ul.innerHTML = (projects||[]).map(p=>`
    <li><button class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"
      onclick="openDiaryProject('${p.id}')">
      <div class="font-medium">${p.name}</div>
      ${p.address?`<div class="text-xs" style="color:var(--muted)">${p.address}</div>`:''}
    </button></li>
  `).join('') || `<li style="color:var(--muted)">Ni projektov.</li>`;
}
async function openDiaryProject(pid){ diaryProjectId = pid; await refreshDiaryDetails(); }
function fmtMonth(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function groupByDay(ts){ const d=new Date(ts); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
async function refreshDiaryDetails(){
  const mount=document.getElementById('diaryDetails'); if(!mount) return;
  if(!diaryProjectId){ mount.innerHTML = '<div style="color:var(--muted)">Izberi projekt.</div>'; return; }
  const groupBy = document.getElementById('diaryGroupBy')?.value || 'day';
  const logs = await api(`/jobs?projectId=${encodeURIComponent(diaryProjectId)}`).catch(()=>[]);
  const matRows = []; logs.forEach(j=>{ (j.materials||[]).forEach(m=>{ matRows.push({ ts:j.ts, day: groupByDay(j.ts), month: fmtMonth(new Date(j.ts)), name:m.name, qty: Number(m.qty||0), uom: m.uom||'kos' }); }); });
  const byKey = (row)=> groupBy==='month' ? row.month : row.day; const matAgg = {};
  matRows.forEach(r=>{ const key = `${byKey(r)}|${r.name}|${r.uom}`; matAgg[key] = (matAgg[key]||0) + (r.qty||0); });
  const matView = Object.entries(matAgg).map(([k,qty])=>{ const [grp,name,uom] = k.split('|'); return { group:grp, name, uom, qty:+qty.toFixed(2) }; }).sort((a,b)=> a.group.localeCompare(b.group) || a.name.localeCompare(b.name));
  const acts = {}; logs.forEach(j=>{ const g = groupByDay(j.ts); (acts[g] ||= []).push(j); }); const allImages = logs.flatMap(j=> j.images||[]);
  mount.innerHTML = `
    <div class="mb-2"><div class="text-sm" style="color:var(--muted)">Projekt</div><div class="text-lg font-semibold">${projectName(diaryProjectId)}</div></div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div>
        <h4 class="font-semibold mb-2">Porabljen material (${groupBy==='month'?'po mesecih':'po dnevih'})</h4>
        <div class="max-h-80 overflow-auto border rounded-lg">
          <table class="tbl"><thead><tr><th>${groupBy==='month'?'Mesec':'Datum'}</th><th>Material</th><th style="width:90px">Količina</th></tr></thead>
          <tbody>${matView.map(r=>`<tr><td>${r.group}</td><td>${r.name} (${r.uom})</td><td>${r.qty}</td></tr>`).join('') || `<tr><td colspan="3" style="color:var(--muted);text-align:center">Ni materialov.</td></tr>`}</tbody></table>
        </div>
      </div>
      <div>
        <h4 class="font-semibold mb-2">Aktivnosti (po dnevih)</h4>
        <div class="space-y-2 max-h-80 overflow-auto">
          ${Object.keys(acts).sort().map(d=>`
            <div class="p-3 rounded-lg border">
              <div class="font-medium mb-1">${new Date(d).toLocaleDateString('sl-SI')}</div>
              <ul class="list-disc ml-5">${acts[d].map(j=>`<li>${j.activity} — ${j.employee||j.email} (${(+j.hours||0)} h)</li>`).join('')}</ul>
            </div>`).join('') || `<div style="color:var(--muted)">Ni aktivnosti.</div>`}
        </div>
      </div>
    </div>
    <div class="mt-4"><h4 class="font-semibold mb-2">Fotografije</h4>
      <div class="flex flex-wrap gap-2">${allImages.length ? allImages.map(u=>`<a href="${u}" target="_blank"><img class="thumb" src="${u}" loading="lazy"/></a>`).join('') : `<div style="color:var(--muted)">Ni slik.</div>`}</div>
    </div>
  `;
}
document.getElementById('diaryGroupBy')?.addEventListener('change', refreshDiaryDetails);
document.getElementById('diaryRefresh')?.addEventListener('click', refreshDiaryDetails);
window.openDiaryProject = openDiaryProject;

/* ===== PLAN DELA (BETA) ===== */
function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; } // ponedeljek
function endOfWeek(d){ const s=startOfWeek(d); const e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
function fmtISO(d){ return new Date(d).toISOString(); }
function fmtDate(d){ return new Date(d).toLocaleDateString('sl-SI'); }
function dayLabel(d){ return new Date(d).toLocaleDateString('sl-SI', {weekday:'short', day:'2-digit', month:'2-digit'}); }

async function initPlanUI(){
  // dovoljenja
  const roles=me?.roles||[]; const isOwner=roles.includes('Owner'); const isCEO=roles.includes('CEO');
  // editor je viden Owner ali CEO (čeprav tab vidijo samo Owner)
  document.getElementById('planEditor')?.classList.toggle('hidden', !(isOwner||isCEO));

  // napolni selecte
  const selEmp=document.getElementById('planEmployee'); const selProj=document.getElementById('planProject'); const selDay=document.getElementById('planDay');
  if(selEmp){ selEmp.innerHTML = Object.entries(usersDir).map(([email,u])=>`<option value="${email}">${u.name||email}</option>`).join(''); }
  if(selProj){ selProj.innerHTML = projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }

  // tekoči teden dnevi
  const s = startOfWeek(new Date()); const days=[];
  for(let i=0;i<7;i++){ const d=new Date(s); d.setDate(s.getDate()+i); days.push(d); }
  if(selDay){ selDay.innerHTML = days.map(d=>`<option value="${d.toISOString()}">${dayLabel(d)}</option>`).join(''); }

  document.getElementById('planWeekLabel').textContent = `${fmtDate(days[0])} – ${fmtDate(days[6])}`;
  document.getElementById('planToday')?.addEventListener('click', ()=>selectTab('plan'));

  // naloži in nariši grid
  await loadPlanWeek(s, endOfWeek(s));
  document.getElementById('planAdd')?.addEventListener('click', addPlanItem);
}

async function loadPlanWeek(from, to){
  const qs = new URLSearchParams({ from: fmtISO(from), to: fmtISO(to) });
  const items = await api(`/plan?${qs}`).catch(()=>[]);
  renderPlanGrid(items, from);
}

function humanName(email){ return usersDir[email]?.name || email; }

function renderPlanGrid(items, weekStart){
  const grid = document.getElementById('planGrid'); if(!grid) return;
  const roles=me?.roles||[]; const canEdit = roles.includes('Owner') || roles.includes('CEO');

  const days=[]; for(let i=0;i<7;i++){ const d=new Date(weekStart); d.setDate(weekStart.getDate()+i); days.push(d); }
  const byDay = {}; items.forEach(it=>{ const k = new Date(it.date); k.setHours(0,0,0,0); const key=k.toISOString(); (byDay[key] ||= []).push(it); });

  grid.innerHTML = days.map(d=>{
    const key=d; key.setHours(0,0,0,0); const list = byDay[key.toISOString()]||[];
    return `<div class="card">
      <div class="font-semibold mb-2">${dayLabel(d)}</div>
      <ul class="space-y-2">
        ${list.map(it=>`
          <li class="p-2 rounded border flex items-start justify-between">
            <div class="min-w-0">
              <div class="font-medium truncate">${humanName(it.employeeEmail)} → ${projectName(it.projectId)}</div>
              <div class="text-sm" style="color:var(--muted)">${it.activity||''}</div>
            </div>
            ${canEdit ? `<button class="btn btn-outline !py-1 !px-2 text-xs" onclick="deletePlanItem('${it.id}')"><i class="fa-solid fa-trash"></i></button>`:''}
          </li>
        `).join('') || `<li class="text-sm" style="color:var(--muted)">Ni plana.</li>`}
      </ul>
    </div>`;
  }).join('');
}

async function addPlanItem(){
  const dateISO = document.getElementById('planDay').value;
  const employeeEmail = document.getElementById('planEmployee').value;
  const projectId = document.getElementById('planProject').value;
  const activity = document.getElementById('planActivity').value.trim();
  if(!dateISO || !employeeEmail || !projectId || !activity) return alert('Izpolni vse podatke.');

  await api('/plan',{method:'POST', body: JSON.stringify({ date: dateISO, employeeEmail, projectId, activity })});
  document.getElementById('planActivity').value='';
  const s = startOfWeek(new Date(dateISO));
  await loadPlanWeek(s, endOfWeek(s));
}

async function deletePlanItem(id){
  if(!confirm('Odstranim postavko?')) return;
  await api('/plan/'+encodeURIComponent(id), { method:'DELETE' }).catch(e=>alert(e.message));
  const s = startOfWeek(new Date());
  await loadPlanWeek(s, endOfWeek(s));
}

/* ===== Admin (obstoječe) ===== */
function renderUsersAdmin(){ const ul=document.getElementById('admUserList'); if(!ul) return; const entries=Object.entries(usersDir).sort((a,b)=>(a[1].name||a[0]).localeCompare(b[1].name||b[0])); ul.innerHTML=entries.map(([email,u])=>`<li class="entry-item p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);"><div class="min-w-0"><div class="font-medium truncate"><i class="fas fa-user mr-2 text-blue-500"></i>${u.name||email}<span style="color:var(--muted)">•</span> <span style="color:var(--muted)">${email}</span></div><div class="text-xs" style="color:var(--muted)">Vloge: ${(u.roles||[]).join(', ')||'—'}</div></div><div class="flex gap-2"><button class="btn btn-outline text-xs" onclick="admEditUser('${email}')"><i class="fas fa-pen"></i> Uredi</button><button class="btn btn-danger text-xs" onclick="admDelUser('${email}')"><i class="fas fa-trash"></i> Izbriši</button></div></li>`).join('') || `<li class="text-center" style="color:var(--muted)">Ni uporabnikov.</li>`; }
function admEditUser(email){ const u=usersDir[email]||{}; document.getElementById('admUserEmail').value=email; document.getElementById('admUserName').value=u.name||''; document.getElementById('roleOwner').checked   =(u.roles||[]).includes('Owner'); document.getElementById('roleCEO').checked     =(u.roles||[]).includes('CEO'); document.getElementById('roleManager').checked =(u.roles||[]).includes('vodja'); document.getElementById('roleEmployee').checked=(u.roles||[]).includes('zaposlen'); document.getElementById('roleStudent').checked =(u.roles||[]).includes('študent'); }
document.getElementById('admAddUser')?.addEventListener('click', async ()=>{ const roles=me?.roles||[]; const isBoss=roles.includes('Owner')||roles.includes('CEO'); if(!isBoss) return alert('Samo Owner/CEO'); const email=document.getElementById('admUserEmail').value.trim().toLowerCase(); const name =document.getElementById('admUserName').value.trim(); if(!email||!name) return alert('Vnesi email in ime'); const rx=[]; if(document.getElementById('roleOwner').checked)rx.push('Owner'); if(document.getElementById('roleCEO').checked)rx.push('CEO'); if(document.getElementById('roleManager').checked)rx.push('vodja'); if(document.getElementById('roleEmployee').checked)rx.push('zaposlen'); if(document.getElementById('roleStudent').checked)rx.push('študent'); await api('/users',{method:'POST',body:JSON.stringify({email,name})}).catch(()=>{}); await api('/users/'+encodeURIComponent(email),{method:'PATCH',body:JSON.stringify({name,roles:rx})}); await adminReload(); document.getElementById('admUserEmail').value=''; document.getElementById('admUserName').value=''; ['roleOwner','roleCEO','roleManager','roleEmployee','roleStudent'].forEach(id=>document.getElementById(id).checked=false); });
async function admDelUser(email){ const isBoss=(me?.roles||[]).includes('Owner')||(me?.roles||[]).includes('CEO'); if(!isBoss) return alert('Samo Owner/CEO'); if(!confirm('Res izbrišem uporabnika '+email+'?')) return; await api('/users/'+encodeURIComponent(email),{method:'DELETE'}).catch(e=>alert(e.message)); await adminReload(); }
function renderProjectsAdmin(){ const ul=document.getElementById('admProjectList'); if(!ul) return; ul.innerHTML=(projects||[]).map(p=>`<li class="entry-item p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);"><div class="min-w-0"><div class="font-medium truncate"><i class="fas fa-folder text-yellow-500 mr-2"></i>${p.name}</div>${p.address ? `<div class="text-xs" style="color:var(--muted)}">${p.address}</div>`:``}</div><button class="btn btn-outline text-xs" onclick="admDelProject('${p.id}')"><i class="fas fa-trash"></i> Izbriši</button></li>`).join('') || `<li class="text-center" style="color:var(--muted)">Ni projektov.</li>`; }
document.getElementById('admAddProject')?.addEventListener('click', async ()=>{ const isBoss=(me?.roles||[]).includes('Owner')||(me?.roles||[]).includes('CEO'); if(!isBoss) return alert('Samo Owner/CEO'); const name=document.getElementById('admProjectName').value.trim(); const address=document.getElementById('admProjectAddress').value.trim(); if(!name) return; await api('/projects',{method:'POST',body:JSON.stringify({name,address})}); document.getElementById('admProjectName').value=''; document.getElementById('admProjectAddress').value=''; await adminReload(); });
async function admDelProject(id){ if(!confirm('Izbrišem projekt?')) return; await api('/projects/'+encodeURIComponent(id),{method:'DELETE'}).catch(e=>alert(e.message)); await adminReload(); }
async function adminReload(){ usersDir = await api("/users").catch(()=>({})); projects = await api("/projects").catch(()=>[]); const m = await api("/materials").catch(()=>[]); materialsCatalog = mapMaterialsToCatalog(m||[]); renderUsersAdmin(); renderProjectsAdmin(); renderProjects(); renderMaterialsCatalogDatalist(); renderEmployeesFilter(); }

/* ===== konec skript ===== */
</script>
</body>
</html>

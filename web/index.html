<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOUSETECH Ops</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- EXCEL & PDF -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --primary:#3B82F6; --primary-700:#2563EB; --secondary:#10B981; --danger:#EF4444;
      --bg:#F3F4F6; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --border:#E5E7EB;
      --tab-active:#FFFFFF; --tab-inactive:#F3F4F6;
    }
    .dark-mode{
      --bg:#0F172A; --card:#111827; --text:#E5E7EB; --muted:#A1A1AA; --border:#1F2937;
      --tab-active:#111827; --tab-inactive:#1F2937;
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      transition: background .3s, color .3s;
      background:
        url("../img/logo.png") center/contain no-repeat fixed,
        var(--bg);
    }
    body.dark-mode{
      background:
        linear-gradient(to bottom, rgba(15,23,42,0.9), rgba(15,23,42,0.95)),
        url("../img/housetech-dark.png") center/cover no-repeat fixed;
    }

    .card{ background: var(--card); border:1px solid var(--border); border-radius:1rem; box-shadow: 0 4px 8px rgba(0,0,0,.05); padding:1.25rem; }
    .btn{ border-radius:.75rem; padding:.6rem 1.1rem; font-weight:600; display:inline-flex; gap:.5rem; align-items:center; }
    .btn-primary{ background:var(--primary); color:#fff; } .btn-primary:hover{ background:var(--primary-700); }
    .btn-outline{ border:1px solid var(--border); color:var(--text); background:transparent; }
    .btn-danger{ background:var(--danger); color:#fff; }

    .logo { font-weight:800; background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    input, select, textarea{ width:100%; border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:.75rem; padding:.7rem .9rem; }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.15); }

    .tab-btn{ padding:.5rem 1rem; font-weight:600; border:1px solid var(--border); }
    .tab-active{ background:var(--tab-active); }
    .tab-inactive{ background:var(--tab-inactive); color:var(--muted); }
    .tab-btn + .tab-btn{ border-left:none; }
    .tabs-wrap{ border-radius:1rem; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.06); }

    .tbl { width:100%; border-collapse: collapse; }
    .tbl th,.tbl td { border:1px solid var(--border); padding:.5rem .6rem; font-size:.875rem; }
    .tbl th { background:var(--tab-inactive); text-align:left; }

    /* Koledar */
    .cal-grid{ display:grid; grid-template-columns: repeat(7,minmax(0,1fr)); gap:.5rem; }
    .daycell{ border:1px solid var(--border); border-radius:.75rem; padding:.75rem; min-height:130px; background:var(--card); display:flex; flex-direction:column; }
    .cal-locked{ opacity:.6; pointer-events:none; }
    .task{ border:1px dashed var(--border); border-radius:.5rem; padding:.25rem .35rem; font-size:.8rem; margin-top:.25rem; background:var(--tab-inactive); }
    .drag-over{ outline:2px dashed var(--primary); }

    /* barve statusov */
    .cal-done{ background:#DCFCE7; border-color:#86EFAC; color:#065F46; }
    .dark-mode .cal-done{ background:#052e16; border-color:#14532d; color:#86efac; }
    .cal-progress{ background:#FFFBEB; border-color:#FDE68A; color:#713F12; }
    .dark-mode .cal-progress{ background:#3a2d00; border-color:#a16207; color:#fde68a; }

    /* Responsive */
    #tabsNav{ position:sticky; top:0; z-index:40; padding:.25rem 0; background:rgba(0,0,0,0.02); }
    .dark-mode #tabsNav{ background:rgba(0,0,0,0.25); }
    .tabs-wrap{ display:flex; overflow:auto; -webkit-overflow-scrolling:touch; gap:.5rem; padding:.25rem; }
    .tab-btn{ border-radius:.75rem; }
    .btn{ min-height:44px; }
    select, input, textarea{ min-height:44px; }

    @media (max-width: 1024px){ .cal-grid{ grid-template-columns: repeat(4, minmax(0,1fr)); } }
    @media (max-width: 768px){  .cal-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width: 640px){  .cal-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } .daycell{ min-height:150px; } }
  </style>
</head>
<body>
<div class="max-w-6xl mx-auto py-6 px-4">
  <header class="flex items-start justify-between mb-6">
    <div>
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold flex items-center gap-3"><span class="logo">HOUSETECH</span><span>Ops</span></h1>
        <button id="themeToggle" class="btn btn-outline p-2 !px-3" title="Preklopi temo"><i class="fas fa-moon"></i></button>
      </div>
      <p class="text-sm" style="color:var(--muted)">Prijava z Google</p>
    </div>
    <div><span id="statusBadge" class="badge bg-green-100 text-green-700 rounded-full px-2 py-0.5 hidden"><i class="fas fa-check mr-1"></i>Prijavljen</span></div>
  </header>

  <!-- PRIJAVA -->
  <div id="authCard" class="card mb-6">
    <h2 class="text-lg font-semibold mb-3"><i class="fas fa-right-to-bracket mr-2 text-blue-500"></i>Prijava</h2>
    <p class="text-sm mb-4" style="color:var(--muted)">Prijavi se z Google. Strežnik preveri ID token in izda JWT z vlogami (whitelist).</p>
    <div class="flex items-center gap-3">
      <div id="g_id_onload"
           data-client_id="149127907023-ip3jqct2vmqc4tm4jm4bfoogd1pqfpsv.apps.googleusercontent.com"
           data-callback="handleGoogleCredentialResponse"
           data-auto_prompt="false"></div>
      <div id="g_id_signin" class="g_id_signin"
           data-type="standard" data-size="large" data-shape="rectangular"
           data-theme="outline" data-text="signin_with" data-logo_alignment="left"></div>

      <button id="signOut" class="btn btn-outline hidden"><i class="fas fa-right-from-bracket"></i> Odjava</button>
    </div>
  </div>

  <!-- TABS -->
  <nav id="tabsNav" class="mb-6 hidden">
    <div class="tabs-wrap inline-flex">
      <button data-tab="time" class="tab-btn tab-active"><i class="far fa-clock mr-2"></i>Evidenca ur</button>
      <button id="tabBtnPlan" data-tab="plan" class="tab-btn tab-inactive hidden"><i class="fas fa-calendar-alt mr-2"></i>Plan dela</button>
      <button data-tab="jobs" class="tab-btn tab-inactive"><i class="far fa-list-alt mr-2"></i>Dnevnik del</button>
      <button id="tabBtnJournals" data-tab="journals" class="tab-btn tab-inactive hidden"><i class="fas fa-book-open mr-2"></i>Dnevniki</button>
      <button id="tabBtnReports" data-tab="reports" class="tab-btn tab-inactive"><i class="far fa-chart-bar mr-2"></i>Poročila</button>
      <button id="tabBtnAdmin" data-tab="admin" class="tab-btn tab-inactive"><i class="fas fa-user-shield mr-2"></i>Admin</button>
    </div>
  </nav>

  <!-- ===== Evidenca ur (skrajšano) ===== -->
  <section id="tab-time">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div id="presencePanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-user-clock mr-2 text-blue-500"></i>Registracija prisotnosti</h2>
        <div class="space-y-3">
          <div><label class="block text-sm font-medium mb-1">Projekt</label><select id="currentProject"><option value="">— izberi —</option></select></div>
          <div class="grid grid-cols-2 gap-2">
            <button id="clockIn"  class="btn" style="background:#10B981;color:#fff;"><i class="fas fa-sign-in-alt"></i> Prihod</button>
            <button id="clockOut" class="btn" style="background:#EF4444;color:#fff;"><i class="fas fa-sign-out-alt"></i> Odhod</button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="breakStart" class="btn btn-outline"><i class="fas fa-utensils"></i> Začetek malice</button>
            <button id="breakEnd"   class="btn btn-outline"><i class="fas fa-utensils"></i> Konec malice</button>
          </div>
        </div>
      </div>

      <div id="todayPanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="far fa-calendar-check mr-2 text-blue-500"></i>Današnje registracije</h2>
        <ul id="todayEntries" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <!-- ===== PLAN DELA ===== -->
  <section id="tab-plan" class="hidden">
    <!-- Mesečni pogled -->
    <div id="plan-month-wrap" class="card hidden">
      <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
        <div class="flex flex-wrap items-center gap-2">
          <button id="monthPrev" class="btn btn-outline"><i class="fa-solid fa-chevron-left"></i> Prejšnji mesec</button>
          <button id="monthToday" class="btn btn-outline">Danes</button>
          <button id="monthNext" class="btn btn-outline">Naslednji mesec <i class="fa-solid fa-chevron-right"></i></button>
        </div>
        <div id="monthLabel" class="text-lg font-semibold"></div>
      </div>

      <!-- Filtri + KPI -->
      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <div class="card p-3">
          <div class="text-sm" style="color:var(--muted)">Okno</div>
          <div id="weekWindow" class="font-medium"></div>
        </div>
        <div class="card p-3 flex items-center gap-2 flex-wrap plan-filters">
          <span class="text-sm" style="color:var(--muted)">Kategorije:</span>
          <button class="chip active" data-cat="Vse">Vse</button>
          <button class="chip" data-cat="KNX">KNX</button>
          <button class="chip" data-cat="AJAX">AJAX</button>
          <button class="chip" data-cat="Shelly">Shelly</button>
          <button class="chip" data-cat="General">Splošno</button>
        </div>
        <div class="card p-3">
          <div class="grid grid-cols-2 gap-2 text-center">
            <div><div class="text-xs" style="color:var(--muted)">Skupno</div><div id="statTotal" class="text-2xl font-bold">0</div></div>
            <div><div class="text-xs" style="color:var(--muted)">Opravljenih</div><div id="statDone" class="text-2xl font-bold">0</div></div>
          </div>
        </div>
      </div>

      <!-- Glava dni -->
      <div class="grid grid-cols-7 gap-3 mb-2 text-xs font-semibold" style="color:var(--muted)">
        <div>Pon</div><div>Tor</div><div>Sre</div><div>Čet</div><div>Pet</div><div>Sob</div><div>Ned</div>
      </div>

      <div id="calendar" class="cal-grid mb-3"></div>

      <div class="flex justify-end gap-2">
        <button id="newProjectBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Nova naloga</button>
      </div>
    </div>

    <!-- Tedenski pogled (za zaposlene/študente) -->
    <div id="plan-week-wrap" class="card hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold"><i class="fas fa-calendar-week mr-2 text-blue-500"></i>Tedenski plan (Pon–Sob)</h3>
        <div class="flex gap-2">
          <button id="weekPrev" class="btn btn-outline !py-1"><i class="fas fa-chevron-left"></i></button>
          <div id="weekLabel" class="min-w-[180px] text-center font-medium"></div>
          <button id="weekNext" class="btn btn-outline !py-1"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2" id="weekGrid"></div>
    </div>
  </section>

  <!-- ===== PLAN MODAL ===== -->
  <div id="planModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
    <div class="card w-[95%] max-w-xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 id="modalTitle" class="text-lg font-semibold">Nova naloga</h3>
        <button id="closeModal" class="w-8 h-8 grid place-items-center rounded-md border"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="taskForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs" style="color:var(--muted)">Datum</label>
          <input type="date" id="taskDate" required />
        </div>
        <div>
          <label class="text-xs" style="color:var(--muted)">Čas (od–do)</label>
          <input type="text" id="taskTime" placeholder="08:00-12:00" />
        </div>
        <div class="md:col-span-2">
          <label class="text-xs" style="color:var(--muted)">Naslov</label>
          <input type="text" id="taskTitle" placeholder="Opis naloge" required />
        </div>
        <div>
          <label class="text-xs" style="color:var(--muted)">Kategorija</label>
          <select id="taskCategory">
            <option>General</option>
            <option>KNX</option>
            <option>AJAX</option>
            <option>Shelly</option>
          </select>
        </div>
        <div>
          <label class="text-xs" style="color:var(--muted)">Status</label>
          <select id="taskStatus">
            <option>V teku</option>
            <option>Opravljeno</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs" style="color:var(--muted)">Opombe</label>
          <textarea id="taskNotes" rows="3" placeholder="Dodatni detajli, materiali, ekipa..."></textarea>
        </div>
        <div class="md:col-span-2 flex items-center justify-between pt-2">
          <button type="button" id="deleteTask" class="btn btn-outline hidden text-red-600 border-red-300"><i class="fa-solid fa-trash"></i> Izbriši</button>
          <div class="flex gap-2">
            <button type="button" id="cancelModal" class="btn btn-outline">Prekliči</button>
            <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Shrani</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Preostali zavihki (skrajšani – ostanejo) ===== -->
  <section id="tab-jobs" class="hidden"><div class="card">…</div></section>
  <section id="tab-journals" class="hidden"><div class="card">…</div></section>
  <section id="tab-reports" class="hidden"><div class="card">…</div></section>
  <section id="tab-admin" class="hidden"><div class="card">…</div></section>

  <footer class="mt-10 text-xs text-center" style="color:var(--muted)">© 2025 HOUSETECH — final</footer>
</div>

<script>
/* ===== Tema ===== */
const themeToggle = document.getElementById('themeToggle');
const storedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
if (storedTheme === 'dark') { document.body.classList.add('dark-mode'); themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; }
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  const dark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  themeToggle.innerHTML = dark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
});

/* ===== Konfiguracija ===== */
const GOOGLE_CLIENT_ID = "149127907023-ip3jqct2vmqc4tm4jm4bfoogd1pqfpsv.apps.googleusercontent.com";
const API_BASE = ""; // isti origin

let accessToken = localStorage.getItem("jwt") || null;
let me = localStorage.getItem("me") ? JSON.parse(localStorage.getItem("me")) : null;
let usersDir = {}; let projects = [];

const isOwnerOrCeo     = () => (me?.roles||[]).some(r => r==='Owner' || r==='CEO');
const isOwnerCeoVodja  = () => (me?.roles||[]).some(r => r==='Owner' || r==='CEO' || r==='vodja');
const isEmployeeOrStudent = () => (me?.roles||[]).some(r => r==='zaposlen' || r==='študent');
const canEdit = () => isOwnerCeoVodja();

/* ===== Tabs ===== */
function selectTab(name){
  ["time","plan","jobs","journals","reports","admin"].forEach(t=>{
    document.getElementById("tab-"+t).classList.add("hidden");
    const btn = document.querySelector(`[data-tab="${t}"]`);
    if(btn){ btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); }
  });
  document.getElementById("tab-"+name).classList.remove("hidden");
  const sel = document.querySelector(`[data-tab="${name}"]`);
  if(sel){ sel.classList.add('tab-active'); sel.classList.remove('tab-inactive'); }
  if(name==="plan"){ renderPlan(); }
}
document.querySelectorAll(".tab-btn").forEach(btn=>btn.addEventListener("click",()=>selectTab(btn.getAttribute("data-tab"))));

/* ===== Google Sign-In ===== */
async function handleGoogleCredentialResponse(response){
  try{
    if(!response?.credential) return alert("Prijava ni uspela (ni credentiala).");
    const res = await fetch("/auth/google/verify",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ credential: response.credential }) });
    if(!res.ok){ const e=await res.json().catch(()=>({})); throw new Error(e.error||"Neuspešna verifikacija"); }
    const data = await res.json();
    accessToken = data.access_token; me = data.user;
    localStorage.setItem("jwt", accessToken); localStorage.setItem("me", JSON.stringify(me));
    applyRoleUI(); showAppAfterLogin(); selectTab('plan');
  }catch(e){ alert("Prijava ni uspela: "+e.message); }
}
function initGoogle(){
  if(!(window.google?.accounts?.id)) return false;
  try{
    google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID, callback:handleGoogleCredentialResponse});
    google.accounts.id.renderButton(document.getElementById('g_id_signin'),{theme:"outline",size:"large"});
    return true;
  }catch{ return false; }
}
window.addEventListener('load', ()=>{
  let tries=0; const t=setInterval(()=>{ if(initGoogle()||tries++>40) clearInterval(t); },100);
  if(accessToken && me){ applyRoleUI(); showAppAfterLogin(); }
  else { showLoggedOut(); }
});

/* ===== UI helperji ===== */
function applyRoleUI(){
  const roles = (me?.roles)||[];
  const isOwner = roles.includes('Owner');
  const isCEO   = roles.includes('CEO');
  const isVodja = roles.includes('vodja');
  const isMgr   = isOwner || isCEO || isVodja;
  const isEmp   = roles.includes('zaposlen') || roles.includes('študent');

  document.getElementById('tabBtnReports')?.classList.toggle('hidden', !(isOwner||isCEO));
  document.getElementById('tabBtnAdmin')?.classList.toggle('hidden', !(isOwner||isCEO));
  document.getElementById('tabBtnPlan')?.classList.toggle('hidden', !(isMgr||isEmp));
  document.getElementById('tabBtnJournals')?.classList.toggle('hidden', !isMgr);

  document.getElementById('plan-month-wrap')?.classList.toggle('hidden', !isMgr);
  document.getElementById('plan-week-wrap')?.classList.toggle('hidden', !isEmp);
}
function showAppAfterLogin(){
  document.getElementById('g_id_signin')?.classList.add('hidden');
  document.getElementById('signOut')?.classList.remove('hidden');
  document.getElementById('statusBadge')?.classList.remove('hidden');
  document.getElementById('tabsNav')?.classList.remove('hidden');
}
function showLoggedOut(){
  document.getElementById('g_id_signin')?.classList.remove('hidden');
  document.getElementById('signOut')?.classList.add('hidden');
  document.getElementById('statusBadge')?.classList.add('hidden');
  document.getElementById('tabsNav')?.classList.add('hidden');
}
document.getElementById('signOut')?.addEventListener('click', ()=>{ localStorage.clear(); accessToken=null; me=null; showLoggedOut(); });

/* ===================== KOLEDAR (LOCAL STORAGE) ===================== */
const state = { viewDate: new Date(), filter:'all', editingId:null };
const LS_KEY='ht_tasks_v1';

function startOfMonth(d){ const x=new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
function endOfMonth(d){ const x=new Date(d.getFullYear(), d.getMonth()+1, 0); x.setHours(23,59,59,999); return x; }
function isoDate(d){ return d.toISOString().slice(0,10); }
function fmtMonth(d){ return d.toLocaleDateString('sl-SI',{month:'long', year:'numeric'}); }
function weekRangeOfMonth(d){
  const s=startOfMonth(d), e=endOfMonth(d);
  const firstMonday=new Date(s); const day=(s.getDay()+6)%7; firstMonday.setDate(s.getDate()-day);
  const lastSunday=new Date(e); const day2=(e.getDay()+6)%7; lastSunday.setDate(e.getDate()+(6-day2));
  return `${firstMonday.getDate()}. ${firstMonday.getMonth()+1}. – ${lastSunday.getDate()}. ${lastSunday.getMonth()+1}.`;
}
function loadTasks(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch{ return []} }
function saveTasks(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
function genId(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

const calEl = document.getElementById('calendar');
const monthLabel = document.getElementById('monthLabel');
const weekWindow = document.getElementById('weekWindow');

function renderPlan(){
  // mesečni / tedenski prikaz se vklopi že v applyRoleUI
  renderCalendar();
}
async function renderCalendar(){
  monthLabel.textContent = fmtMonth(state.viewDate);
  weekWindow.textContent = weekRangeOfMonth(state.viewDate);

  const tasks = loadTasks();
  const s = startOfMonth(state.viewDate), e = endOfMonth(state.viewDate);

  // leading blanks from Monday
  const firstDow = (s.getDay()+6)%7; // 0=Mon
  const cells = [];
  for(let i=0;i<firstDow;i++) cells.push(null);
  for(let d=1; d<=e.getDate(); d++) cells.push(new Date(s.getFullYear(), s.getMonth(), d));

  const header = ['Pon','Tor','Sre','Čet','Pet','Sob','Ned']
    .map(d=>`<div class="text-xs font-semibold text-center" style="color:var(--muted)">${d}</div>`).join('');

  calEl.innerHTML = header + cells.map(date=> buildCell(date, tasks)).join('');

  if(canEdit()){
    document.querySelectorAll('[data-dropdate]').forEach(el=>{
      el.addEventListener('dragover', ev=>{ ev.preventDefault(); el.classList.add('drag-over');});
      el.addEventListener('dragleave', ()=> el.classList.remove('drag-over'));
      el.addEventListener('drop', ev=>{
        ev.preventDefault(); el.classList.remove('drag-over');
        const id = ev.dataTransfer.getData('text/plain');
        const all=loadTasks(); const i=all.findIndex(t=>t.id===id);
        if(i>-1){ all[i].date = el.getAttribute('data-dropdate'); saveTasks(all); renderCalendar(); }
      });
    });
  }
  updateStats(tasks);
}
function buildCell(date, tasks){
  if(!date) return `<div></div>`;
  const todayIso = isoDate(new Date());
  const dateIso = isoDate(date);
  const inFilter = (t)=> state.filter==='all' || t.category===state.filter;
  const dayTasks = tasks.filter(t=>t.date===dateIso && inFilter(t));

  const items = dayTasks.map(t=>{
    const doneIcon = t.status==='Opravljeno'? 'fa-circle-check text-green-600' : 'fa-circle-dot';
    const draggable = canEdit()? `draggable="true" ondragstart="onDragStart(event, '${t.id}')"` : '';
    return `<div class="task ${t.status==='Opravljeno'?'cal-done':'cal-progress'}" ${draggable}>
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="flex items-center gap-2">
            <span class="text-[10px] px-2 py-[2px] rounded-full border">${t.category}</span>
            <span class="text-[11px]" style="color:var(--muted)">${t.time||''}</span>
          </div>
          <div class="truncate font-medium">${escapeHtml(t.title)}</div>
          ${t.notes?`<div class="text-[11px] italic truncate" style="color:var(--muted)">${escapeHtml(t.notes)}</div>`:''}
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <i class="fa-solid ${doneIcon}"></i>
          ${canEdit()?`<button class="opacity-70 hover:opacity-100" onclick="openEdit('${t.id}')"><i class='fa-solid fa-pen-to-square'></i></button>`:''}
        </div>
      </div>
    </div>`;
  }).join('');

  const addBtn = canEdit()? `<button class="mt-2 w-full text-xs border rounded-lg py-1 hover:bg-black/5" onclick="openNew('${dateIso}')"><i class='fa-solid fa-plus'></i> Dodaj</button>` : '';
  const lockCls = canEdit() ? '' : 'cal-locked';

  return `<div class="daycell ${lockCls}" data-dropdate="${dateIso}">
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold">${date.getDate()}.</div>
      <div class="text-xs" style="color:var(--muted)">${date.toLocaleDateString('sl-SI',{weekday:'short'})}</div>
    </div>
    <div>${items || `<div class='text-xs italic' style="color:var(--muted)">Ni nalog</div>`}</div>
    ${addBtn}
  </div>`;
}
function updateStats(tasks){
  document.getElementById('statTotal').textContent = tasks.length;
  document.getElementById('statDone').textContent  = tasks.filter(t=>t.status==='Opravljeno').length;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }
window.onDragStart = (ev, id)=>{ ev.dataTransfer.setData('text/plain', id); };

/* Navigacija + filtri */
document.getElementById('monthPrev')?.addEventListener('click', ()=>{ state.viewDate.setMonth(state.viewDate.getMonth()-1); renderCalendar(); });
document.getElementById('monthNext')?.addEventListener('click', ()=>{ state.viewDate.setMonth(state.viewDate.getMonth()+1); renderCalendar(); });
document.getElementById('monthToday')?.addEventListener('click', ()=>{ state.viewDate = new Date(); renderCalendar(); });
document.querySelectorAll('.plan-filters .chip').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.plan-filters .chip').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    const v = btn.getAttribute('data-cat'); state.filter = (v==='Vse')?'all':v;
    renderCalendar();
  });
});
document.getElementById('newProjectBtn')?.addEventListener('click', ()=> openNew(isoDate(new Date())));

/* Modal */
const modal = document.getElementById('planModal');
const form = document.getElementById('taskForm');
const deleteBtn = document.getElementById('deleteTask');
const modalTitle = document.getElementById('modalTitle');
const dateInput = document.getElementById('taskDate');
const timeInput = document.getElementById('taskTime');
const titleInput = document.getElementById('taskTitle');
const catSelect = document.getElementById('taskCategory');
const statusSelect = document.getElementById('taskStatus');
const notesInput = document.getElementById('taskNotes');

function showModal(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
function hideModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
document.getElementById('closeModal')?.addEventListener('click', hideModal);
document.getElementById('cancelModal')?.addEventListener('click', hideModal);

function openNew(dateIso){
  if(!canEdit()) return;
  state.editingId = null;
  modalTitle.textContent = 'Nova naloga';
  deleteBtn.classList.add('hidden');
  form.reset();
  dateInput.value = dateIso || isoDate(new Date());
  showModal();
}
window.openNew = openNew;

function openEdit(id){
  if(!canEdit()) return;
  const all = loadTasks();
  const t = all.find(x=>x.id===id); if(!t) return;
  state.editingId = id;
  modalTitle.textContent = 'Uredi nalogo';
  deleteBtn.classList.remove('hidden');
  dateInput.value = t.date; timeInput.value=t.time||''; titleInput.value=t.title;
  catSelect.value=t.category; statusSelect.value=t.status; notesInput.value=t.notes||'';
  showModal();
}
window.openEdit = openEdit;

deleteBtn.addEventListener('click',()=>{
  if(!state.editingId) return;
  const all = loadTasks();
  const i = all.findIndex(t=>t.id===state.editingId);
  if(i>-1){ all.splice(i,1); saveTasks(all); renderCalendar(); }
  hideModal();
});
form.addEventListener('submit', (e)=>{
  e.preventDefault();
  const payload = {
    id: state.editingId || (Math.random().toString(36).slice(2)+Date.now().toString(36)),
    date: dateInput.value,
    time: timeInput.value.trim(),
    title: titleInput.value.trim(),
    category: catSelect.value,
    status: statusSelect.value,
    notes: notesInput.value.trim()
  };
  const all = loadTasks();
  const i = all.findIndex(t=>t.id===payload.id);
  if(i>-1) all[i]=payload; else all.push(payload);
  saveTasks(all); renderCalendar(); hideModal();
});

/* Po prijavi prikaži plan */
function afterLoginInit(){
  document.getElementById('tabBtnPlan')?.classList.remove('hidden');
  applyRoleUI();
  selectTab('plan');
  renderCalendar();
}
function showLoggedInUI(){ /* placeholder */ }

</script>
</body>
</html>

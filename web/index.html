<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOUSETECH Ops</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- EXCEL & PDF -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --primary:#3B82F6; --primary-700:#2563EB; --secondary:#10B981; --danger:#EF4444;
      --bg:#F3F4F6; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --border:#E5E7EB;
      --tab-active:#FFFFFF; --tab-inactive:#F3F4F6;
    }
    .dark-mode{
      --bg:#0F172A; --card:#111827; --text:#E5E7EB; --muted:#A1A1AA; --border:#1F2937;
      --tab-active:#111827; --tab-inactive:#1F2937;
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      transition: background .3s, color .3s;
      background:
        url("../img/logo.png") center/contain no-repeat fixed,
        var(--bg);
    }
    body.dark-mode{
      background:
        linear-gradient(to bottom, rgba(15,23,42,0.9), rgba(15,23,42,0.95)),
        url("../img/housetech-dark.png") center/cover no-repeat fixed;
    }

    .card{ background: var(--card); border:1px solid var(--border); border-radius:1rem; box-shadow: 0 4px 8px rgba(0,0,0,.05); padding:1.25rem; }
    .btn{ border-radius:.75rem; padding:.6rem 1.1rem; font-weight:600; display:inline-flex; gap:.5rem; align-items:center; }
    .btn-primary{ background:var(--primary); color:#fff; } .btn-primary:hover{ background:var(--primary-700); }
    .btn-outline{ border:1px solid var(--border); color:var(--text); background:transparent; }
    .btn-danger{ background:var(--danger); color:#fff; }
    input, select, textarea{ width:100%; border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:.75rem; padding:.7rem .9rem; }
    input:focus, select:focus, textarea:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.15); }

    .tab-btn{ padding:.5rem 1rem; font-weight:600; border:1px solid var(--border); }
    .tab-active{ background:var(--tab-active); }
    .tab-inactive{ background:var(--tab-inactive); color:var(--muted); }
    .tab-btn + .tab-btn{ border-left:none; }
    .tabs-wrap{ border-radius:1rem; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.06); }

    /* PLAN: koledar */
    .cal-grid{ display:grid; grid-template-columns: repeat(7,minmax(0,1fr)); gap:.5rem; }
    .cal-cell{ border:1px solid var(--border); border-radius:.75rem; padding:.5rem; min-height:130px; background:var(--card); display:flex; flex-direction:column; }
    .cal-day{ font-size:.85rem; font-weight:700; color:var(--muted); display:flex; align-items:center; justify-content:space-between; }
    .cal-item{ border-left:3px solid var(--primary); background:var(--tab-inactive); border-radius:.5rem; padding:.25rem .35rem; font-size:.8rem; margin-top:.25rem; }
    .today-outline{ outline:2px solid var(--primary); outline-offset:0; border-radius:.75rem; }
    .prio-high{ border-left-color:#EF4444; }
    .prio-med{ border-left-color:#F59E0B; }
    .prio-low{ border-left-color:#10B981; }
    .drag-over{ outline:2px dashed var(--primary); }
  </style>
</head>
<body>
<div class="max-w-6xl mx-auto py-6 px-4">
  <header class="flex items-start justify-between mb-6">
    <div>
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold flex items-center gap-3"><span class="logo" style="background:linear-gradient(90deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent">HOUSETECH</span><span>Ops</span></h1>
        <button id="themeToggle" class="btn btn-outline p-2 !px-3" title="Preklopi temo"><i class="fas fa-moon"></i></button>
      </div>
      <p class="text-sm" style="color:var(--muted)">Prijava z Google</p>
    </div>
    <div><span id="statusBadge" class="rounded-full px-2 py-0.5 bg-green-100 text-green-700 hidden"><i class="fas fa-check mr-1"></i>Prijavljen</span></div>
  </header>

  <!-- PRIJAVA -->
  <div id="authCard" class="card mb-6">
    <h2 class="text-lg font-semibold mb-3"><i class="fas fa-right-to-bracket mr-2 text-blue-500"></i>Prijava</h2>
    <p class="text-sm mb-4" style="color:var(--muted)">Prijavi se z Google. Strežnik preveri ID token in izda JWT z vlogami (whitelist).</p>
    <div class="flex items-center gap-3">
      <div id="g_id_signin"></div>
      <button id="signOut" class="btn btn-outline hidden"><i class="fas fa-right-from-bracket"></i> Odjava</button>
    </div>
  </div>

  <!-- TABS -->
  <nav id="tabsNav" class="mb-6 hidden">
    <div class="tabs-wrap inline-flex">
      <button data-tab="time" class="tab-btn tab-active"><i class="far fa-clock mr-2"></i>Evidenca ur</button>

      <!-- NOVI PANEL: Plan -->
      <button id="tabBtnPlan" data-tab="plan" class="tab-btn tab-inactive"><i class="fas fa-calendar-alt mr-2"></i>Mesečni plan</button>

      <button data-tab="jobs" class="tab-btn tab-inactive"><i class="far fa-list-alt mr-2"></i>Dnevnik del</button>
      <button id="tabBtnReports" data-tab="reports" class="tab-btn tab-inactive"><i class="far fa-chart-bar mr-2"></i>Poročila</button>
      <button id="tabBtnAdmin" data-tab="admin" class="tab-btn tab-inactive"><i class="fas fa-user-shield mr-2"></i>Admin</button>
    </div>
  </nav>

  <!-- ===== Evidenca ur (ni spreminjana) ===== -->
  <section id="tab-time">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div id="presencePanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-user-clock mr-2 text-blue-500"></i>Registracija prisotnosti</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Projekt</label>
            <select id="currentProject"><option value="">— izberi —</option></select>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="clockIn"  class="btn" style="background:#10B981;color:#fff;"><i class="fas fa-sign-in-alt"></i> Prihod</button>
            <button id="clockOut" class="btn" style="background:#EF4444;color:#fff;"><i class="fas fa-sign-out-alt"></i> Odhod</button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="breakStart" class="btn btn-outline"><i class="fas fa-utensils"></i> Začetek malice</button>
            <button id="breakEnd"   class="btn btn-outline"><i class="fas fa-utensils"></i> Konec malice</button>
          </div>
        </div>
      </div>

      <div id="todayPanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="far fa-calendar-check mr-2 text-blue-500"></i>Današnje registracije</h2>
        <ul id="todayEntries" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <!-- ===== PLAN DELA ===== -->
  <section id="tab-plan" class="hidden">
    <div class="card">
      <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
        <div class="flex items-center gap-2">
          <button id="planPrev" class="btn btn-outline !py-1"><i class="fas fa-chevron-left"></i></button>
          <div id="planTitle" class="font-semibold text-lg min-w-[220px] text-center"></div>
          <button id="planNext" class="btn btn-outline !py-1"><i class="fas fa-chevron-right"></i></button>
          <button id="planToday" class="btn btn-outline !py-1"><i class="fas fa-dot-circle"></i> Danes</button>
        </div>
        <div id="planRights" class="text-sm" style="color:var(--muted)"></div>
        <div class="hidden md:block text-xs" style="color:var(--muted)">BETA — shrani se lokalno</div>
      </div>

      <!-- glave dni -->
      <div id="planWeekHeader" class="grid grid-cols-7 gap-2 text-xs font-semibold mb-1" style="color:var(--muted)">
        <div>Pon</div><div>Tor</div><div>Sre</div><div>Čet</div><div>Pet</div><div>Sob</div><div>Ned</div>
      </div>

      <!-- mreža za mesečni ali tedenski pogled -->
      <div id="planGrid" class="cal-grid"></div>

      <div class="flex justify-end gap-2 mt-3">
        <button id="planAddQuick" class="btn btn-outline"><i class="fas fa-plus"></i> Dodaj v današnji dan</button>
      </div>
    </div>
  </section>

  <!-- ===== Dnevnik del ===== -->
  <section id="tab-jobs" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div id="jobsProjectsCard" class="card hidden"></div>
      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-tasks mr-2 text-blue-500"></i>Dnevnik del</h2>
        <div class="space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label class="block text-sm font-medium mb-1">Projekt</label><select id="logProject"></select></div>
            <div><label class="block text-sm font-medium mb-1">Aktivnost</label><input id="logActivity" placeholder="npr. Montaža stikal..." /></div>
            <div><label class="block text-sm font-medium mb-1">Ure</label><input id="logHours" type="number" step="0.25" placeholder="npr. 3.5" /></div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Materiali</label>
            <div id="materialsList" class="space-y-2"></div>
            <datalist id="materialsCatalog"></datalist>
            <button id="addMaterialRow" type="button" class="btn btn-outline mt-2"><i class="fas fa-plus"></i> Dodaj material</button>
          </div>

          <div class="flex justify-end"><button id="addLog" class="btn btn-primary"><i class="fas fa-save mr-1"></i> Shrani vnos</button></div>
        </div>

        <hr class="my-4" style="border-color:var(--border)" />
        <h3 class="text-md font-semibold mb-2"><i class="fas fa-history mr-2 text-blue-500"></i>Zgodovina vnosov</h3>
        <div id="logList" class="space-y-3 text-sm max-h-96 overflow-y-auto pr-2"></div>
      </div>
    </div>
  </section>

  <!-- ===== Poročila (skrajšano) ===== -->
  <section id="tab-reports" class="hidden">
    <div class="card">
      <h2 class="text-lg font-semibold mb-3"><i class="fas fa-file-export mr-2 text-blue-500"></i>Poročila</h2>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-3">
        <div><label class="block text-sm font-medium mb-1">Od</label><input type="date" id="repFrom"></div>
        <div><label class="block text-sm font-medium mb-1">Do</label><input type="date" id="repTo"></div>
        <div><label class="block text-sm font-medium mb-1">Projekt</label><select id="repProject"><option value="">Vsi</option></select></div>
        <div><label class="block text-sm font-medium mb-1">Zaposleni</label><select id="repEmployee"><option value="">Vsi</option></select></div>
        <div class="flex items-end gap-2"><button id="repRefresh" class="btn btn-primary w-full"><i class="fas fa-rotate"></i> Osveži</button></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <h3 class="font-semibold mb-2">Evidenca prisotnosti (vrstice)</h3>
          <div class="max-h-96 overflow-auto border rounded-lg">
            <table class="tbl">
              <thead><tr><th>Datum</th><th>Projekt</th><th>Zaposleni</th><th style="width:80px">Ure</th></tr></thead>
              <tbody id="tblPresence"></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Dnevnik del (vrstice)</h3>
          <div class="max-h-96 overflow-auto border rounded-lg">
            <table class="tbl">
              <thead><tr><th>Datum</th><th>Projekt</th><th>Zaposleni</th><th>Aktivnost</th><th style="width:80px">Ure</th></tr></thead>
              <tbody id="tblJobs"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Admin (skrajšano) ===== -->
  <section id="tab-admin" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-users-cog mr-2 text-blue-500"></i>Uporabniki</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
          <input id="admUserEmail" placeholder="email@domena.si" />
          <input id="admUserName" placeholder="Ime in priimek" />
          <div class="flex flex-wrap gap-2 text-sm">
            <label><input id="roleOwner" type="checkbox" class="mr-1">Owner</label>
            <label><input id="roleCEO" type="checkbox" class="mr-1">CEO</label>
            <label><input id="roleManager" type="checkbox" class="mr-1">vodja</label>
            <label><input id="roleEmployee" type="checkbox" class="mr-1">zaposlen</label>
            <label><input id="roleStudent" type="checkbox" class="mr-1">študent</label>
          </div>
          <button id="admAddUser" class="btn btn-primary"><i class="fas fa-user-plus"></i> Shrani</button>
        </div>
        <ul id="admUserList" class="space-y-2 text-sm"></ul>
      </div>

      <div class="card">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-sitemap mr-2 text-blue-500"></i>Projekti</h2>
        <div class="flex gap-2 mb-3">
          <input id="admProjectName" class="flex-1" placeholder="Dodaj nov projekt" />
          <button id="admAddProject" class="btn btn-primary"><i class="fas fa-plus"></i></button>
        </div>
        <ul id="admProjectList" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <footer class="mt-10 text-xs text-center" style="color:var(--muted)">© 2025 HOUSETECH — final</footer>
</div>

<script>
/* ===== Tema ===== */
const themeToggle = document.getElementById('themeToggle');
const storedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
if (storedTheme === 'dark') { document.body.classList.add('dark-mode'); themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; }
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  const dark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  themeToggle.innerHTML = dark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
});

/* ===== Konfiguracija ===== */
const GOOGLE_CLIENT_ID = "149127907023-ip3jqct2vmqc4tm4jm4bfoogd1pqfpsv.apps.googleusercontent.com";
const API_BASE = "";

// Fake-role override za test (ne vpliva na JWT): localStorage.setItem('ht_fake_role','Vodja')
function myRoles(){ 
  const jwtRoles = (me?.roles)||[];
  const f = localStorage.getItem('ht_fake_role');
  return f ? [f] : jwtRoles;
}
const any = (arr,roles)=>arr.some(r=>roles.includes(r));
const canEditPlan = ()=> any(myRoles(), ['Owner','CEO','vodja']);
const canSeeMonth = ()=> any(myRoles(), ['Owner','CEO','vodja']);
const canSeeWeek  = ()=> !canSeeMonth(); // zaposleni + študent
const canMarkDone = ()=> any(myRoles(), ['zaposlen','študent']) && !canEditPlan();

let accessToken = localStorage.getItem("jwt") || null;
let me = localStorage.getItem("me") ? JSON.parse(localStorage.getItem("me")) : null;
let usersDir = {}; let projects = [];
let materialsCatalog = {}; let materials = [];

/* ===== Tabs ===== */
function selectTab(name){
  ["time","plan","jobs","reports","admin"].forEach(t=>{
    document.getElementById("tab-"+t).classList.add("hidden");
    const btn = document.querySelector(`[data-tab="${t}"]`);
    if(btn){ btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); }
  });
  document.getElementById("tab-"+name).classList.remove("hidden");
  const sel = document.querySelector(`[data-tab="${name}"]`);
  if(sel){ sel.classList.add('tab-active'); sel.classList.remove('tab-inactive'); }
  if(name==="jobs"){ try{ renderMaterials(); renderMaterialsCatalogDatalist(); }catch(e){} }
  if(name==="admin"){ adminReload(); }
  if(name==="plan"){ drawPlan(); }
}
document.querySelectorAll(".tab-btn").forEach(btn=>btn.addEventListener("click",()=>selectTab(btn.getAttribute("data-tab"))));

/* ===== Google Sign-In ===== */
async function handleGoogleCredentialResponse(response){
  try{
    const res = await fetch(API_BASE + "/auth/google/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:response.credential})});
    if(!res.ok){ const err = await res.json().catch(()=>({})); throw new Error(err.error || "Neuspešna verifikacija"); }
    const data = await res.json();
    accessToken = data.access_token; me = data.user;
    localStorage.setItem("jwt", accessToken); localStorage.setItem("me", JSON.stringify(me));
    await loadBootstrapData();

    // vidnost zavihkov
    document.getElementById('tabBtnReports')?.classList.toggle('hidden', !any(myRoles(),['Owner','CEO']));
    document.getElementById('tabBtnAdmin').style.display = any(myRoles(),['Owner','CEO']) ? 'inline-block' : 'none';
    document.getElementById('tabBtnPlan').classList.remove('hidden'); // plan vidijo vsi, način se razlikuje

    showAppAfterLogin(); selectTab('time');
  }catch(e){ alert("Prijava ni uspela: " + e.message); }
}
function initGoogle(){
  if(!(window.google && google.accounts && google.accounts.id)) return false;
  try{
    google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID, callback:handleGoogleCredentialResponse});
    const m = document.getElementById('g_id_signin'); if(m && m.childElementCount===0){ google.accounts.id.renderButton(m,{theme:"outline",size:"large"}); }
    return true;
  }catch{ return false; }
}
window.addEventListener('load', ()=>{
  let tries=0; const t=setInterval(()=>{ if(initGoogle()||tries++>40) clearInterval(t); },100);
  if(accessToken && me){ loadBootstrapData().then(()=>{ renderProjects(); showAppAfterLogin(); selectTab('time'); }); } else { showLoggedOut(); }
});

/* ===== UI helperji ===== */
function showAppAfterLogin(){
  document.getElementById('g_id_signin')?.classList.add('hidden');
  document.getElementById('signOut')?.classList.remove('hidden');
  document.getElementById('statusBadge')?.classList.remove('hidden');
  document.getElementById('tabsNav')?.classList.remove('hidden');
  document.getElementById('presencePanel')?.classList.remove('hidden');
  document.getElementById('todayPanel')?.classList.remove('hidden');
}
function showLoggedOut(){
  document.getElementById('g_id_signin')?.classList.remove('hidden');
  document.getElementById('signOut')?.classList.add('hidden');
  document.getElementById('statusBadge')?.classList.add('hidden');
  document.getElementById('tabsNav')?.classList.add('hidden');
  document.getElementById('presencePanel')?.classList.add('hidden');
  document.getElementById('todayPanel')?.classList.add('hidden');
}
document.getElementById('signOut')?.addEventListener('click', ()=>{
  localStorage.clear(); accessToken=null; me=null; showLoggedOut();
  ["time","plan","jobs","reports","admin"].forEach(t=>document.getElementById("tab-"+t)?.classList.add("hidden"));
});

/* ===== Bootstrap podatki ===== */
function mapMaterialsToCatalog(list){ const out = {}; (list||[]).forEach(m=>{ if(m?.name) out[m.name]={id:m.id,uom:m.uom||'kos'};}); return out; }
async function loadBootstrapData(){
  const u = await fetch(API_BASE + "/users",{headers:{Authorization:"Bearer "+accessToken}}); usersDir = u.ok ? await u.json() : {};
  const p = await fetch(API_BASE + "/projects",{headers:{Authorization:"Bearer "+accessToken}}); projects = p.ok ? await p.json() : [];
  const m = await fetch(API_BASE + "/materials",{headers:{Authorization:"Bearer "+accessToken}}); materialsCatalog = m.ok ? mapMaterialsToCatalog(await m.json()) : {};
  renderProjects(); renderUsersAdmin(); renderProjectsAdmin(); renderMaterialsCatalogDatalist();
}
function renderProjects(){
  const cp=document.getElementById("currentProject"), lp=document.getElementById("logProject");
  if (cp) cp.innerHTML='<option value="">— izberi —</option>'+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
  if (lp) lp.innerHTML=projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
}

/* ===== (krajšano) dnevnik/materiali ===== */
function renderMaterialsCatalogDatalist(){ const dl=document.getElementById('materialsCatalog'); if(!dl) return; const entries=Object.entries(materialsCatalog).sort((a,b)=>a[0].localeCompare(b[0])); dl.innerHTML=entries.map(([n,i])=>`<option value="${n}" data-uom="${i.uom||'kos'}"></option>`).join(''); }
function renderMaterials(){ const wrap=document.getElementById('materialsList'); if(!wrap) return; if(materials.length===0) materials.push({name:'',qty:'',uom:'kos'}); wrap.innerHTML=materials.map((m,idx)=>`<div class="grid grid-cols-1 md:grid-cols-12 gap-2"><input list="materialsCatalog" class="md:col-span-6" placeholder="Material" value="${m.name||''}" oninput="materials[${idx}].name=this.value"/><input type="number" step="0.01" class="md:col-span-3" placeholder="Količina" value="${m.qty||''}" oninput="materials[${idx}].qty=this.value"/><select class="md:col-span-2" onchange="materials[${idx}].uom=this.value"><option value="kos"${m.uom==='kos'?' selected':''}>kos</option><option value="m"${m.uom==='m'?' selected':''}>m</option><option value="kpl"${m.uom==='kpl'?' selected':''}>kpl</option><option value="h"${m.uom==='h'?' selected':''}>h</option></select><button type="button" class="md:col-span-1 btn btn-outline !py-2 !px-3" onclick="materials.splice(${idx},1); renderMaterials();"><i class="fas fa-times"></i></button></div>`).join(''); }

/* ===== Lokalni store za evidenco & dnevnik (enako kot prej) ===== */
const store={ timeEntries:JSON.parse(localStorage.getItem('timeEntries')||'[]'), jobLogs:JSON.parse(localStorage.getItem('jobLogs')||'[]') };
function saveLocal(){ localStorage.setItem('timeEntries',JSON.stringify(store.timeEntries)); localStorage.setItem('jobLogs',JSON.stringify(store.jobLogs)); }
const resolvedName=email=>(usersDir[email]?.name)||me?.name||email;
const fmt=ts=>new Date(ts).toLocaleTimeString('sl-SI',{hour:'2-digit',minute:'2-digit'});
const dmy=ts=>new Date(ts).toLocaleDateString('sl-SI');
const projectName=id=>(projects.find(p=>p.id===id)?.name)||'';

["clockIn","clockOut","breakStart","breakEnd"].forEach(id=>{
  const btn=document.getElementById(id);
  if(btn){ btn.addEventListener('click',()=>{ const map={clockIn:'prihod',clockOut:'odhod',breakStart:'malica-začetek',breakEnd:'malica-konec'}; addTime(map[id]); }); }
});
function addTime(type){ if(!me) return alert("Najprej se prijavi."); const pid=document.getElementById('currentProject').value||null; const emp=resolvedName(me.email); store.timeEntries.push({id:crypto.randomUUID(),employee:emp,email:me.email,projectId:pid,type,ts:Date.now()}); saveLocal(); renderTimeEntries(); }
function deleteTimeEntry(id){ if(!confirm("Odstranim vnos?")) return; const idx = store.timeEntries.findIndex(e => e.id===id && e.email===me.email); if (idx>=0){ store.timeEntries.splice(idx,1); saveLocal(); renderTimeEntries(); } }
function renderTimeEntries(){
  const ul=document.getElementById('todayEntries');
  const today=new Date(); const start=new Date(today.getFullYear(),today.getMonth(),today.getDate()).getTime(); const end=start+86400000;
  const entries=store.timeEntries.filter(e=>e.ts>=start && e.ts<end).sort((a,b)=>a.ts-b.ts);
  if(!entries.length){ ul.innerHTML='<li class="text-center py-4" style="color:var(--muted)"><i class="far fa-clock text-2xl mb-2"></i><p>Ni vnosov za danes.</p></li>'; return; }
  ul.innerHTML=entries.map(e=>`<li class="p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);"><div class="flex items-center"><i class="far fa-clock mr-2"></i><div><div class="font-medium">${e.type} ob ${fmt(e.ts)}</div><div class="text-xs" style="color:var(--muted)">${e.employee} • ${projectName(e.projectId)||"Brez projekta"}</div></div></div>${e.email===me?.email ? `<button class="btn btn-outline !py-1 !px-2 text-xs" onclick="deleteTimeEntry('${e.id}')"><i class="fas fa-trash"></i></button>` : ``}</li>`).join('');
}

/* ====================== PLAN: podatki & render ====================== */
const PLAN_KEY='ht_plan_v1';
const planGrid = document.getElementById('planGrid');
const planTitle = document.getElementById('planTitle');
const planPrev  = document.getElementById('planPrev');
const planNext  = document.getElementById('planNext');
const planToday = document.getElementById('planToday');
const planRights = document.getElementById('planRights');
const planWeekHeader = document.getElementById('planWeekHeader');
document.getElementById('planAddQuick').addEventListener('click',()=>openPlanEditor(new Date()));

let planCursor = new Date(); planCursor.setDate(1);

function loadPlan(){ try{ return JSON.parse(localStorage.getItem(PLAN_KEY)||'{}'); }catch{return {}} }
function savePlan(obj){ localStorage.setItem(PLAN_KEY, JSON.stringify(obj)); }
function dateISO(d){ return d.toISOString().slice(0,10); }
function monthRange(d){ const f=new Date(d.getFullYear(),d.getMonth(),1); const l=new Date(d.getFullYear(),d.getMonth()+1,0); f.setHours(0,0,0,0); l.setHours(23,59,59,999); return {f,l}; }
function weekStart(d){ const x=new Date(d); const dow=(x.getDay()+6)%7; x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x; }

planPrev.addEventListener('click',()=>{ if(canSeeMonth()) { planCursor.setMonth(planCursor.getMonth()-1); } else { planCursor.setDate(weekStart(planCursor).getDate()-7); } drawPlan(); });
planNext.addEventListener('click',()=>{ if(canSeeMonth()) { planCursor.setMonth(planCursor.getMonth()+1); } else { planCursor.setDate(weekStart(planCursor).getDate()+7); } drawPlan(); });
planToday.addEventListener('click',()=>{ planCursor=new Date(); drawPlan(); });

function drawPlan(){
  const store = loadPlan();
  const todayISO = dateISO(new Date());
  planRights.textContent = canEditPlan() ? 'Urejanje: Owner/CEO/Vodja' : (canMarkDone() ? 'Označi kot opravljeno' : 'Samo ogled');

  if (canSeeMonth()){
    planTitle.textContent = planCursor.toLocaleDateString('sl-SI',{month:'long',year:'numeric'});
    planWeekHeader.classList.remove('hidden');

    const {f,l} = monthRange(planCursor);
    const firstDow = (new Date(f).getDay()+6)%7; // pon=0
    const cells = [];
    for(let i=0;i<firstDow;i++) cells.push(null);
    for(let d=1; d<=l.getDate(); d++){ cells.push(new Date(planCursor.getFullYear(), planCursor.getMonth(), d)); }

    planGrid.classList.add('cal-grid');
    planGrid.innerHTML = cells.map(d=> buildPlanDay(d, store, todayISO, canEditPlan())).join('');

    wireDnD(canEditPlan());
  } else {
    // tedenski pogled (pon-sob)
    const ws = weekStart(planCursor);
    planTitle.textContent = `Teden ${ws.toLocaleDateString('sl-SI')} – ${new Date(ws.getFullYear(),ws.getMonth(),ws.getDate()+5).toLocaleDateString('sl-SI')}`;
    planWeekHeader.classList.remove('hidden');

    const days = [...Array(6)].map((_,i)=> new Date(ws.getFullYear(),ws.getMonth(),ws.getDate()+i));
    planGrid.classList.add('cal-grid');
    planGrid.innerHTML = days.map(d=> buildPlanDay(d, store, todayISO, false)).join('');
    // brez DnD
  }
}

function buildPlanDay(date, store, todayISO, allowAdd){
  if(!date) return `<div></div>`;
  const key = dateISO(date);
  const list = store[key] || [];
  const inToday = key===todayISO;
  const hdr = `<div class="cal-day"><span>${date.getDate()}.</span><span class="text-xs">${date.toLocaleDateString('sl-SI',{weekday:'short'})}</span></div>`;
  const items = list.map((t,idx)=>{
    const pr = t.priority==='Visoka'?'prio-high':t.priority==='Srednja'?'prio-med':'prio-low';
    const done = t.status==='Opravljeno';
    const doneIcon = done ? 'fa-circle-check text-green-600' : 'fa-circle-dot';
    const drag = allowAdd ? `draggable="true" ondragstart="planDragStart(event,'${key}',${idx})"` : '';
    const controls = allowAdd
      ? `<div class="flex gap-1">
           <button class="btn btn-outline !py-0.5 !px-1.5 text-[11px]" onclick="openPlanEditor(new Date('${key}'),'${idx}')"><i class="fas fa-pen"></i></button>
           <button class="btn btn-danger !py-0.5 !px-1.5 text-[11px]" onclick="delPlanItem('${key}',${idx})"><i class="fas fa-trash"></i></button>
         </div>`
      : (canMarkDone() ? `<button class="btn btn-outline !py-0.5 !px-1.5 text-[11px]" onclick="toggleDone('${key}',${idx})"><i class="fas ${doneIcon}"></i></button>` : '');
    return `<div class="cal-item ${pr}" ${drag}>
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="text-xs" style="color:var(--muted)">${t.time||''}</div>
          <div class="truncate font-medium">${escapeHtml(t.title||'Naloga')}</div>
          ${t.place?`<div class="text-[11px]" style="color:var(--muted)">${escapeHtml(t.place)}</div>`:''}
        </div>
        ${controls}
      </div>
    </div>`;
  }).join('');

  const addBtn = allowAdd ? `<button class="btn btn-outline !py-1 !px-2 mt-2" onclick="openPlanEditor(new Date('${key}'))"><i class="fas fa-plus"></i></button>` : '';

  return `<div class="cal-cell ${inToday?'today-outline':''}" data-dropdate="${key}">
    ${hdr}
    ${items || `<div class='text-xs' style="color:var(--muted)">Ni nalog</div>`}
    ${addBtn}
  </div>`;
}

function wireDnD(enabled){
  if(!enabled) return;
  document.querySelectorAll('[data-dropdate]').forEach(el=>{
    el.addEventListener('dragover', ev=>{ ev.preventDefault(); el.classList.add('drag-over');});
    el.addEventListener('dragleave', ()=> el.classList.remove('drag-over'));
    el.addEventListener('drop', ev=>{
      ev.preventDefault(); el.classList.remove('drag-over');
      const data = ev.dataTransfer.getData('text/plain'); // srcKey|idx
      const [srcKey, idxStr] = data.split('|'); const idx=+idxStr;
      const dstKey = el.getAttribute('data-dropdate');
      const store = loadPlan();
      const item = (store[srcKey]||[])[idx]; if(!item) return;
      (store[srcKey]||[]).splice(idx,1);
      (store[dstKey] ||= []).push(item);
      savePlan(store); drawPlan();
    });
  });
}
window.planDragStart = (ev, key, idx)=> ev.dataTransfer.setData('text/plain', `${key}|${idx}`);

function toggleDone(key, idx){
  const store = loadPlan();
  const it = (store[key]||[])[idx]; if(!it) return;
  it.status = it.status==='Opravljeno' ? 'V teku' : 'Opravljeno';
  savePlan(store); drawPlan();
}
function delPlanItem(key, idx){
  if(!confirm('Odstranim postavko?')) return;
  const store = loadPlan(); (store[key]||[]).splice(idx,1); savePlan(store); drawPlan();
}

function openPlanEditor(dateObj, editIdx){
  if(!canEditPlan()) return;
  const key = dateISO(dateObj);
  const store = loadPlan();
  const item = (editIdx!=null) ? (store[key]||[])[+editIdx] : null;

  const date = prompt('Datum (YYYY-MM-DD):', key) || key;
  if(!date) return;
  const time = prompt('Čas (npr. 08:00-12:00):', item?.time||'') || '';
  const title = prompt('Naslov naloge:', item?.title||'') || 'Naloga';
  const place = prompt('Lokacija/stranka:', item?.place||'') || '';
  const priority = prompt('Prioriteta (Nizka/Srednja/Visoka):', item?.priority||'Srednja') || 'Srednja';
  const status = item?.status || 'V teku';

  const payload = { time, title, place, priority, status };
  if(editIdx!=null){
    (store[key]||[])[+editIdx] = payload;
  } else {
    (store[date] ||= []).push(payload);
  }
  savePlan(store); drawPlan();
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }

/* žični gumbi */
document.getElementById('planAddQuick').title = 'Doda v današnji dan';
/* ================================================================== */

/* ===== Admin (skrajšano) ===== */
function renderUsersAdmin(){ const ul=document.getElementById('admUserList'); if(!ul) return; const entries=Object.entries(usersDir).sort((a,b)=>(a[1].name||a[0]).localeCompare(b[1].name||b[0])); ul.innerHTML=entries.map(([email,u])=>`<li class="p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);"><div class="min-w-0"><div class="font-medium truncate"><i class="fas fa-user mr-2 text-blue-500"></i>${u.name||email}<span style="color:var(--muted)"> • </span><span style="color:var(--muted)">${email}</span></div><div class="text-xs" style="color:var(--muted)">Vloge: ${(u.roles||[]).join(', ')||'—'}</div></div></li>`).join('') || `<li class="text-center" style="color:var(--muted)">Ni uporabnikov.</li>`; }
function renderProjectsAdmin(){ const ul=document.getElementById('admProjectList'); if(!ul) return; ul.innerHTML=(projects||[]).map(p=>`<li class="p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);"><div class="font-medium truncate"><i class="fas fa-folder text-yellow-500 mr-2"></i>${p.name}</div></li>`).join('') || `<li class="text-center" style="color:var(--muted)">Ni projektov.</li>`; }
async function adminReload(){ /* poenostavljeno */ }

/* ===== Začetni render ===== */
function drawPlanOnOpen(){ drawPlan(); }
</script>
</body>
</html>

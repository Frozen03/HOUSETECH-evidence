<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOUSETECH Ops</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- EXCEL & PDF -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --primary:#3B82F6; --primary-700:#2563EB; --secondary:#10B981; --danger:#EF4444;
      --bg:#F3F4F6; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --border:#E5E7EB;
      --tab-active:#FFFFFF; --tab-inactive:#F3F4F6;
    }
    .dark-mode{
      --bg:#0F172A; --card:#111827; --text:#E5E7EB; --muted:#A1A1AA; --border:#1F2937;
      --tab-active:#111827; --tab-inactive:#1F2937;
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      transition: background .3s, color .3s;
      background-position: center;
      background-repeat: no-repeat;
      background-size: cover;
      background-attachment: fixed;
      background-color: var(--bg);
      background:
        url("../img/logo.png") center/contain no-repeat fixed,
        var(--bg);
    }
    body.dark-mode{
      background:
        linear-gradient(to bottom, rgba(15,23,42,0.9), rgba(15,23,42,0.95)),
        url("../img/housetech-dark.png") center/cover no-repeat fixed;
    }

    .card{ background: var(--card); border:1px solid var(--border); border-radius:1rem; box-shadow: 0 4px 8px rgba(0,0,0,.05); padding:1.25rem; transition:.2s; }
    .btn{ border-radius:.75rem; padding:.6rem 1.1rem; font-weight:600; display:inline-flex; gap:.5rem; align-items:center; }
    .btn-primary{ background:var(--primary); color:#fff; } .btn-primary:hover{ background:var(--primary-700); }
    .btn-outline{ border:1px solid var(--border); color:var(--text); background:transparent; }
    .btn-danger{ background:var(--danger); color:#fff; }

    input, select{ width:100%; border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:.75rem; padding:.7rem .9rem; transition:.15s; }
    input:focus, select:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.15); }

    .tab-btn{ padding:.5rem 1rem; font-weight:600; border:1px solid var(--border); transition:.15s; }
    .tab-active{ background:var(--tab-active); }
    .tab-inactive{ background:var(--tab-inactive); color:var(--muted); }
    .tab-btn + .tab-btn{ border-left:none; }
    .tabs-wrap{ border-radius:1rem; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,.06); }

    .badge{ padding:.25rem .6rem; border-radius:999px; font-size:.75rem; font-weight:700; }
    .badge-success{ background:#DCFCE7; color:#166534; }
    .dark-mode .badge-success{ background:#166534; color:#DCFCE7; }

    .logo{ font-weight:800; background:linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    .role-group{ display:flex; flex-wrap:wrap; gap:.5rem; }
    .role-pill{ display:inline-flex; align-items:center; gap:.45rem; padding:.45rem .7rem; border:1px solid var(--border); border-radius:999px; cursor:pointer; user-select:none; background:var(--tab-inactive); transition: background .15s, border-color .15s; }
    .role-pill input{ appearance:none; width:1rem; height:1rem; border-radius:4px; border:1.5px solid var(--border); display:grid; place-items:center; }
    .role-pill input:checked{ background:var(--primary); border-color:var(--primary); }
    .role-pill input:checked::after{ content:'\2713'; color:#fff; font-size:.75rem; line-height:1; }
    .role-pill:hover{ border-color:var(--primary); }

    .entry-delete{ opacity:.7; transition:opacity .15s; }
    .entry-delete:hover{ opacity:1; }

    /* tabelice v poročilih */
    .tbl { width:100%; border-collapse: collapse; }
    .tbl th,.tbl td { border:1px solid var(--border); padding:.5rem .6rem; font-size:.875rem; }
    .tbl th { background:var(--tab-inactive); text-align:left; }
    .kpi { background:var(--tab-inactive); border:1px solid var(--border); border-radius:.75rem; padding:.9rem 1rem; }
    .kpi h4 { font-weight:700; font-size:.95rem; margin-bottom:.35rem; }
    .kpi ul li { display:flex; justify-content:space-between; border-top:1px dashed var(--border); padding:.25rem 0; }
    .kpi ul li:first-child { border-top:none; }
  </style>
</head>
<body>
<div class="max-w-6xl mx-auto py-6 px-4">
  <header class="flex items-start justify-between mb-6">
    <div>
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold flex items-center gap-3"><span class="logo">HOUSETECH</span><span>Ops</span></h1>
        <button id="themeToggle" class="btn btn-outline p-2 !px-3" title="Preklopi temo"><i class="fas fa-moon"></i></button>
      </div>
      <p class="text-sm" style="color:var(--muted)">Prijava z Google</p>
    </div>
    <div><span id="statusBadge" class="badge badge-success hidden"><i class="fas fa-check mr-1"></i>Prijavljen</span></div>
  </header>

  <!-- PRIJAVA -->
  <div id="authCard" class="card mb-6">
    <h2 class="text-lg font-semibold mb-3"><i class="fas fa-right-to-bracket mr-2 text-blue-500"></i>Prijava</h2>
    <p class="text-sm mb-4" style="color:var(--muted)">Prijavi se z Google. Strežnik preveri ID token in izda JWT z vlogami (whitelist).</p>
    <div class="flex items-center gap-3">
      <div id="g_id_signin"></div>
      <button id="signOut" class="btn btn-outline hidden"><i class="fas fa-right-from-bracket"></i> Odjava</button>
    </div>
  </div>

  <!-- TABS -->
  <nav id="tabsNav" class="mb-6 hidden">
    <div class="tabs-wrap inline-flex">
      <button data-tab="time"    class="tab-btn tab-active"><i class="far fa-clock mr-2"></i>Evidenca ur</button>
      <button data-tab="jobs"    class="tab-btn tab-inactive"><i class="far fa-list-alt mr-2"></i>Dnevnik del</button>
      <button id="tabBtnReports" data-tab="reports" class="tab-btn tab-inactive"><i class="far fa-chart-bar mr-2"></i>Poročila</button>
      <button id="tabBtnAdmin"   data-tab="admin"   class="tab-btn tab-inactive"><i class="fas fa-user-shield mr-2"></i>Admin</button>
    </div>
  </nav>

  <!-- TIME -->
  <section id="tab-time">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div id="presencePanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-user-clock mr-2 text-blue-500"></i>Registracija prisotnosti</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Projekt</label>
            <select id="currentProject"><option value="">— izberi —</option></select>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="clockIn"  class="btn" style="background:#10B981;color:#fff;"><i class="fas fa-sign-in-alt"></i> Prihod</button>
            <button id="clockOut" class="btn" style="background:#EF4444;color:#fff;"><i class="fas fa-sign-out-alt"></i> Odhod</button>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="breakStart" class="btn btn-outline"><i class="fas fa-utensils"></i> Začetek malice</button>
            <button id="breakEnd"   class="btn btn-outline"><i class="fas fa-utensils"></i> Konec malice</button>
          </div>
        </div>
      </div>

      <div id="todayPanel" class="card hidden">
        <h2 class="text-lg font-semibold mb-3"><i class="far fa-calendar-check mr-2 text-blue-500"></i>Današnje registracije</h2>
        <ul id="todayEntries" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <!-- JOBS -->
  <section id="tab-jobs" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div id="jobsProjectsCard" class="card hidden"></div>

      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-tasks mr-2 text-blue-500"></i>Dnevnik del</h2>
        <div class="space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label class="block text-sm font-medium mb-1">Projekt</label><select id="logProject"></select></div>
            <div><label class="block text-sm font-medium mb-1">Aktivnost</label><input id="logActivity" placeholder="npr. Montaža stikal..." /></div>
            <div><label class="block text-sm font-medium mb-1">Ure</label><input id="logHours" type="number" step="0.25" placeholder="npr. 3.5" /></div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Materiali</label>
            <div id="materialsList" class="space-y-2"></div>
            <datalist id="materialsCatalog"></datalist>
            <button id="addMaterialRow" type="button" class="btn btn-outline mt-2"><i class="fas fa-plus"></i> Dodaj material</button>
          </div>

          <div class="flex justify-end"><button id="addLog" class="btn btn-primary"><i class="fas fa-save mr-1"></i> Shrani vnos</button></div>
        </div>

        <hr class="my-4" style="border-color:var(--border)" />
        <h3 class="text-md font-semibold mb-2"><i class="fas fa-history mr-2 text-blue-500"></i>Zgodovina vnosov</h3>
        <div id="logList" class="space-y-3 text-sm max-h-96 overflow-y-auto pr-2"></div>
      </div>
    </div>
  </section>

  <!-- REPORTS -->
  <section id="tab-reports" class="hidden">
    <div class="card">
      <h2 class="text-lg font-semibold mb-3"><i class="fas fa-file-export mr-2 text-blue-500"></i>Poročila</h2>

      <!-- Filtri -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-3">
        <div>
          <label class="block text-sm font-medium mb-1">Od</label>
          <input type="date" id="repFrom">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Do</label>
          <input type="date" id="repTo">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Projekt</label>
          <select id="repProject"><option value="">Vsi</option></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Zaposleni</label>
          <select id="repEmployee"><option value="">Vsi</option></select>
        </div>
        <div class="flex items-end gap-2">
          <button id="repRefresh" class="btn btn-primary w-full"><i class="fas fa-rotate"></i> Osveži</button>
        </div>
      </div>

      <!-- KPI povzetki -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
        <div class="kpi">
          <h4><i class="fas fa-user-clock mr-2 text-blue-500"></i>Prisotnost — ure po projektih</h4>
          <ul id="kpiPresenceProj"></ul>
        </div>
        <div class="kpi">
          <h4><i class="fas fa-user mr-2 text-blue-500"></i>Prisotnost — ure po zaposlenih</h4>
          <ul id="kpiPresenceEmp"></ul>
        </div>
        <div class="kpi">
          <h4><i class="fas fa-diagram-project mr-2 text-blue-500"></i>Dnevnik — ure po projektih</h4>
          <ul id="kpiJobsProj"></ul>
        </div>
        <div class="kpi">
          <h4><i class="fas fa-people-group mr-2 text-blue-500"></i>Dnevnik — ure po zaposlenih</h4>
          <ul id="kpiJobsEmp"></ul>
        </div>
      </div>

      <!-- Podrobne tabele -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <h3 class="font-semibold mb-2">Evidenca prisotnosti (vrstice)</h3>
          <div class="max-h-96 overflow-auto border rounded-lg">
            <table class="tbl">
              <thead><tr><th>Datum</th><th>Projekt</th><th>Zaposleni</th><th style="width:80px">Ure</th></tr></thead>
              <tbody id="tblPresence"></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Dnevnik del (vrstice)</h3>
          <div class="max-h-96 overflow-auto border rounded-lg">
            <table class="tbl">
              <thead><tr><th>Datum</th><th>Projekt</th><th>Zaposleni</th><th>Aktivnost</th><th style="width:80px">Ure</th></tr></thead>
              <tbody id="tblJobs"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Izvoz -->
      <div class="flex flex-wrap gap-2 mt-4">
        <button id="exportExcel" class="btn btn-primary"><i class="fas fa-file-excel mr-1"></i> Excel (.xlsx)</button>
        <button id="exportPdf"   class="btn btn-outline"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
        <button id="exportData"  class="btn btn-outline"><i class="fas fa-download mr-1"></i> export.json (debug)</button>
        <button id="wipeData"    class="btn btn-outline"><i class="fas fa-trash-alt mr-1"></i> Počisti lokalne podatke</button>
      </div>
    </div>
  </section>

  <!-- ADMIN (ni sprememb) -->
  <section id="tab-admin" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="card lg:col-span-2">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-users-cog mr-2 text-blue-500"></i>Uporabniki</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
          <input id="admUserEmail" placeholder="email@domena.si" />
          <input id="admUserName" placeholder="Ime in priimek" />
          <div class="role-group">
            <label class="role-pill" for="roleOwner"><input id="roleOwner" type="checkbox"> Owner</label>
            <label class="role-pill" for="roleCEO"><input id="roleCEO" type="checkbox"> CEO</label>
            <label class="role-pill" for="roleManager"><input id="roleManager" type="checkbox"> vodja</label>
            <label class="role-pill" for="roleEmployee"><input id="roleEmployee" type="checkbox"> zaposlen</label>
            <label class="role-pill" for="roleStudent"><input id="roleStudent" type="checkbox"> študent</label>
          </div>
          <button id="admAddUser" class="btn btn-primary"><i class="fas fa-user-plus"></i> Shrani</button>
        </div>
        <ul id="admUserList" class="space-y-2 text-sm"></ul>
      </div>

      <div class="card">
        <h2 class="text-lg font-semibold mb-3"><i class="fas fa-sitemap mr-2 text-blue-500"></i>Projekti</h2>
        <div class="flex gap-2 mb-3">
          <input id="admProjectName" class="flex-1" placeholder="Dodaj nov projekt" />
          <button id="admAddProject" class="btn btn-primary"><i class="fas fa-plus"></i></button>
        </div>
        <ul id="admProjectList" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <footer class="mt-10 text-xs text-center" style="color:var(--muted)">© 2025 HOUSETECH — final</footer>
</div>

<script>
  /* ===== Tema ===== */
  const themeToggle = document.getElementById('themeToggle');
  const storedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  if (storedTheme === 'dark') { document.body.classList.add('dark-mode'); themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; }
  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const dark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', dark ? 'dark' : 'light');
    themeToggle.innerHTML = dark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
  });

  /* ===== Konfiguracija ===== */
  const GOOGLE_CLIENT_ID = "149127907023-ip3jqct2vmqc4tm4jm4bfoogd1pqfpsv.apps.googleusercontent.com";
  const API_BASE = "https://api.housetech.si";

  let accessToken = localStorage.getItem("jwt") || null;
  let me = localStorage.getItem("me") ? JSON.parse(localStorage.getItem("me")) : null;
  let usersDir = {}; let projects = [];
  let materialsCatalog = {};    // name -> {id,uom}
  let materials = [];           // vnosne vrstice pri dnevniku

  const isOwnerOrCeo = () => (me?.roles||[]).some(r => r==='Owner' || r==='CEO');

  /* ===== Tabs ===== */
  function selectTab(name){
    ["time","jobs","reports","admin"].forEach(t=>{
      document.getElementById("tab-"+t).classList.add("hidden");
      const btn = document.querySelector(`[data-tab="${t}"]`);
      if(btn){ btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); }
    });
    document.getElementById("tab-"+name).classList.remove("hidden");
    const sel = document.querySelector(`[data-tab="${name}"]`);
    if(sel){ sel.classList.add('tab-active'); sel.classList.remove('tab-inactive'); }
    if(name==="jobs"){ try{ renderMaterials(); renderMaterialsCatalogDatalist(); }catch(e){} }
    if(name==="admin"){ adminReload(); }
    if(name==="reports"){ prepareReportFilters(); renderReports(); }
  }
  document.querySelectorAll(".tab-btn").forEach(btn=>btn.addEventListener("click",()=>selectTab(btn.getAttribute("data-tab"))));

  /* ===== Google Sign-In (whitelist enforced na serverju) ===== */
  async function handleGoogleCredentialResponse(response){
    try{
      const res = await fetch(API_BASE + "/auth/google/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:response.credential})});
      if(!res.ok){
        const err = await res.json().catch(()=>({}));
        throw new Error(err.error || "Neuspešna verifikacija");
      }
      const data = await res.json();
      accessToken = data.access_token; me = data.user;
      localStorage.setItem("jwt", accessToken); localStorage.setItem("me", JSON.stringify(me));
      await loadBootstrapData();
      const boss = isOwnerOrCeo();
      document.getElementById('tabBtnReports')?.classList.toggle('hidden', !boss);
      document.getElementById('tab-reports')?.classList.toggle('hidden', !boss);
      document.getElementById('tabBtnAdmin').style.display = boss ? 'inline-block' : 'none';
      showAppAfterLogin(); selectTab('time');
    }catch(e){ alert("Prijava ni uspela: " + e.message); }
  }
  function initGoogle(){
    if(!(window.google && google.accounts && google.accounts.id)) return false;
    try{
      google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID, callback:handleGoogleCredentialResponse});
      const m = document.getElementById('g_id_signin'); if(m && m.childElementCount===0){ google.accounts.id.renderButton(m,{theme:"outline",size:"large"}); }
      return true;
    }catch{ return false; }
  }
  window.addEventListener('load', ()=>{
    let tries=0; const t=setInterval(()=>{ if(initGoogle()||tries++>40) clearInterval(t); },100);
    if(accessToken && me){ loadBootstrapData().then(()=>{ showAppAfterLogin(); selectTab('time'); }); } else { showLoggedOut(); }
  });

  /* ===== UI helperji ===== */
  function showAppAfterLogin(){
    document.getElementById('g_id_signin')?.classList.add('hidden');
    document.getElementById('signOut')?.classList.remove('hidden');
    document.getElementById('statusBadge')?.classList.remove('hidden');
    document.getElementById('tabsNav')?.classList.remove('hidden');
    document.getElementById('presencePanel')?.classList.remove('hidden');
    document.getElementById('todayPanel')?.classList.remove('hidden');
    renderTimeEntries();
  }
  function showLoggedOut(){
    document.getElementById('g_id_signin')?.classList.remove('hidden');
    document.getElementById('signOut')?.classList.add('hidden');
    document.getElementById('statusBadge')?.classList.add('hidden');
    document.getElementById('tabsNav')?.classList.add('hidden');
    document.getElementById('presencePanel')?.classList.add('hidden');
    document.getElementById('todayPanel')?.classList.add('hidden');
  }
  document.getElementById('signOut')?.addEventListener('click', ()=>{
    localStorage.clear(); accessToken=null; me=null; showLoggedOut();
    ["time","jobs","reports","admin"].forEach(t=>document.getElementById("tab-"+t)?.classList.add("hidden"));
  });

  /* ===== Backend bootstrap ===== */
  function mapMaterialsToCatalog(list){
    const out = {};
    (list || []).forEach(m => { if (m?.name) out[m.name] = { id: m.id, uom: m.uom || "kos" }; });
    return out;
  }
  async function loadBootstrapData(){
    const u = await fetch(API_BASE + "/users",{headers:{Authorization:"Bearer "+accessToken}});
    if(u.ok) usersDir = await u.json(); else usersDir = {};

    const p = await fetch(API_BASE + "/projects",{headers:{Authorization:"Bearer "+accessToken}});
    if(p.ok) projects = await p.json(); else projects = [];

    const m = await fetch(API_BASE + "/materials",{headers:{Authorization:"Bearer "+accessToken}});
    if (m.ok) { const list = await m.json(); materialsCatalog = mapMaterialsToCatalog(list); } else materialsCatalog = {};

    renderProjects(); renderUsersAdmin(); renderProjectsAdmin(); renderMaterialsCatalogDatalist();
  }

  /* ===== Projekti (read-only) ===== */
  function renderProjects(){
    const cp=document.getElementById("currentProject"), lp=document.getElementById("logProject");
    cp.innerHTML='<option value="">— izberi —</option>'+projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
    lp.innerHTML=projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");

    // poročila filter projekt
    const rp=document.getElementById('repProject');
    if (rp){ rp.innerHTML = '<option value="">Vsi</option>' + projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
  }
  function renderEmployeesFilter(){
    const re = document.getElementById('repEmployee');
    if(!re) return;
    const emails = Object.keys(usersDir);
    re.innerHTML = '<option value="">Vsi</option>' + emails
      .map(e=>({email:e, name: usersDir[e]?.name || e}))
      .sort((a,b)=>a.name.localeCompare(b.name))
      .map(u=>`<option value="${u.email}">${u.name}</option>`).join('');
  }

  /* ===== Admin ===== */
  function renderUsersAdmin(){
    const ul=document.getElementById('admUserList'); if(!ul) return;
    const entries=Object.entries(usersDir).sort((a,b)=>(a[1].name||a[0]).localeCompare(b[1].name||b[0]));
    ul.innerHTML=entries.map(([email,u])=>`
      <li class="entry-item p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);">
        <div class="min-w-0">
          <div class="font-medium truncate"><i class="fas fa-user mr-2 text-blue-500"></i>${u.name||email}
            <span style="color:var(--muted)">•</span> <span style="color:var(--muted)">${email}</span></div>
          <div class="text-xs" style="color:var(--muted)">Vloge: ${(u.roles||[]).join(', ')||'—'}</div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-outline text-xs" onclick="admEditUser('${email}')"><i class="fas fa-pen"></i> Uredi</button>
          <button class="btn btn-danger text-xs" onclick="admDelUser('${email}')"><i class="fas fa-trash"></i> Izbriši</button>
        </div>
      </li>`).join('') || `<li class="text-center" style="color:var(--muted)">Ni uporabnikov.</li>`;
  }
  function admEditUser(email){
    const u=usersDir[email]||{};
    document.getElementById('admUserEmail').value=email;
    document.getElementById('admUserName').value=u.name||'';
    document.getElementById('roleOwner').checked   =(u.roles||[]).includes('Owner');
    document.getElementById('roleCEO').checked     =(u.roles||[]).includes('CEO');
    document.getElementById('roleManager').checked =(u.roles||[]).includes('vodja');
    document.getElementById('roleEmployee').checked=(u.roles||[]).includes('zaposlen');
    document.getElementById('roleStudent').checked =(u.roles||[]).includes('študent');
  }
  document.getElementById('admAddUser')?.addEventListener('click', async ()=>{
    if(!isOwnerOrCeo()) return alert('Samo Owner/CEO');
    const email=document.getElementById('admUserEmail').value.trim().toLowerCase();
    const name =document.getElementById('admUserName').value.trim();
    if(!email||!name) return alert('Vnesi email in ime');

    const roles=[];
    if(document.getElementById('roleOwner').checked)   roles.push('Owner');
    if(document.getElementById('roleCEO').checked)     roles.push('CEO');
    if(document.getElementById('roleManager').checked) roles.push('vodja');
    if(document.getElementById('roleEmployee').checked)roles.push('zaposlen');
    if(document.getElementById('roleStudent').checked) roles.push('študent');

    let r=await fetch(API_BASE+'/users',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({email,name})});
    r=await fetch(API_BASE+'/users/'+encodeURIComponent(email),{method:'PATCH',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({name,roles})});
    if(!r.ok) return alert('Napaka pri shranjevanju uporabnika');
    await adminReload();
    document.getElementById('admUserEmail').value=''; document.getElementById('admUserName').value='';
    ['roleOwner','roleCEO','roleManager','roleEmployee','roleStudent'].forEach(id=>document.getElementById(id).checked=false);
  });
  async function admDelUser(email){
    if(!isOwnerOrCeo()) return alert('Samo Owner/CEO');
    if(!confirm('Res izbrišem uporabnika '+email+'?')) return;
    const r=await fetch(API_BASE+'/users/'+encodeURIComponent(email),{method:'DELETE',headers:{Authorization:'Bearer '+accessToken}});
    if(r.status===403) return alert('Uporabnika z vlogo Owner ni mogoče izbrisati.');
    if(!r.ok) return alert('Napaka pri brisanju uporabnika.');
    await adminReload();
  }
  function renderProjectsAdmin(){
    const ul=document.getElementById('admProjectList'); if(!ul) return;
    ul.innerHTML=(projects||[]).map(p=>`
      <li class="entry-item p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);">
        <div class="font-medium truncate"><i class="fas fa-folder text-yellow-500 mr-2"></i>${p.name}</div>
        <button class="btn btn-outline text-xs" onclick="admDelProject('${p.id}')"><i class="fas fa-trash"></i> Izbriši</button>
      </li>`).join('') || `<li class="text-center" style="color:var(--muted)">Ni projektov.</li>`;
  }
  document.getElementById('admAddProject')?.addEventListener('click', async ()=>{
    if(!isOwnerOrCeo()) return alert('Samo Owner/CEO');
    const name=document.getElementById('admProjectName').value.trim(); if(!name) return;
    const r=await fetch(API_BASE+'/projects',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+accessToken},body:JSON.stringify({name})});
    if(!r.ok) return alert('Napaka pri dodajanju projekta');
    document.getElementById('admProjectName').value=''; await adminReload();
  });
  async function admDelProject(id){
    if(!confirm('Izbrišem projekt?')) return;
    const r=await fetch(API_BASE+'/projects/'+encodeURIComponent(id),{method:'DELETE',headers:{Authorization:'Bearer '+accessToken}});
    if(!r.ok) return alert('Napaka pri brisanju projekta');
    await adminReload();
  }
  async function adminReload(){
    if(!accessToken) return;
    const u=await fetch(API_BASE+'/users',{headers:{Authorization:'Bearer '+accessToken}}); if(u.ok) usersDir=await u.json();
    const p=await fetch(API_BASE+'/projects',{headers:{Authorization:'Bearer '+accessToken}}); if(p.ok) projects=await p.json();
    const m=await fetch(API_BASE+'/materials',{headers:{Authorization:'Bearer '+accessToken}}); if(m.ok){ materialsCatalog = mapMaterialsToCatalog(await m.json()); }
    renderUsersAdmin(); renderProjectsAdmin(); renderProjects(); renderMaterialsCatalogDatalist(); renderEmployeesFilter();
  }

  /* ===== Materiali ===== */
  function renderMaterialsCatalogDatalist(){
    const dl=document.getElementById('materialsCatalog'); if(!dl) return;
    const entries=Object.entries(materialsCatalog).sort((a,b)=>a[0].localeCompare(b[0]));
    dl.innerHTML=entries.map(([name,info])=>`<option value="${name}" data-uom="${info.uom||'kos'}"></option>`).join('');
  }
  function renderMaterials(){
    const wrap=document.getElementById('materialsList'); if(!wrap) return;
    if(materials.length===0) materials.push({name:'',qty:'',uom:'kos'});
    wrap.innerHTML=materials.map((m,idx)=>`
      <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
        <input list="materialsCatalog" class="md:col-span-6" placeholder="Material (npr. NYM-J 3x1,5)"
               value="${m.name||''}" oninput="onMatNameInput(${idx}, this.value)"/>
        <input type="number" step="0.01" class="md:col-span-3" placeholder="Količina"
               value="${m.qty||''}" oninput="materials[${idx}].qty=this.value"/>
        <select class="md:col-span-2" onchange="materials[${idx}].uom=this.value">
          <option value="kos" ${m.uom==='kos'?'selected':''}>kos</option>
          <option value="m"   ${m.uom==='m'?'selected':''}>m</option>
          <option value="kpl" ${m.uom==='kpl'?'selected':''}>kpl</option>
          <option value="h"   ${m.uom==='h'?'selected':''}>h</option>
        </select>
        <button type="button" class="md:col-span-1 btn btn-outline !py-2 !px-3" onclick="materials.splice(${idx},1); renderMaterials();"><i class="fas fa-times"></i></button>
      </div>`).join('');
    renderMaterialsCatalogDatalist();
  }
  window.onMatNameInput=(idx,val)=>{
    materials[idx].name=val;
    const info=materialsCatalog[val];
    if(info && info.uom){ materials[idx].uom=info.uom; renderMaterials(); }
  };
  document.getElementById('addMaterialRow')?.addEventListener('click',()=>{ materials.push({name:'',qty:'',uom:'kos'}); renderMaterials(); });

  async function ensureMaterialOnServer(name, uom) {
    const key = String(name || "").trim();
    if (!key) return null;
    const r = await fetch(API_BASE + "/materials", { method:"POST", headers:{ "Content-Type":"application/json", Authorization:"Bearer "+accessToken }, body: JSON.stringify({ name: key, uom: uom || "kos" }) });
    if (!r.ok) return null;
    const mat = await r.json();
    materialsCatalog[mat.name] = { id: mat.id, uom: mat.uom || "kos" };
    renderMaterialsCatalogDatalist();
    return materialsCatalog[mat.name];
  }

  /* ===== Evidenca ur & dnevnik (local demo) ===== */
  const store={ timeEntries:JSON.parse(localStorage.getItem('timeEntries')||'[]'),
                jobLogs:JSON.parse(localStorage.getItem('jobLogs')||'[]') };
  function saveLocal(){ localStorage.setItem('timeEntries',JSON.stringify(store.timeEntries));
                        localStorage.setItem('jobLogs',JSON.stringify(store.jobLogs));
                        renderTimeEntries(); renderJobLogs(); if(!document.getElementById('tab-reports').classList.contains('hidden')) renderReports(); }
  const resolvedName=email=>(usersDir[email]?.name)||me?.name||email;
  const fmt=ts=>new Date(ts).toLocaleTimeString('sl-SI',{hour:'2-digit',minute:'2-digit'});
  const dmy=ts=>new Date(ts).toLocaleDateString('sl-SI');
  const projectName=id=>(projects.find(p=>p.id===id)?.name)||'';

  ["clockIn","clockOut","breakStart","breakEnd"].forEach(id=>{
    const btn=document.getElementById(id);
    if(btn){ btn.addEventListener('click',()=>{ const map={clockIn:'prihod',clockOut:'odhod',breakStart:'malica-začetek',breakEnd:'malica-konec'}; addTime(map[id]); }); }
  });
  function addTime(type){
    if(!me) return alert("Najprej se prijavi.");
    const pid=document.getElementById('currentProject').value||null;
    const emp=resolvedName(me.email);
    store.timeEntries.push({id:crypto.randomUUID(),employee:emp,email:me.email,projectId:pid,type,ts:Date.now()});
    saveLocal();
  }
  function deleteTimeEntry(id){
    if(!confirm("Odstranim vnos?")) return;
    const idx = store.timeEntries.findIndex(e => e.id===id && e.email===me.email);
    if (idx>=0){ store.timeEntries.splice(idx,1); saveLocal(); }
  }
  function renderTimeEntries(){
    const ul=document.getElementById('todayEntries');
    const today=new Date(); const start=new Date(today.getFullYear(),today.getMonth(),today.getDate()).getTime(); const end=start+86400000;
    const entries=store.timeEntries.filter(e=>e.ts>=start && e.ts<end).sort((a,b)=>a.ts-b.ts);
    if(!entries.length){ ul.innerHTML='<li class="text-center py-4" style="color:var(--muted)"><i class="far fa-clock text-2xl mb-2"></i><p>Ni vnosov za danes.</p></li>'; return; }
    ul.innerHTML=entries.map(e=>`
      <li class="entry-item p-3 rounded-lg flex items-center justify-between" style="border:1px solid var(--border);">
        <div class="flex items-center"><i class="far fa-clock mr-2"></i>
          <div>
            <div class="font-medium">${e.type} ob ${fmt(e.ts)}</div>
            <div class="text-xs" style="color:var(--muted)">${e.employee} • ${projectName(e.projectId)||"Brez projekta"}</div>
          </div>
        </div>
        ${e.email===me?.email ? `<button class="entry-delete btn btn-outline !py-1 !px-2 text-xs" onclick="deleteTimeEntry('${e.id}')"><i class="fas fa-trash"></i></button>` : ``}
      </li>`).join('');
  }

  document.getElementById("addLog")?.addEventListener("click", async ()=>{
    if (!me) return alert("Najprej se prijavi.");
    const pid = document.getElementById("logProject").value;
    const activity = document.getElementById("logActivity").value.trim();
    const hours = parseFloat(document.getElementById("logHours").value || "0");
    if (!pid || !activity || !hours) return alert("Izpolni: projekt, aktivnost, ure.");
    const mats = (materials || []).filter(m => (m.name && m.name.trim()) || parseFloat(m.qty || "0") > 0);

    for (const m of mats) { try { await ensureMaterialOnServer(m.name, m.uom || "kos"); } catch(e){} }

    store.jobLogs.push({ id: crypto.randomUUID(), projectId: pid, activity, hours, employee: resolvedName(me.email), email: me.email, materials: mats, ts: Date.now() });
    document.getElementById("logActivity").value = ""; document.getElementById("logHours").value = "";
    materials = []; renderMaterials(); saveLocal();
  });

  function renderJobLogs(){
    const wrap=document.getElementById('logList');
    if(!store.jobLogs.length){ wrap.innerHTML='<div class="text-center py-4" style="color:var(--muted)"><i class="fas fa-tasks text-2xl mb-2"></i><p>Ni shranjenih vnosov.</p></div>'; return; }
    wrap.innerHTML=store.jobLogs.slice().reverse().map(j=>`
      <div class="entry-item p-3 rounded-lg" style="border:1px solid var(--border);">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="font-medium"><i class="fas fa-folder text-yellow-500 mr-2"></i>${projectName(j.projectId)}</div>
            <div class="mt-1 text-sm">${j.activity} • ${j.employee} • ${j.hours} h</div>
            ${j.materials?.length ? `<div class="mt-2 text-xs" style="color:var(--muted)">Materiali: ${j.materials.map(m=>`${m.name} (${m.qty||0} ${m.uom||''})`).join(', ')}</div>`:''}
          </div>
          <div class="text-xs" style="color:var(--muted)">${dmy(j.ts)}</div>
        </div>
      </div>`).join('');
  }

  /* ===== Poročila: podatki + filtri + rendering ===== */

  function buildPresenceRows(){
    const rows = [];
    const grouped = {};
    for (const e of store.timeEntries.slice().sort((a,b)=>a.ts-b.ts)) {
      const dateKey = new Date(e.ts); dateKey.setHours(0,0,0,0);
      const key = `${dateKey.getTime()}|${e.email}|${e.projectId||''}`;
      (grouped[key] ||= []).push(e);
    }
    for (const key of Object.keys(grouped)) {
      const list = grouped[key];
      let workStart=null, breakStart=null, breakMs=0, totalMs=0;
      for (const ev of list) {
        if (ev.type==='prihod') { workStart = ev.ts; breakStart=null; breakMs=0; }
        else if (ev.type==='malica-začetek' && workStart && !breakStart){ breakStart = ev.ts; }
        else if (ev.type==='malica-konec' && breakStart){ breakMs += (ev.ts - breakStart); breakStart=null; }
        else if (ev.type==='odhod' && workStart){
          totalMs += Math.max(0, (ev.ts - workStart) - breakMs);
          workStart=null; breakStart=null; breakMs=0;
        }
      }
      const [dayTs,email,proj] = key.split('|');
      const date = new Date(parseInt(dayTs,10));
      const emp  = resolvedName(email);
      const hours = +(totalMs/36e5).toFixed(2);
      if (hours>0) rows.push({ date, dateStr: date.toLocaleDateString('sl-SI'), projectId: proj, project: projectName(proj), employeeEmail: email, employee: emp, hours });
    }
    return rows;
  }
  function buildJobLogRows(){
    return store.jobLogs.map(j=>({
      date: new Date(j.ts),
      dateStr: dmy(j.ts),
      projectId: j.projectId,
      project: projectName(j.projectId),
      employeeEmail: j.email,
      employee: j.employee,
      activity: j.activity,
      hours: +(+j.hours||0).toFixed(2)
    }));
  }
  function summarize(rows, by){
    const map = {};
    rows.forEach(r=>{
      const key = r[by] || '—';
      map[key] = (map[key]||0) + Number(r.hours||0);
    });
    return Object.entries(map)
      .map(([k,v])=>({ key:k, hours:+v.toFixed(2) }))
      .sort((a,b)=>b.hours-a.hours);
  }

  function prepareReportFilters(){
    // predizpolni datumski razpon na tekoči mesec
    const from = document.getElementById('repFrom');
    const to   = document.getElementById('repTo');
    const now=new Date(); const fm=new Date(now.getFullYear(), now.getMonth(), 1); const tm=new Date(now.getFullYear(), now.getMonth()+1, 0);
    from.value = fm.toISOString().slice(0,10);
    to.value   = tm.toISOString().slice(0,10);
    renderEmployeesFilter();
    document.getElementById('repRefresh')?.addEventListener('click', renderReports);
  }

  function getReportFilters(){
    const from = new Date(document.getElementById('repFrom').value || '1970-01-01'); from.setHours(0,0,0,0);
    const to   = new Date(document.getElementById('repTo').value || '2999-12-31');  to.setHours(23,59,59,999);
    const proj = document.getElementById('repProject').value || '';
    const emp  = document.getElementById('repEmployee').value || '';
    return { from, to, proj, emp };
  }

  function applyFilters(rows, {from,to,proj,emp}){
    return rows.filter(r =>
      r.date >= from && r.date <= to &&
      (!proj || r.projectId===proj) &&
      (!emp  || r.employeeEmail===emp)
    );
  }

  function renderKpi(list, mountId, labelKey){
    const ul=document.getElementById(mountId); if(!ul) return;
    if(!list.length){ ul.innerHTML='<li><span>—</span><span>0</span></li>'; return; }
    ul.innerHTML=list.map(i=>`<li><span>${i.key||'—'}</span><span>${i.hours}</span></li>`).join('');
  }

  function renderTable(rows, mountId, cols){
    const tb = document.getElementById(mountId); if(!tb) return;
    tb.innerHTML = rows.map(r=>`<tr>${
      cols.map(c=>`<td>${c(r)}</td>`).join('')
    }</tr>`).join('') || `<tr><td colspan="5" style="color:var(--muted);text-align:center">Ni podatkov.</td></tr>`;
  }

  function renderReports(){
    const filters = getReportFilters();

    const presence = applyFilters(buildPresenceRows(), filters);
    const logs     = applyFilters(buildJobLogRows(), filters);

    // KPI
    renderKpi(summarize(presence, 'project'), 'kpiPresenceProj');
    renderKpi(summarize(presence, 'employee'), 'kpiPresenceEmp');
    renderKpi(summarize(logs, 'project'), 'kpiJobsProj');
    renderKpi(summarize(logs, 'employee'), 'kpiJobsEmp');

    // Tabele
    renderTable(presence, 'tblPresence', [
      r=>r.dateStr, r=>r.project||'—', r=>r.employee, r=>r.hours
    ]);
    renderTable(logs, 'tblJobs', [
      r=>r.dateStr, r=>r.project||'—', r=>r.employee, r=>r.activity||'—', r=>r.hours
    ]);

    // shranimo zadnje filtrirane za export
    window.__filteredPresence = presence;
    window.__filteredLogs = logs;
  }

  /* ===== EXCEL ===== */
  document.getElementById('exportExcel')?.addEventListener('click', ()=>{
    const presence = window.__filteredPresence || buildPresenceRows();
    const logs = window.__filteredLogs || buildJobLogRows();

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(presence.map(p=>({Datum:p.dateStr, Projekt:p.project, Zaposleni:p.employee, Ure:p.hours}))), 'Prisotnost');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summarize(presence,'project').map(x=>({Projekt:x.key, Ure:x.hours}))), 'Sum proj (prisot)');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summarize(presence,'employee').map(x=>({Zaposleni:x.key, Ure:x.hours}))), 'Sum zap (prisot)');

    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(logs.map(l=>({Datum:l.dateStr, Projekt:l.project, Zaposleni:l.employee, Aktivnost:l.activity, Ure:l.hours}))), 'Dnevnik del');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summarize(logs,'project').map(x=>({Projekt:x.key, Ure:x.hours}))), 'Sum proj (dnevnik)');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summarize(logs,'employee').map(x=>({Zaposleni:x.key, Ure:x.hours}))), 'Sum zap (dnevnik)');

    XLSX.writeFile(wb, 'porocilo_housetech.xlsx');
  });

  /* ===== PDF ===== */
  document.getElementById('exportPdf')?.addEventListener('click', ()=>{
    const presence = window.__filteredPresence || buildPresenceRows();
    const logs = window.__filteredLogs || buildJobLogRows();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });

    doc.setFontSize(16);
    doc.text('HOUSETECH — Poročilo', 40, 40);
    doc.setFontSize(10);
    doc.text(`Datum: ${new Date().toLocaleString('sl-SI')}`, 40, 58);

    doc.setFontSize(12);
    doc.text('Prisotnost — povzetek po projektih', 40, 84);
    doc.autoTable({ startY:92, styles:{fontSize:9}, head:[['Projekt','Ure']], body:summarize(presence,'project').map(r=>[r.key,r.hours]) });

    doc.text('Prisotnost — povzetek po zaposlenih', 40, doc.lastAutoTable.finalY + 24);
    doc.autoTable({ startY: doc.lastAutoTable.finalY + 32, styles:{fontSize:9}, head:[['Zaposleni','Ure']], body:summarize(presence,'employee').map(r=>[r.key,r.hours]) });

    doc.text('Dnevnik del (vrstice)', 40, doc.lastAutoTable.finalY + 24);
    doc.autoTable({ startY: doc.lastAutoTable.finalY + 32, styles:{fontSize:8}, head:[['Datum','Projekt','Zaposleni','Aktivnost','Ure']], body: logs.map(r=>[r.dateStr,r.project,r.employee,r.activity||'',r.hours]) });

    doc.save('porocilo_housetech.pdf');
  });

  /* ===== Export / wipe ===== */
  document.getElementById('exportData')?.addEventListener('click',()=>{
    const payload={user:me,usersDir,projects,data:store};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='export.json'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('wipeData')?.addEventListener('click',()=>{ if(confirm("Res želiš izbrisati lokalne podatke?")){ localStorage.clear(); location.reload(); }});
</script>
</body>
</html>
